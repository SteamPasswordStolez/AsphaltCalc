<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>일일 크레딧 계산기 — v18 (Per-Map Minutes, Ad Mult Dist, Packs)</title>
<meta name="color-scheme" content="light dark" />

<link rel="stylesheet" href="../assets/themes.css">
<link rel="stylesheet" href="../assets/theme-adapter.css">

<style>
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0; overflow-x:hidden;}

  /* === Layout === */
  .container{max-width:1180px;margin:32px auto;padding:0 24px;display:grid;grid-template-columns:1.5fr 1fr;gap:20px}
  @media (max-width: 900px){ .container{grid-template-columns:1fr;gap:16px;padding:0 16px;margin:24px auto} }

  .panel{border-radius:18px;padding:20px 24px}
  .title{margin:0 0 10px;font-weight:900;letter-spacing:.02em;font-size:22px}
  .subtitle{margin:0;font-weight:800;font-size:16px}

  .card{background:radial-gradient(800px 240px at 50% -140px,rgba(255,255,255,.12),transparent 60%);border:1px solid var(--border);box-shadow:0 18px 60px rgba(0,0,0,.45)}
  .input-panel{background:radial-gradient(1200px 280px at 20% -200px,rgba(0,196,255,.24),transparent 60%),radial-gradient(800px 220px at 100% -160px,rgba(255,255,255,.18),transparent 70%),linear-gradient(145deg,rgba(5,10,20,.96),rgba(10,16,26,.98))}
  .result-panel{background:radial-gradient(900px 260px at 30% -200px,rgba(255,255,255,.2),transparent 60%),linear-gradient(155deg,rgba(5,8,16,.96),rgba(10,12,20,.98))}

  .badge{display:inline-flex;align-items:center;gap:6px;padding:4px 9px;border-radius:999px;font-size:11px;background:rgba(0,0,0,.45);border:1px solid rgba(255,255,255,.18)}
  .badge-dot{width:7px;height:7px;border-radius:999px;background:radial-gradient(circle at 30% 30%,#6cf, #09f)}

  .grid{display:grid;gap:14px}
  .cols-2{grid-template-columns:repeat(2,minmax(0,1fr))}
  .cols-3{grid-template-columns:repeat(3,minmax(0,1fr))}
  @media (max-width:880px){ .cols-3{grid-template-columns:repeat(2,minmax(0,1fr))} }
  @media (max-width:640px){ .cols-2,.cols-3{grid-template-columns:1fr} }

  .field label{display:block;margin-bottom:6px;font-size:13px;font-weight:600;color:var(--inkSubtle)}
  .input-wrap{display:flex;align-items:center;gap:6px;padding:6px 9px;border-radius:11px;border:1px solid var(--borderStrong);background:rgba(0,0,0,.35)}
  .input-wrap input{flex:1;min-width:0;border:none;outline:none;background:transparent;color:var(--ink);font:inherit;font-size:13px}
  .input-wrap .unit{font-size:12px;color:var(--inkMuted)}
  .hint{margin-top:4px;font-size:11px;color:var(--inkMuted)}
  .error{margin-top:8px;border-radius:10px;padding:8px 10px;font-size:12px;background:rgba(255,80,80,.08);border:1px solid rgba(255,80,80,.5);color:#ff9d9d;display:none}

  table{width:100%;border-collapse:collapse;font-size:12px}
  thead th{font-weight:600;text-align:left;padding:6px 4px;border-bottom:1px solid var(--borderStrong);color:var(--inkSubtle);white-space:nowrap}
  tbody td{padding:5px 4px;border-bottom:1px solid rgba(255,255,255,.06)}
  tbody tr:last-child td{border-bottom:none}
  tbody tr:nth-child(even){background:rgba(255,255,255,.02)}
  .table-input{width:100%;padding:4px 6px;border-radius:8px;border:1px solid rgba(255,255,255,.16);background:rgba(0,0,0,.55);color:var(--ink);font:inherit;font-size:11px}
  .table-input::placeholder{color:rgba(255,255,255,.4)}
  .table-actions{display:flex;gap:6px;margin-top:8px}
  .table-actions .button{flex:0 0 auto}

  .button{border-radius:999px;border:1px solid var(--borderStrong);background:rgba(0,0,0,.45);color:var(--ink);padding:7px 14px;font-size:13px;font-weight:600;cursor:pointer;display:inline-flex;align-items:center;gap:6px}
  .button.primary{background:linear-gradient(135deg,#19a7ff,#00e0ff);color:#020812;border-color:rgba(0,0,0,.7);box-shadow:0 0 0 1px rgba(255,255,255,.14),0 10px 30px rgba(0,0,0,.7)}
  .button.primary:hover{filter:brightness(1.05)}
  .button:hover{background:rgba(255,255,255,.06)}
  .button:disabled{opacity:.5;cursor:default}

  .value{font-size:24px;font-weight:800;margin-bottom:4px}
  .meta{font-size:12px;color:var(--inkMuted);line-height:1.5}

  .table-wrap{border-radius:12px;border:1px solid var(--border);background:rgba(0,0,0,.35);padding:8px 8px 4px;margin-top:8px}
  .table-caption{display:flex;align-items:center;justify-content:space-between;margin-bottom:6px;font-size:12px;font-weight:600;color:var(--inkSubtle)}

  .pill-badge{display:inline-flex;align-items:center;gap:4px;border-radius:999px;padding:3px 8px;font-size:11px;background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.12);color:var(--inkSubtle)}

  .danger-hint{margin-top:10px;padding:10px 12px;border-radius:12px;background:rgba(255,0,0,.08);border:1px solid #ff6b6b;color:#ff6b6b}

  /* 모바일에서 페이지 전체 가로 스크롤 방지, 테이블만 필요 시 내부 스크롤 */
  @media (max-width:860px){
    .table-wrap{overflow-x:auto}
    table{width:100%}
  }

  /* 상세 결과 & 시뮬 요약 폰트 크게 */
  #breakdown{
    font-size:14px;
    line-height:1.8;
    margin-top:4px;
  }
  #simSummary{
    font-size:14px;
    line-height:1.8;
    margin-top:6px;
  }

  /* Back button */
  #hubBackWrap{position:fixed; left:16px; top:16px; z-index:2147483647}
  .hub-btn{display:inline-flex; align-items:center; gap:6px; padding:10px 16px; border-radius:999px; font-size:13px; box-shadow:0 10px 30px rgba(0,0,0,.65); backdrop-filter:blur(14px); background:radial-gradient(650px 200px at 0 -120px, rgba(255,255,255,.45), transparent 60%), rgba(5,10,18,.96); border:1px solid rgba(255,255,255,.25)}
  .hub-btn svg{width:16px;height:16px}
</style>
</head>
<body>
<div class="container">
  <!-- Left: Inputs (60%) -->
  <section class="card panel input-panel">
    <div style="display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap">
      <div>
        <h1 class="title">일일 크레딧 계산기</h1>
        <div class="meta">맵별 플레이 시간 + 광고 배수 분포 + 팩 드롭 분포를 기반으로 일일 크레딧을 추정합니다.</div>
      </div>
      <div class="badge">
        <span class="badge-dot"></span>
        <span>v18 · Per-Map Minutes + Ad Mult Dist + Packs</span>
      </div>
    </div>

    <div class="grid cols-3" style="margin-top:18px">
      <div class="field">
        <label for="playMinutes">하루 플레이 시간</label>
        <div class="input-wrap">
          <input id="playMinutes" type="number" min="0" step="1" value="120" aria-label="하루 플레이 시간" />
          <span class="unit">분</span>
        </div>
        <div class="hint">모든 맵의 시간 합계와 정확히 일치해야 합니다.</div>
      </div>
      <div class="field">
        <label for="bonusPercent">보너스 계수</label>
        <div class="input-wrap">
          <input id="bonusPercent" type="number" min="0" step="1" value="0" aria-label="보너스 퍼센트" />
          <span class="unit">%</span>
        </div>
        <div class="hint">패스/클럽/이벤트 보너스 합계(예: 15)</div>
      </div>
      <div class="field">
        <label for="simRuns">시뮬레이션 횟수</label>
        <div class="input-wrap">
          <input id="simRuns" type="number" min="1" max="90000" step="1" value="1000" aria-label="시뮬레이션 횟수" />
          <span class="unit">회</span>
        </div>
        <div class="hint">최대 90,000회까지 시뮬레이션합니다.</div>
      </div>
    </div>

    <div class="grid cols-3" style="margin-top:10px">
      <div class="field">
        <label for="fixedCredit">고정 크레딧</label>
        <div class="input-wrap">
          <input id="fixedCredit" type="number" min="0" step="1" value="0" aria-label="고정 크레딧" />
          <span class="unit">크레딧</span>
        </div>
        <div class="hint">하루에 항상 받는 고정 크레딧(예: 미션, 일일 로그인 등)</div>
      </div>
      <div class="field" style="display:flex;flex-direction:column;justify-content:flex-end">
        <label for="creditHeist" style="display:flex;align-items:center;gap:6px;margin-bottom:4px">
          <input id="creditHeist" type="checkbox" />
          <span>크레딧 하이스트</span>
        </label>
        <div class="hint">체크 시 고정 크레딧에 +495,000 크레딧을 추가합니다.</div>
      </div>
      <div class="field">
        <label for="lobbySeconds">로비 체류 시간</label>
        <div class="input-wrap">
          <input id="lobbySeconds" type="number" min="0" step="1" value="0" aria-label="로비 체류 시간" />
          <span class="unit">초/판</span>
        </div>
        <div class="hint">각 맵 한 판마다 공통으로 더해지는 로비/매칭 시간입니다.</div>
      </div>
    </div>

    <!-- Map table -->
    <div class="table-wrap" style="margin-top:18px">
      <div class="table-caption">
        <span>맵 구성</span>
        <span class="pill-badge">각 맵의 <b>한 판당 시간(초)</b>과 <b>분배할 시간(분)</b>을 입력하세요.</span>
      </div>
      <table>
        <thead>
          <tr>
            <th style="width:24%">맵 이름</th>
            <th style="width:10%">기본 크레딧</th>
            <th style="width:14%">한 판 시간(초)</th>
            <th style="width:14%">이 맵에 쓸 시간(분)</th>
            <th style="width:14%">팩/판</th>
            <th style="width:18%">사용 팩</th>
            <th style="width:6%"></th>
          </tr>
        </thead>
        <tbody id="mapBody"></tbody>
      </table>
      <div class="table-actions">
        <button id="addMap" class="button">맵 추가</button>
        <button id="clearMaps" class="button" style="margin-left:auto">모두 삭제</button>
      </div>
      <div id="mapError" class="error"></div>
    </div>

    <!-- Packs -->
    <div class="table-wrap" style="margin-top:16px">
      <div class="table-caption">
        <span>팩 확률/크레딧 분포</span>
        <span class="pill-badge">예: <code>0:60, 5000:20, 10000:20</code></span>
      </div>
      <table>
        <thead>
          <tr>
            <th style="width:28%">팩 이름</th>
            <th>크레딧:확률% 목록</th>
            <th style="width:6%"></th>
          </tr>
        </thead>
        <tbody id="packBody"></tbody>
      </table>
      <div class="table-actions">
        <button id="addPack" class="button">팩 추가</button>
        <button id="clearPacks" class="button" style="margin-left:auto">모두 삭제</button>
      </div>
    </div>

    <!-- Ad settings -->
    <div class="grid cols-2" style="margin-top:18px">
      <div class="field">
        <label for="adSeconds">광고 시청 시간</label>
        <div class="input-wrap">
          <input id="adSeconds" type="number" min="0" step="1" value="30" aria-label="광고 시청 시간" />
          <span class="unit">초/회</span>
        </div>
        <div class="hint">광고 하나를 보는 데 걸리는 평균 시간입니다.</div>
      </div>
      <div class="field">
        <label>광고 시간 처리</label>
        <div class="input-wrap" style="justify-content:space-between">
          <span style="font-size:12px;color:var(--inkMuted)">광고 시청 시간도 플레이 시간에 포함</span>
          <label style="display:flex;align-items:center;gap:6px;font-size:12px">
            <input id="adsConsumeTime" type="checkbox" checked />
            <span>포함</span>
          </label>
        </div>
        <div class="hint">체크 시 광고를 보는 동안 맵을 돌 시간이 줄어듭니다.</div>
      </div>
    </div>

    <div class="danger-hint">
      ⚠️ 이 계산기는 <b>시뮬레이션</b>을 기반으로 한 추정치입니다. 실제 결과와는 차이가 날 수 있습니다.
    </div>

    <div class="row">
      <button id="calc" class="button primary">계산</button>
      <button id="reset" class="button">기본값 복원</button>
    </div>
  </section>

  <!-- Right: Result (40%) -->
  <section class="card panel result-panel">
    <div style="display:flex;align-items:baseline;justify-content:space-between;gap:10px;flex-wrap:wrap">
      <h3 class="subtitle">결과</h3>
      <div class="meta" id="summaryMeta" aria-live="polite"></div>
    </div>
    <div id="result" style="margin-top:8px">
      <div class="value">–</div>
      <div class="meta">입력을 채운 뒤 <b>계산</b>을 누르면 일일 총 크레딧, 판 수, 광고 수, 구성 비중과 시뮬레이션 결과를 보여줍니다.</div>
    </div>
    <hr style="margin:16px 0; border:none; border-top:1px solid var(--border)">
    <div id="breakdown" class="meta"></div>
    <hr style="margin:16px 0 10px; border:none; border-top:1px dashed var(--border)">
    <div id="simSummary" class="meta"></div>
  </section>
</div>

<script>
(function(){
  // ===== Theme sync =====
  var GKEY='simhub_theme_global';
  function resolveSystem(theme){ if(theme==='system'){ return (matchMedia && matchMedia('(prefers-color-scheme: dark)').matches) ? 'dark' : 'light'; } return theme || 'asphalt'; }
  function currentTheme(){ var attr=document.documentElement.getAttribute('data-theme'); if(attr && attr!=='system') return attr; var g = localStorage.getItem(GKEY); return g || 'asphalt'; }
  function applyTheme(t){ document.documentElement.setAttribute('data-theme', resolveSystem(t)); }
  applyTheme(currentTheme());

  // ===== DOM helpers =====
  function q(id){ return document.getElementById(id); }

  // ===== Defaults =====
  var DEFAULTS = {
    playMinutes: 120,
    bonusPercent: 0,
    adsPerDay: 10,
    adSeconds: 30,
    adsConsumeTime: true,
    lobbySeconds: 0,
    adMultDist: [
      {m:3, p:25},
      {m:4, p:25},
      {m:6, p:20},
      {m:8, p:15},
      {m:12,p:10},
      {m:20,p:5}
    ],
    maps: [
      {name:'맵 A', credit:5000, lap:60, minutes:40, packsPerRun:3, packName:'팩 A'},
      {name:'맵 B', credit:4500, lap:75, minutes:40, packsPerRun:3, packName:'팩 B'},
      {name:'맵 C', credit:4000, lap:90, minutes:40, packsPerRun:3, packName:'팩 C'}
    ],
    packs: [
      {name:'팩 A', dist:'0:60, 5000:20, 10000:20'},
      {name:'팩 B', dist:'0:50, 4000:30, 8000:20'},
      {name:'팩 C', dist:'0:40, 3000:40, 9000:20'}
    ]
  };

  // ===== Map & Pack table helpers =====
  var mapBody = q('mapBody');
  var packBody = q('packBody');

  function packNames(){
    var names=['없음'];
    if(!packBody) return names;
    var rows = packBody.querySelectorAll('tr');
    rows.forEach(function(tr){
      var n = tr.querySelector('input[data-k="name"]');
      var v = (n && n.value.trim()) || '';
      if(v && names.indexOf(v)===-1) names.push(v);
    });
    return names;
  }

  function refreshPackSelects(){
    var options = packNames().map(function(n){ return '<option value="'+n+'">'+n+'</option>'; }).join('');
    mapBody.querySelectorAll('select[data-k="packName"]').forEach(function(sel){
      var cur = sel.value;
      sel.innerHTML = options;
      if(cur) sel.value = cur;
    });
  }

  function readMaps(){
    var rows = mapBody.querySelectorAll('tr');
    var arr=[];
    rows.forEach(function(tr){
      arr.push({
        name: tr.querySelector('input[data-k="name"]').value.trim(),
        credit: parseFloat(tr.querySelector('input[data-k="credit"]').value)||0,
        lap: parseFloat(tr.querySelector('input[data-k="lap"]').value)||0,
        minutes: parseFloat(tr.querySelector('input[data-k="minutes"]').value)||0,
        packsPerRun: parseFloat(tr.querySelector('input[data-k="packsPerRun"]').value)||0,
        packName: tr.querySelector('select[data-k="packName"]').value
      });
    });
    return arr;
  }

  function readPacks(){
    var rows = packBody.querySelectorAll('tr');
    return Array.prototype.map.call(rows, function(tr){
      return {
        name: tr.querySelector('input[data-k="name"]').value.trim() || '없음',
        dist: tr.querySelector('input[data-k="dist"]').value.trim() || '0:100'
      };
    });
  }

  function parsePackEV(distStr){
    var sumP=0, ev=0;
    distStr.split(',').forEach(function(piece){
      var t=piece.trim(); if(!t) return; var kv=t.split(':');
      var val=parseFloat(kv[0]); var prob=parseFloat(kv[1]);
      if(isFinite(val)&&isFinite(prob)){ sumP+=prob; ev+=val*prob; }
    });
    if(sumP>0){ ev=ev/sumP; }
    return {ev:ev, sumP:sumP};
  }

  function buildPackDist(distStr){
    var parts=[];
    var sumP=0;
    (distStr||'').split(',').forEach(function(piece){
      var t=piece.trim(); if(!t) return;
      var kv=t.split(':');
      var val=parseFloat(kv[0]); var prob=parseFloat(kv[1]);
      if(isFinite(val) && isFinite(prob) && prob>0){
        sumP += prob;
        parts.push({v:val, p:prob});
      }
    });
    if(!parts.length || !sumP){
      return {list:[{v:0, c:1}]};
    }
    var cum=0;
    var list=parts.map(function(o){
      cum += o.p / sumP;
      return {v:o.v, c:cum};
    });
    list[list.length-1].c = 1;
    return {list:list};
  }

  function sampleFromDist(dist){
    if(!dist || !dist.list || !dist.list.length) return 0;
    var r=Math.random();
    for(var i=0;i<dist.list.length;i++){
      if(r <= dist.list[i].c) return dist.list[i].v;
    }
    return dist.list[dist.list.length-1].v;
  }

  function addMapRow(data){
    var d = Object.assign({name:'', credit:0, lap:60, minutes:0, packsPerRun:0, packName:'없음'}, data||{});
    var tr = document.createElement('tr');
    var options = packNames().map(function(n){ return '<option value="'+n+'"'+(n===d.packName?' selected':'')+'>'+n+'</option>'; }).join('');
    tr.innerHTML = ''
      + '<td><input class="table-input" data-k="name" placeholder="맵 이름" value="'+(d.name||'')+'"></td>'
      + '<td><input class="table-input" data-k="credit" type="number" value="'+d.credit+'"></td>'
      + '<td><input class="table-input" data-k="lap" type="number" value="'+d.lap+'"></td>'
      + '<td><input class="table-input" data-k="minutes" type="number" value="'+d.minutes+'"></td>'
      + '<td><input class="table-input" data-k="packsPerRun" type="number" value="'+(d.packsPerRun||0)+'"></td>'
      + '<td><select class="table-input" data-k="packName">'+options+'</select></td>'
      + '<td><button class="button" data-action="del" title="삭제">×</button></td>';
    mapBody.appendChild(tr);
  }

  function clearMapRows(){ mapBody.innerHTML=''; }

  function addPackRow(data){
    var d = Object.assign({name:'', dist:'0:100'}, data||{});
    var tr = document.createElement('tr');
    tr.innerHTML = ''
      + '<td><input class="table-input" data-k="name" placeholder="팩 이름" value="'+(d.name||'')+'"></td>'
      + '<td><input class="table-input" data-k="dist" placeholder="예: 0:60, 5000:20, 10000:20" value="'+(d.dist||'')+'"></td>'
      + '<td><button class="button" data-action="del-pack" title="삭제">×</button></td>';
    packBody.appendChild(tr);
  }

  function clearPackRows(){ packBody.innerHTML=''; }

  function seedDefaults(){
    clearMapRows();
    clearPackRows();
    DEFAULTS.packs.forEach(function(p){ addPackRow(p); });
    DEFAULTS.maps.forEach(function(m){ addMapRow(m); });
    refreshPackSelects();
  }

  // Seed
  seedDefaults();

  // Toolbar events
  var addBtn=document.getElementById('addMap'); 
  if(addBtn){ 
    addBtn.addEventListener('click', function(){ 
      addMapRow({name:'새 맵'}); 
    }); 
  }

  var clearBtn=document.getElementById('clearMaps'); 
  if(clearBtn){ 
    clearBtn.addEventListener('click', function(){ 
      clearMapRows(); 
    }); 
  }

  mapBody.addEventListener('click', function(e){
    var t=e.target;
    if(t && t.dataset && t.dataset.action==='del'){
      var tr = t.closest('tr');
      if(tr) tr.remove();
    }
  });

  var addPackBtn=document.getElementById('addPack'); 
  if(addPackBtn){ 
    addPackBtn.addEventListener('click', function(){ 
      addPackRow({name:'새 팩', dist:'0:100'}); 
    }); 
  }

  var clearPackBtn=document.getElementById('clearPacks'); 
  if(clearPackBtn){ 
    clearPackBtn.addEventListener('click', function(){ 
      clearPackRows(); 
      refreshPackSelects(); 
    }); 
  }

  packBody.addEventListener('click', function(e){
    var t=e.target;
    if(t && t.dataset && t.dataset.action==='del-pack'){
      var tr = t.closest('tr');
      if(tr) tr.remove();
      refreshPackSelects();
    }
  });

  packBody.addEventListener('input', function(){
    refreshPackSelects();
  });

  // ===== 시뮬레이션 (히스토그램 없이 평균만 사용) =====
  function runSimulation(options){
    var simSummaryEl = q('simSummary');
    if(!simSummaryEl) return;

    try{
      var simRunsInput = q('simRuns');
      var fixedCreditInput = q('fixedCredit');
      var heistEl = q('creditHeist');

      var simCount = 0;
      if(simRunsInput){
        var raw = parseInt(simRunsInput.value, 10);
        if(!isFinite(raw) || raw <= 0) raw = 1000;
        if(raw > 90000) raw = 90000;
        if(raw < 1) raw = 1;
        simRunsInput.value = raw;
        simCount = raw;
      }
      if(!simCount){
        simSummaryEl.textContent = '시뮬레이션 결과 없음 (시뮬레이션 횟수를 1 이상으로 설정하세요).';
        var rb0 = q('result');
        if(rb0){
          var v0 = rb0.querySelector('.value');
          var m0 = rb0.querySelector('.meta');
          if(v0) v0.textContent = '–';
          if(m0) m0.textContent = '시뮬레이션을 실행하려면 계산 버튼을 누르세요.';
        }
        return;
      }

      var fixedBase = 0;
      if(fixedCreditInput){
        var fc = parseFloat(fixedCreditInput.value);
        if(!isFinite(fc)) fc = 0;
        if(fc < 0) fc = 0;
        fixedCreditInput.value = fc;
        fixedBase = fc;
      }
      var heistChecked = !!(heistEl && heistEl.checked);
      var fixedTotal = fixedBase + (heistChecked ? 495000 : 0);

      var n = simCount;
      var results = new Array(n);

      var adsUsed = options && options.adsUsed || 0;
      var baseRunsCredit = options && options.creditFromRuns || 0;
      var runMultiplier = options && options.runMultiplier || 1;
      var expBasePerRun = options && options.expBasePerRun || 0;
      var packDraws = options && options.packDraws || {};
      var packDistMap = options && options.packDistMap || {};
      var totalRuns = options && options.runsTotal || 0;
      var totalPacks = options && options.totalPacksOpened || 0;

      // 광고 배수 분포 누적
      var adList = [];
      var acc = 0;
      var amd = DEFAULTS.adMultDist || [];
      for(var ia=0; ia<amd.length; ia++){
        var o = amd[ia];
        var p = o.p || 0;
        if(!isFinite(p) || p <= 0) continue;
        acc += p / 100;
        adList.push({m:o.m, c:acc});
      }
      if(adList.length){
        adList[adList.length-1].c = 1;
      }

      function drawAdMult(){
        if(!adList.length) return 1;
        var r=Math.random();
        for(var i2=0;i2<adList.length;i2++){
          if(r <= adList[i2].c) return adList[i2].m;
        }
        return adList[adList.length-1].m || 1;
      }

      // 팩 이름 목록
      var packKeys = [];
      for(var key in packDraws){
        if(Object.prototype.hasOwnProperty.call(packDraws, key)){
          packKeys.push(key);
        }
      }

      for(var s=0;s<n;s++){
        var total = baseRunsCredit + fixedTotal;
        var packCredit = 0;

        for(var pi=0; pi<packKeys.length; pi++){
          var name = packKeys[pi];
          var draws = packDraws[name] || 0;
          var dist = packDistMap[name];
          if(!dist || !draws) continue;
          for(var d=0; d<draws; d++){
            packCredit += sampleFromDist(dist);
          }
        }

        var adCredit = 0;
        if(adsUsed > 0 && adList.length){
          for(var k=0;k<adsUsed;k++){
            var m = drawAdMult();
            var delta = (m-1) * expBasePerRun * runMultiplier;
            adCredit += delta;
          }
        }

        total += Math.floor(packCredit) + Math.floor(adCredit);
        if(!isFinite(total)) total = 0;
        if(total < 0) total = 0;
        results[s] = Math.round(total);
      }

      // 통계 계산
      var sum = 0, sumSq = 0;
      for(var j=0;j<n;j++){
        var v = results[j];
        if(!isFinite(v)) continue;
        sum += v;
        sumSq += v*v;
      }
      var effN = n;
      if(sum === 0 && sumSq === 0){ effN = 1; }
      var avg = sum / effN;
      var variance = sumSq / effN - avg*avg;
      if(!isFinite(variance) || variance < 0) variance = 0;
      var sd = Math.sqrt(variance);

      var sorted = results.slice().sort(function(a,b){return a-b;});
      var q05 = sorted[Math.floor(0.05*(sorted.length-1))];
      var q95 = sorted[Math.floor(0.95*(sorted.length-1))];

      // 시뮬레이션 요약 (글자 크게 + 재배치)
      simSummaryEl.innerHTML =
        '<div style="font-size:16px;font-weight:700;margin-bottom:6px;">시뮬레이션 요약</div>'+
        '<div style="font-size:14px;line-height:1.9;">'
        + '시행 <b>'+ n.toLocaleString() +'회</b><br>'
        + '평균 <b>'+ Math.round(avg).toLocaleString() +' 크레딧/일</b> (시뮬레이션 평균)<br>'
        + '표준편차 '+ Math.round(sd).toLocaleString() +' 크레딧<br>'
        + '5% 구간 '+ q05.toLocaleString() +' 크레딧 · 95% 구간 '+ q95.toLocaleString() +' 크레딧<br>'
        + '총 판 수 '+ (totalRuns||0).toLocaleString() +'회 · 개봉 팩 '+ (totalPacks||0).toLocaleString() +'개 · 광고 '+ (adsUsed||0).toLocaleString() +'회'
        + '</div>';

      var resultBox = q('result');
      if(resultBox){
        var vMain = resultBox.querySelector('.value');
        var metaMain = resultBox.querySelector('.meta');
        if(vMain) vMain.textContent = Math.round(avg).toLocaleString() + ' 크레딧/일';
        if(metaMain) metaMain.textContent = '시뮬레이션 평균 기준 · 시행 '+ n.toLocaleString() +'회';
      }

    }catch(e){
      simSummaryEl.textContent = '시뮬레이션 중 오류가 발생했습니다.';
    }
  }

  // ===== Reset =====
  var resetBtn=q('reset');
  if(resetBtn){
    resetBtn.addEventListener('click', function(){
      q('playMinutes').value=DEFAULTS.playMinutes;
      q('bonusPercent').value=DEFAULTS.bonusPercent;
      q('adsPerDay').value=DEFAULTS.adsPerDay;
      seedDefaults();
      q('adSeconds').value=DEFAULTS.adSeconds; 
      q('adsConsumeTime').checked=DEFAULTS.adsConsumeTime;
      q('lobbySeconds').value=DEFAULTS.lobbySeconds;

      var simRunsEl=q('simRuns'); if(simRunsEl) simRunsEl.value=1000;
      var fixedEl=q('fixedCredit'); if(fixedEl) fixedEl.value=0;
      var heistEl=q('creditHeist'); if(heistEl) heistEl.checked=false;

      var v=q('result').querySelector('.value'); if(v) v.textContent='–';
      var m=q('result').querySelector('.meta'); if(m) m.textContent='기본값 복원됨';
      var sm=q('summaryMeta'); if(sm) sm.textContent='';
      var bd=document.getElementById('breakdown'); if(bd) bd.textContent='';
      var sim=q('simSummary'); if(sim) sim.textContent='';
      var err=document.getElementById('mapError'); if(err){ err.style.display='none'; err.textContent=''; }
    });
  }

  // ===== Calculate =====
  var calc=q('calc');
  if(calc){
    calc.addEventListener('click', function(){
      function num(id, def){ var el=q(id); var n=parseFloat(el && el.value); return isFinite(n)? n: def; }

      var minutesTotal = num('playMinutes', 0);
      var bonusPercent = Math.max(0, num('bonusPercent', 0));
      var adsCap = Math.max(0, num('adsPerDay', 0));
      var lobbySeconds = Math.max(0, num('lobbySeconds', 0));
      var maps = readMaps();
      var packs = readPacks();

      var sumMinutes = maps.reduce(function(a,m){ return a + (m.minutes||0); }, 0);
      var err=document.getElementById('mapError');
      if(Math.abs(sumMinutes - minutesTotal) > 0.0001){
        if(err){ err.style.display='block'; err.textContent='맵들의 "이 맵에 쓸 시간(분)" 합('+sumMinutes.toFixed(2)+'분) 이 하루 플레이 시간('+minutesTotal+
          '분)과 일치하지 않습니다.'; }
        return;
      } else {
        if(err){ err.style.display='none'; err.textContent=''; }
      }

      var totalSeconds = minutesTotal * 60;
      var adSeconds = Math.max(0, num('adSeconds', 0));
      var adsConsumeTime = !!(q('adsConsumeTime') && q('adsConsumeTime').checked);

      var adsUsed = adsCap;
      var remainingSeconds = totalSeconds;
      if(adsConsumeTime && adSeconds>0){
        var timeForAds = adsCap * adSeconds;
        if(timeForAds > remainingSeconds){
          adsUsed = Math.floor(remainingSeconds / adSeconds);
          timeForAds = adsUsed * adSeconds;
        }
        remainingSeconds -= timeForAds;
      }

      if(!adsConsumeTime){
        remainingSeconds = totalSeconds;
      }

      var runsTotal=0, creditFromRuns=0, creditFromPacks=0;
      var runMultiplier = 1 + (bonusPercent/100);

      var packMap = {};
      var packDistMap = {};
      packs.forEach(function(pk){
        var parsed = parsePackEV(pk.dist);
        packMap[pk.name] = parsed;
        packDistMap[pk.name] = buildPackDist(pk.dist);
      });

      var packDraws = {};
      var totalPacksOpened = 0;

      maps.forEach(function(m){
        var frac = minutesTotal>0 ? (m.minutes/minutesTotal) : 0;
        var secAvail = Math.floor(remainingSeconds * frac);
        var perRun = (m.lap + lobbySeconds);
        var runs = perRun>0 ? Math.floor(secAvail / perRun) : 0;
        runsTotal += runs;

        var base = Math.max(0, m.credit);
        creditFromRuns += Math.floor(runs * base * runMultiplier);

        var pp = Math.max(0, m.packsPerRun||0);
        if(pp>0){
          var ev = 0;
          if (packMap[m.packName] && typeof packMap[m.packName].ev === 'number') {
            ev = packMap[m.packName].ev;
          }
          creditFromPacks += Math.floor(runs * pp * ev);

          var draws = Math.round(runs * pp);
          if(draws>0 && isFinite(draws)){
            var key = m.packName || '없음';
            packDraws[key] = (packDraws[key]||0) + draws;
            totalPacksOpened += draws;
          }
        }
      });

      var eminus1 = (DEFAULTS.adMultDist||[]).reduce(function(a,o){ return a + ( (o.m-1) * (o.p||0)/100 ); }, 0);
      var expBasePerRun = runsTotal>0 ? (creditFromRuns/runMultiplier)/runsTotal : 0;
      var creditFromAds = Math.floor(adsUsed * eminus1 * expBasePerRun * runMultiplier);

      var totalCredit = creditFromRuns + creditFromAds + creditFromPacks;

      var vEl=q('result').querySelector('.value');
      var meta=q('result').querySelector('.meta');
      if(vEl) vEl.textContent = '시뮬레이션 실행 중...';
      if(meta) meta.textContent = '현재 입력값으로 시뮬레이션 평균 크레딧을 계산하는 중입니다.';

      var bd=document.getElementById('breakdown');
      if(bd){
        var pctRuns = totalCredit>0 ? Math.round(creditFromRuns/totalCredit*100) : 0;
        var pctAds  = totalCredit>0 ? Math.round(creditFromAds/totalCredit*100) : 0;
        var pctPacks= totalCredit>0 ? (100 - pctRuns - pctAds) : 0;
        bd.innerHTML =
          '<div style="font-size:16px;font-weight:700;margin-bottom:6px;">상세 결과</div>'+
          '<div style="font-size:14px;line-height:1.9;">'
          + '광고 배수 분포: '+ (DEFAULTS.adMultDist||[]).map(function(o){return o.m+'배 '+o.p+'%';}).join(', ') + '<br>'
          + '광고 배수 평균 (m−1 기준): '+eminus1.toFixed(3)+'<br>'
          + '맵 크레딧 합계(보너스 포함): '+creditFromRuns.toLocaleString()+'<br>'
          + '광고 크레딧 합계(이론 기준): '+creditFromAds.toLocaleString()+'<br>'
          + '팩 예상 크레딧 합계(이론 기준): '+creditFromPacks.toLocaleString()+'<br>'
          + '구성 비중: 맵 '+pctRuns+'% / 광고 '+pctAds+'% / 팩 '+pctPacks+'%'
          + '</div>';
      }

      // 시뮬레이션 실행 (결과는 시뮬레이션 평균만 사용)
      runSimulation({
        adsUsed: adsUsed,
        creditFromRuns: creditFromRuns,
        runMultiplier: runMultiplier,
        expBasePerRun: expBasePerRun,
        packDraws: packDraws,
        packDistMap: packDistMap,
        runsTotal: runsTotal,
        totalPacksOpened: totalPacksOpened
      });

      var sm=q('summaryMeta'); if(sm) sm.textContent=new Date().toLocaleString();
    });
  }
})();
</script>

<!-- Hub Back Button Inject -->
<style>
  #hubBackWrap{position:fixed; left:16px; top:16px; z-index:2147483647; font-family:ui-sans-serif,system-ui,Segoe UI,Roboto,"Noto Sans KR",Arial}
  #hubBackBtn{padding:10px 14px; border-radius:999px; border:1px solid var(--border); background:var(--chip-bg); color:var(--ink); cursor:pointer; box-shadow:0 6px 20px rgba(0,0,0,.35); opacity:.9}
  #hubBackBtn:hover{opacity:1}
  @media (prefers-color-scheme: light){
    #hubBackBtn{background:var(--chip-bg); color:var(--ink)}
  }
</style>
<div id="hubBackWrap">
  <button id="hubBackBtn" title="메인 메뉴로">
    ← 메인으로
  </button>
</div>
<script>
  (function(){
    var btn = document.getElementById('hubBackBtn');
    if(!btn) return;
    btn.addEventListener('click', function(){
      // If navigated from hub, try back; otherwise go to hub index.html
      if (document.referrer && document.referrer.indexOf('index.html') !== -1) {
        history.back();
      } else {
        // assume hub is one level up
        location.href = '../index.html';
      }
    });
  })();
</script>
</body>
</html>
