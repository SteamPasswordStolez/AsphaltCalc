<!doctype html>
<html lang="ko">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>My Garage â€” ë‚´ ì°¨ê³ </title>
    <meta name="color-scheme" content="light dark" />

    <link rel="icon" href="../assets/favicon.png">
    <link rel="stylesheet" href="../assets/style.css">
    <link rel="stylesheet" href="../assets/themes.css">

    <script>window.SIM_ID = "my-garage";</script>
    <script src="../assets/theme-init.js"></script>
    <link rel="stylesheet" href="../assets/theme-adapter.css">

    <script src="../assets/lang.js?v=2"></script>
    <script src="../assets/i18n.js"></script>
    <script src="../assets/garage.js"></script>
    <script src="../assets/achievements.js"></script>
    <script src="../assets/efficiency.js"></script>
    <script src="../assets/goal_advisor.js"></script>
    <script src="../assets/history.js"></script>

    <style>
        /* ... styles ... */

        /* Goal Modal Styles */
        .goal-card {
            background: linear-gradient(135deg, var(--surface), var(--surface-soft));
            border: 1px solid var(--accent);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
            box-shadow: 0 4px 12px rgba(var(--accent-rgb), 0.1);
        }

        .goal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .goal-title {
            font-size: 16px;
            font-weight: 800;
            color: var(--accent);
        }

        .goal-tag {
            background: var(--accent);
            color: #fff;
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 4px;
            font-weight: bold;
        }

        .goal-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            font-size: 12px;
            color: var(--muted);
            margin-bottom: 12px;
        }

        .goal-reason {
            font-size: 13px;
            line-height: 1.4;
            color: var(--ink);
            background: rgba(0, 0, 0, 0.03);
            padding: 8px;
            border-radius: 8px;
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }

        .kpi-card {
            background: var(--panel);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 16px 20px;
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .kpi-label {
            font-size: 12px;
            color: var(--muted);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .kpi-value {
            font-size: 24px;
            font-weight: 800;
            color: var(--ink);
        }

        .garage-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
            gap: 16px;
        }

        .car-card {
            background: var(--panel);
            border: 1px solid var(--border);
            border-radius: 18px;
            overflow: hidden;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
            display: flex;
            flex-direction: column;
        }

        .car-card.unowned {
            opacity: 0.6;
            filter: grayscale(0.6);
            border-style: dashed;
        }

        .car-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-lg);
            border-color: var(--accent);
            opacity: 1;
            filter: grayscale(0);
            z-index: 10;
        }

        .car-card .card-header {
            padding: 16px;
            border-bottom: 1px solid var(--border);
            background: linear-gradient(to bottom, rgba(255, 255, 255, 0.02), transparent);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .car-class {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 24px;
            height: 24px;
            border-radius: 6px;
            font-size: 11px;
            font-weight: 800;
            background: var(--chip-bg);
            color: var(--ink);
            border: 1px solid var(--border);
        }

        .car-class.d {
            color: #4ade80;
            border-color: rgba(74, 222, 128, 0.3);
        }

        .car-class.c {
            color: #fbbf24;
            border-color: rgba(251, 191, 36, 0.3);
        }

        .car-class.b {
            color: #60a5fa;
            border-color: rgba(96, 165, 250, 0.3);
        }

        .car-class.a {
            color: #a78bfa;
            border-color: rgba(167, 139, 250, 0.3);
        }

        .car-class.s {
            color: #f87171;
            border-color: rgba(248, 113, 113, 0.3);
        }

        .car-card .card-body {
            padding: 16px;
            flex-grow: 1;
        }

        .car-name {
            font-size: 16px;
            font-weight: 700;
            margin-bottom: 8px;
            line-height: 1.3;
        }

        .car-specs {
            font-size: 12px;
            color: var(--muted);
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .spec-row {
            display: flex;
            justify-content: space-between;
        }

        .owned-badge {
            display: none;
            font-size: 10px;
            background: var(--accent);
            color: #000;
            padding: 2px 6px;
            border-radius: 4px;
            font-weight: 700;
        }

        .car-card.owned .owned-badge {
            display: inline-block;
        }

        /* Controls Bar */
        .controls-bar {
            display: flex;
            flex-wrap: wrap;
            gap: 16px;
            justify-content: space-between;
            align-items: center;
            background: var(--surface);
            border: 1px solid var(--border);
            padding: 12px 16px;
            border-radius: 12px;
            margin-bottom: 24px;
        }

        .filter-group {
            display: flex;
            gap: 8px;
        }

        .filter-btn {
            padding: 6px 12px;
            border-radius: 8px;
            border: 1px solid var(--border);
            background: var(--surface-soft);
            color: var(--muted);
            font-size: 13px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s;
        }

        .filter-btn:hover {
            background: var(--surface-hover);
            color: var(--ink);
        }

        .filter-btn.active {
            background: var(--accent);
            color: #fff;
            border-color: var(--accent);
        }

        .control-right {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .toggle-label {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 13px;
            color: var(--ink);
            cursor: pointer;
            user-select: none;
        }

        .sort-select {
            padding: 6px 10px;
            border-radius: 8px;
            border: 1px solid var(--border);
            background: var(--surface-soft);
            color: var(--ink);
            font-size: 13px;
        }

        /* Gold Card Styling */
        .car-card.gold-status {
            background: linear-gradient(135deg, rgba(255, 215, 0, 0.1) 0%, rgba(255, 223, 0, 0.3) 100%);
            border: 1px solid #FFD700;
            box-shadow: 0 0 15px rgba(255, 215, 0, 0.3);
            position: relative;
            overflow: hidden;
        }

        html[data-theme='dark'] .car-card.gold-status {
            background: linear-gradient(135deg, rgba(184, 134, 11, 0.2) 0%, rgba(255, 215, 0, 0.1) 100%);
            border-color: #DAA520;
        }

        .car-card.gold-status::before {
            content: "";
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(to right, transparent, rgba(255, 255, 255, 0.3), transparent);
            transform: rotate(45deg);
            animation: shine 3s infinite;
            pointer-events: none;
        }

        @keyframes shine {
            0% {
                transform: translateX(-100%) rotate(45deg);
            }

            100% {
                transform: translateX(100%) rotate(45deg);
            }
        }

        /* Achievement Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            display: none;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(5px);
        }

        .modal {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 16px;
            width: 90%;
            max-width: 650px;
            height: 85vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
            animation: modalSlide 0.3s cubic-bezier(0.16, 1, 0.3, 1);
        }

        @keyframes modalSlide {
            from {
                transform: translateY(20px);
                opacity: 0;
            }

            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .modal-header {
            padding: 20px 24px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--surface);
        }

        .modal-title {
            font-size: 20px;
            font-weight: 800;
            letter-spacing: -0.02em;
        }

        .modal-close {
            background: rgba(255, 255, 255, 0.1);
            border: none;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            font-size: 20px;
            cursor: pointer;
            color: var(--ink);
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .modal-close:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: rotate(90deg);
        }

        .modal-body {
            padding: 20px 24px;
            overflow-y: auto;
            background: var(--bg);
            /* Ensure solid background */
        }

        .ach-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 12px;
        }

        .ach-item {
            display: flex;
            align-items: flex-start;
            gap: 14px;
            padding: 16px;
            border: 1px solid var(--border-subtle);
            border-radius: 12px;
            background: var(--surface-soft);
            opacity: 0.6;
            grayscale: (1);
            transition: all 0.3s;
            position: relative;
            overflow: hidden;
        }

        /* Locked State */
        .ach-item::after {
            content: "ğŸ”’";
            position: absolute;
            top: 10px;
            right: 10px;
            opacity: 0.2;
            font-size: 14px;
        }

        .ach-item.unlocked {
            opacity: 1;
            filter: none;
            background: linear-gradient(145deg, var(--surface), var(--surface-soft));
            border-color: var(--accent);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        .ach-item.unlocked::after {
            content: "";
        }

        .ach-icon {
            font-size: 36px;
            width: 48px;
            text-align: center;
            filter: drop-shadow(0 4px 6px rgba(0, 0, 0, 0.2));
        }

        .ach-info {
            flex: 1;
        }

        .ach-name {
            font-weight: 700;
            font-size: 15px;
            margin-bottom: 4px;
            color: var(--ink);
        }

        .ach-desc {
            font-size: 12px;
            color: var(--muted);
            line-height: 1.45;
        }

        .ach-date {
            font-size: 11px;
            color: #10b981;
            margin-top: 8px;
            font-weight: 700;
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 2px 8px;
            background: rgba(16, 185, 129, 0.1);
            border-radius: 99px;
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="header">
            <div class="brand">
                <h1>ğŸ“‚ <span data-i18n="mg.title">ë§ˆì´ ì°¨ê³ </span></h1>
            </div>
            <div class="toolbar">
                <div style="display:flex; flex-direction:column; align-items:flex-end;">
                    <div style="display:flex; gap:8px;">
                        <button class="btn" style="border-color:#3b82f6; color:#3b82f6;" onclick="openGoals()">ğŸ¯
                            ëª©í‘œ</button>
                        <button class="btn" onclick="openHistory()">ğŸ“œ ë¡œê·¸</button>
                        <a class="btn" href="garage_social.html">ğŸ¤ ì†Œì…œ</a>
                        <button class="btn" onclick="openAchievements()">ğŸ† ì—…ì </button>
                        <button class="btn" onclick="backupData()">ğŸ’¾ ë°±ì—…</button>
                        <button class="btn" onclick="document.getElementById('restoreInput').click()">ğŸ“¤
                            ë³µì›</button>
                        <input type="file" id="restoreInput" style="display:none" accept=".json"
                            onchange="restoreData(this)">
                        <a class="btn" href="garage_import.html">ğŸ“¸ ê°€ì ¸ì˜¤ê¸°</a>
                        <a class="btn" href="garage_stat.html" data-i18n="gs.link">ğŸ“Š í†µê³„</a>
                        <a class="btn" href="../index.html" data-i18n="common.back">â† í—ˆë¸Œ</a>
                    </div>
                    <div style="font-size:16px; color:var(--muted); margin-top:4px;">âš ï¸ ë°ì´í„° ë³´í˜¸ë¥¼
                        ìœ„í•´ ì£¼ê¸°ì ì¸ <b>[ë°±ì—…]</b>ì„
                        ê¶Œì¥í•©ë‹ˆë‹¤.</div>
                </div>
            </div>
        </div>

        <!-- Dashboard -->
        <div class="dashboard-grid">
            <div class="kpi-card">
                <div class="kpi-label" data-i18n="mg.kpi_total">ë³´ìœ  / ì „ì²´</div>
                <div class="kpi-value"><span id="kpiOwned">0</span> <span style="opacity:0.4;font-size:0.6em;">/ <span
                            id="kpiTotal">0</span></span></div>
            </div>
            <div class="kpi-card">
                <div class="kpi-label" data-i18n="mg.kpi_progress">ìˆ˜ì§‘ë¥ </div>
                <div class="kpi-value" id="kpiProgress">0%</div>
            </div>
            <div class="kpi-card">
                <div class="kpi-label" data-i18n="mg.kpi_gold">í™©ê¸ˆ ì°¨ëŸ‰</div>
                <div class="kpi-value" id="kpiGold">0</div>
            </div>
        </div>

        <!-- Controls -->
        <div class="controls-bar">
            <div class="filter-group">
                <button class="filter-btn active" data-class="ALL">ALL</button>
                <button class="filter-btn" data-class="S">S</button>
                <button class="filter-btn" data-class="A">A</button>
                <button class="filter-btn" data-class="B">B</button>
                <button class="filter-btn" data-class="C">C</button>
                <button class="filter-btn" data-class="D">D</button>
            </div>

            <div class="control-right">
                <button id="btnManualBulkAdd" class="filter-btn" onclick="location.href='add_batch.html'"
                    style="background:var(--primary); color:white; border:none; margin-left:8px; display:inline-flex; align-items:center; gap:4px;">
                    <span>â•</span> <span style="font-weight:600;">ì°¨ëŸ‰ ì¶”ê°€</span>
                </button>
                <label class="toggle-label">
                    <input type="checkbox" id="filterOwned">
                    <span>ë‚´ ì°¨ëŸ‰ë§Œ ë³´ê¸°</span>
                </label>

                <select id="sortSelect" class="sort-select">
                    <option value="default">ê¸°ë³¸ ìˆœì„œ</option>
                    <option value="id_asc">ID ì˜¤ë¦„ì°¨ìˆœ</option>
                    <option value="id_desc">ID ë‚´ë¦¼ì°¨ìˆœ</option>
                    <option value="rank_desc">ë­í¬ ë†’ì€ìˆœ (Max)</option>
                    <option value="rank_asc">ë­í¬ ë‚®ì€ìˆœ (Max)</option>
                </select>
            </div>
        </div>

        <!-- Grid -->
        <div id="garageGrid" class="garage-grid">
            <!-- Loading State -->
            <div style="grid-column:1/-1; padding:40px; text-align:center; color:var(--muted);">
                Loading...</div>
        </div>
    </div>

    <script>
        let carMeta = []; // Array of car objects

        let state = {
            filterClass: 'ALL',
            onlyOwned: false,
            sortBy: 'default'
        };

        async function loadMeta() {
            try {
                const res = await fetch('../assets/cars.json');
                if (!res.ok) throw new Error("Failed to load cars.json");
                carMeta = await res.json();
            } catch (e) {
                console.error(e);
            }
        }

        // Backup & Restore
        function backupData() {
            const data = GarageManager.exportData();
            const blob = new Blob([data], { type: "application/json" });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `my_garage_backup_${new Date().toISOString().slice(0, 10)}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function restoreData(input) {
            const file = input.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const json = JSON.parse(e.target.result);
                    if (confirm('í˜„ì¬ ë°ì´í„°ë¥¼ ë®ì–´ì“°ê³  ë³µì›í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n(ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤!)')) {
                        GarageManager.overwrite(json);
                        renderGarage();
                        alert('ë³µì›ë˜ì—ˆìŠµë‹ˆë‹¤!');
                    }
                } catch (err) {
                    alert('íŒŒì¼ í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.');
                }
                input.value = ''; // Reset input
            };
            reader.readAsText(file);
        }

        function getMaxRankForStar(car, star) {
            if (!car || !Array.isArray(car.stat)) return 0;
            const targetStar = Number(star);
            const relevant = car.stat.filter(s => Number(s.star) === targetStar);
            if (relevant.length === 0) return 0;
            return Math.max(...relevant.map(s => Number(s.rank) || 0));
        }

        // Helper to get Absolute Max Rank of a car (for sorting)
        function getAbsoluteMaxRank(car) {
            const maxS = car.max_star || 6;
            return getMaxRankForStar(car, maxS);
        }

        function renderGarage() {
            const grid = document.getElementById('garageGrid');
            const kpiOwned = document.getElementById('kpiOwned');
            const kpiTotal = document.getElementById('kpiTotal');
            const kpiProgress = document.getElementById('kpiProgress');
            const kpiGold = document.getElementById('kpiGold');

            // 1. Get Global Data
            const ownedCars = GarageManager.getAll();
            const ownedMap = {};
            ownedCars.forEach(c => {
                ownedMap[c.id] = c;
            });

            // Calculate Global Gold Count (using new logic: Owned + Max Star + Max Rank)
            let goldCount = 0;

            // 2. Filter List
            let list = carMeta.filter(c => {
                // Class
                if (state.filterClass !== 'ALL' && c.class !== state.filterClass) return false;
                // Owned
                if (state.onlyOwned && !ownedMap[c.id]) return false;
                return true;
            });

            // 3. Sort List
            if (state.sortBy !== 'default') {
                list.sort((a, b) => {
                    if (state.sortBy === 'id_asc') return (a.id - b.id);
                    if (state.sortBy === 'id_desc') return (b.id - a.id);

                    const rA = getAbsoluteMaxRank(a);
                    const rB = getAbsoluteMaxRank(b);
                    if (state.sortBy === 'rank_asc') return rA - rB;
                    if (state.sortBy === 'rank_desc') return rB - rA;
                    return 0;
                });
            }

            grid.innerHTML = '';

            if (list.length === 0) {
                grid.innerHTML = `<div style="grid-column:1/-1; padding:40px; text-align:center; color:var(--muted);">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</div>`;
            } else {
                list.forEach(meta => {
                    const myData = ownedMap[meta.id]; // exists if owned
                    const isOwned = !!myData;
                    const star = myData ? (myData.star || 1) : 1;
                    const clsLower = (meta.class || '').toLowerCase();
                    const maxStar = meta.max_star || 6;

                    // Check Gold Status
                    // Condition: Owned AND Star == MaxStar AND Rank == MaxRankForMaxStar
                    let isGoldStatus = false;
                    if (isOwned) {
                        const currentRank = myData.rank || 0;
                        const maxPossible = getMaxRankForStar(meta, maxStar);
                        const isMaxStarReached = (star >= maxStar);
                        const isMaxRankReached = (currentRank >= maxPossible);

                        if (isMaxStarReached && isMaxRankReached) {
                            isGoldStatus = true;
                            goldCount++; // Count for Dashboard? 
                            // Wait, Dashboard usually shows Global Gold Count. 
                            // Counting inside render loop depends on filtered list...
                            // Let's recalculate Global Gold separately or accept it reflects filtered view?
                            // User probably wants global count.
                        }
                    }

                    const card = document.createElement('div');
                    card.className = `car-card ${isOwned ? 'owned' : 'unowned'} ${isGoldStatus ? 'gold-status' : ''}`;

                    // Tilt effect
                    card.addEventListener('mousemove', e => {
                        const rect = card.getBoundingClientRect();
                        const x = e.clientX - rect.left;
                        const y = e.clientY - rect.top;
                        // Simple parallax if desired
                    });

                    card.innerHTML = `
                      <div class="card-header">
                        <span class="car-class ${clsLower}">${meta.class}</span>
                        ${isOwned ? '<span class="owned-badge">OWNED</span>' : ''}
                      </div>
                      <div class="card-body">
                        <div class="car-name">${meta.name}</div>
                        <div class="car-specs">
                          <div class="spec-row">
                            <span>Star</span>
                            <span style="color:var(--accent); font-weight:${isOwned ? 'bold' : 'normal'};">
                              ${isOwned ? star : '-'} / ${maxStar}â˜…
                            </span>
                          </div>
                          <div class="spec-row">
                            <span>Rank</span>
                            <span style="${isGoldStatus ? 'color:#FFD700;font-weight:800' : ''}">
                                ${isOwned && myData.rank ? myData.rank : '-'}
                            </span>
                          </div>
                        </div>
                      </div>
                    `;

                    card.addEventListener('click', () => {
                        location.href = `garage_detail.html?id=${meta.id}`;
                    });

                    grid.appendChild(card);
                });
            }

            // Update Dashboard
            const globalOwned = ownedCars.length;
            const globalTotal = carMeta.length;
            // Recalculate Global Gold (Iterate all owned cars)
            let globalGold = 0;
            ownedCars.forEach(od => {
                const m = carMeta.find(x => String(x.id) === String(od.id));
                if (m) {
                    const maxS = m.max_star || 6;
                    const maxR = getMaxRankForStar(m, maxS);
                    if (od.star >= maxS && od.rank >= maxR) globalGold++;
                }
            });

            kpiOwned.textContent = globalOwned;
            kpiTotal.textContent = globalTotal;
            kpiProgress.textContent = globalTotal > 0 ? Math.round((globalOwned / globalTotal) * 100) + "%" : "0%";
            kpiGold.textContent = globalGold;
        }

        function setupControls() {
            // Class
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    state.filterClass = btn.dataset.class;
                    renderGarage();
                });
            });

            // Owned
            document.getElementById('filterOwned').addEventListener('change', (e) => {
                state.onlyOwned = e.target.checked;
                renderGarage();
            });

            // Sort
            document.getElementById('sortSelect').addEventListener('change', (e) => {
                state.sortBy = e.target.value;
                renderGarage();
            });
        }

        (async function () {
            await loadMeta();
            setupControls();

            // Init History
            if (window.HistoryManager) {
                HistoryManager.init();
            }

            renderGarage();

            // Take Snapshot (after renderGarage calculates totals)
            // But renderGarage doesn't return totals. Let's calc them or use DOM.
            // Actually renderGarage updates KPI DOM. Let's trust GarageManager.getAll()
            setTimeout(() => {
                const all = GarageManager.getAll();
                HistoryManager.forceSnapshot({
                    totalCars: all.length,
                    totalScore: 0, // Garage Score calc is complex, skip for now or implement later
                    totalValue: 0
                });
            }, 1000);

        })();
    </script>

    <!-- Achievement Modal -->
    <div id="achModal" class="modal-overlay" onclick="if(event.target===this) closeAchievements()">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title">ğŸ† ì—…ì  í˜„í™©</div>
                <button class="modal-close" onclick="closeAchievements()">Ã—</button>
            </div>
            <div class="modal-body" id="achList">
                <!-- JS Injected -->
            </div>
        </div>
    </div>

    <!-- Goal Modal -->
    <div id="goalModal" class="modal-overlay" onclick="if(event.target===this) closeGoals()">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title">ğŸ¯ ë‹¤ìŒ ëª©í‘œ ì¶”ì²œ</div>
                <button class="modal-close" onclick="closeGoals()">Ã—</button>
            </div>
            <div class="modal-body" id="goalList">
                <!-- JS Injected -->
            </div>
        </div>
    </div>

    <!-- History Modal -->
    <div id="historyModal" class="modal-overlay" onclick="if(event.target===this) closeHistory()">
        <div class="modal" style="width:500px">
            <div class="modal-header">
                <div class="modal-title">ğŸ“œ ì°¨ê³  ê¸°ë¡ (Recent Logs)</div>
                <button class="modal-close" onclick="closeHistory()">Ã—</button>
            </div>
            <div class="modal-body" id="historyList" style="padding:0;">
                <!-- JS Injected -->
            </div>
        </div>
    </div>

    <script>
        function openGoals() {
            // Need data ready
            if (!GoalAdvisor._cars) {
                GoalAdvisor.init(GarageManager._data).then(renderGoals);
            } else {
                renderGoals();
            }
        }

        function renderGoals() {
            GoalAdvisor._garage = GarageManager._data; // Ensure latest
            const list = GoalAdvisor.getSuggestions();
            const container = document.getElementById('goalList');
            container.innerHTML = '';

            if (list.length === 0) {
                container.innerHTML = '<div style="padding:20px; text-align:center; color:var(--muted)">ëª¨ë“  ê³ íš¨ìœ¨ ì°¨ëŸ‰ì„ íšë“í•˜ì…¨ê±°ë‚˜, ì¶”ì²œí•  ì—…ê·¸ë ˆì´ë“œê°€ ì—†ìŠµë‹ˆë‹¤! ğŸ‰</div>';
            }

            list.forEach(item => {
                const el = document.createElement('div');
                el.className = 'goal-card';
                el.innerHTML = `
                    <div class="goal-header">
                        <div class="goal-title">${item.name} <span style="font-size:0.8em; opacity:0.8;">(${item.type === 'UNLOCK' ? 'ì ê¸ˆ í•´ì œ' : 'ìŠ¤íƒ€ ì—… â­'})</span></div>
                        <div class="goal-tag" style="background:${getTierColor(item.tier)}">
                            ${item.tier} Tier / ${item.normalizedScore}ì 
                        </div>
                    </div>
                    <div class="goal-stats">
                        <div>
                            <span style="display:block; font-size:10px;">ëª©í‘œ</span>
                            <b>${item.current} â” ${item.target}</b>
                        </div>
                        <div>
                            <span style="display:block; font-size:10px;">í•„ìš” ìì› (ì˜ˆìƒ)</span>
                            <b>${item.costLabel}</b>
                        </div>
                    </div>
                    <div class="goal-reason">
                        ğŸ’¡ ${item.reason}
                    </div>
                 `;
                container.appendChild(el);
            });

            // Disclaimer
            const disclaimer = document.createElement('div');
            disclaimer.style.marginTop = '16px';
            disclaimer.style.textAlign = 'center';
            disclaimer.style.fontSize = '11px';
            disclaimer.style.color = 'var(--muted)';
            disclaimer.innerHTML = 'âš ï¸ ë³¸ ì¶”ì²œ ëª©ë¡ì€ ì•Œê³ ë¦¬ì¦˜ ë° í†µê³„ì— ê¸°ë°˜í•œ ë‹¨ìˆœ ì°¸ê³ ìš©ì´ë©°, ì ˆëŒ€ì ì¸ ì •ë‹µì´ ì•„ë‹™ë‹ˆë‹¤.<br>ì‹¤ì œ í”Œë ˆì´ ìŠ¤íƒ€ì¼ê³¼ ìƒí™©ì— ë§ì¶° ìœ ì—°í•˜ê²Œ íŒë‹¨í•˜ì‹œê¸° ë°”ëë‹ˆë‹¤.';
            container.appendChild(disclaimer);

            document.getElementById('goalModal').style.display = 'flex';
        }

        function closeGoals() {
            document.getElementById('goalModal').style.display = 'none';
        }

        function getTierColor(tier) {
            switch (tier) {
                case 'S': return '#ef4444'; // Red
                case 'A': return '#f59e0b'; // Amber
                case 'B': return '#10b981'; // Emerald
                default: return '#6b7280'; // Gray
            }
        }

        // Initialize Achievements
        (async function () {
            // Need cars data for some achievements
            await AchievementManager.init(null); // Load cars.json internally if needed
            checkAchievements();
        })();

        async function checkAchievements() {
            const cars = GarageManager.getAll();
            const newUnlocks = AchievementManager.checkAll(cars);
            if (newUnlocks.length > 0) {
                // Toast simplified
                const names = newUnlocks.map(u => u.title).join(', ');
                alert("ğŸ‰ ìƒˆë¡œìš´ ì—…ì  ë‹¬ì„±!\n" + names);
            }
        }

        function openAchievements() {
            const list = AchievementManager.getAll();
            const container = document.getElementById('achList');
            container.innerHTML = '';

            // Add simple stats summary
            const unlockedCount = list.filter(a => a.unlocked).length;
            const totalCount = list.length;
            const progress = Math.floor((unlockedCount / totalCount) * 100);

            const summary = document.createElement('div');
            summary.style.padding = '0 0 16px 0';
            summary.style.marginBottom = '16px';
            summary.style.display = 'flex';
            summary.style.justifyContent = 'space-between';
            summary.style.alignItems = 'center';

            const statsText = document.createElement('span');
            statsText.innerHTML = `ë‹¬ì„±ë¥ : <b style="color:var(--accent)">${progress}%</b> (${unlockedCount} / ${totalCount})`;
            summary.appendChild(statsText);

            const resetBtn = document.createElement('button');
            resetBtn.innerText = 'âš ï¸ ì´ˆê¸°í™”';
            resetBtn.style.background = 'none';
            resetBtn.style.border = '1px solid var(--border-subtle)';
            resetBtn.style.color = 'var(--muted)';
            resetBtn.style.fontSize = '11px';
            resetBtn.style.cursor = 'pointer';
            resetBtn.style.padding = '4px 8px';
            resetBtn.style.borderRadius = '4px';
            resetBtn.onclick = function () {
                const check = prompt("ì •ë§ë¡œ ëª¨ë“  ì—…ì  ë°ì´í„°ë¥¼ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\nì§„í–‰í•˜ë ¤ë©´ 'ì´ˆê¸°í™”' ë¼ê³  ì…ë ¥í•˜ì„¸ìš”.");
                if (check === 'ì´ˆê¸°í™”') {
                    AchievementManager.reset();
                    alert('ëª¨ë“  ì—…ì ì´ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.');
                    openAchievements(); // Refresh
                }
            };
            summary.appendChild(resetBtn);

            container.appendChild(summary);

            const grid = document.createElement('div');
            grid.className = 'ach-grid';

            list.forEach(ach => {
                const el = document.createElement('div');
                el.className = 'ach-item' + (ach.unlocked ? ' unlocked' : '');
                const diffColor = ach.diffObj ? ach.diffObj.color : '#888';
                const diffLabel = ach.diffObj ? ach.diffObj.id : '?';

                el.innerHTML = `
                    <div class="ach-info">
                        <div style="display:flex; justify-content:space-between; align-items:flex-start;">
                            <div class="ach-name">${ach.title}</div>
                            <span style="background:${diffColor}; font-size:9px; padding:2px 6px; border-radius:4px; color:#fff; font-weight:bold;">${diffLabel}</span>
                        </div>
                        <div style="font-size:10px; color:var(--muted); margin-bottom:4px; opacity:0.8;">[${ach.cat}]</div>
                        <div class="ach-desc">${ach.desc}</div>
                        ${ach.unlocked ? '<div class="ach-date">ë‹¬ì„± ì™„ë£Œ!</div>' : ''}
                    </div>
                `;
                grid.appendChild(el);
            });
            container.appendChild(grid);

            document.getElementById('achModal').style.display = 'flex';
        }

        function closeAchievements() {
            document.getElementById('achModal').style.display = 'none';
        }

        function openHistory() {
            const list = HistoryManager._data.logs;
            const container = document.getElementById('historyList');
            container.innerHTML = '';

            if (list.length === 0) {
                container.innerHTML = '<div style="padding:30px; text-align:center; color:var(--muted)">ì•„ì§ ê¸°ë¡ëœ í™œë™ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
            } else {
                list.forEach(log => {
                    const el = document.createElement('div');
                    el.style.padding = '12px 16px';
                    el.style.borderBottom = '1px solid var(--border-subtle)';
                    el.style.display = 'flex';
                    el.style.alignItems = 'center';
                    el.style.justifyContent = 'space-between';

                    const date = new Date(log.ts).toLocaleString();
                    const typeColor = log.type === 'UNLOCK' ? '#10b981' : '#3b82f6';
                    const icon = log.type === 'UNLOCK' ? 'ğŸ”“' : 'â­';

                    el.innerHTML = `
                        <div>
                            <div style="font-size:10px; color:var(--muted); margin-bottom:2px;">${date}</div>
                            <div style="font-size:14px; font-weight:600;">${icon} <span style="color:${typeColor}">${log.type}</span>: ${log.carName}</div>
                            <div style="font-size:12px; opacity:0.8;">${log.desc}</div>
                        </div>
                    `;
                    container.appendChild(el);
                });
            }

            document.getElementById('historyModal').style.display = 'flex';
        }

        function closeHistory() {
            document.getElementById('historyModal').style.display = 'none';
        }
    </script>
</body>

</html>