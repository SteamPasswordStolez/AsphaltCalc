<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>게시판 메인 — AsphaltCalc</title>
  <style>
    *{box-sizing:border-box;}
    body{
      margin:0;
      font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI","Noto Sans KR",sans-serif;
      background:#050816;
      color:#e5e7eb;
    }
    a{color:#60a5fa;text-decoration:none;}
    a:hover{text-decoration:underline;}
    .wrap{
      max-width:960px;
      margin:24px auto 40px;
      padding:0 16px;
    }
    header{
      display:flex;
      justify-content:space-between;
      align-items:flex-end;
      gap:12px;
      margin-bottom:16px;
      flex-wrap:wrap;
    }
    h1{margin:0;font-size:24px;}
    .sub{margin:4px 0 0;font-size:13px;color:#9ca3af;}
    .user-area{font-size:13px;text-align:right;}
    .btn{
      padding:6px 12px;
      border-radius:999px;
      border:1px solid #374151;
      background:#111827;
      color:#e5e7eb;
      font-size:13px;
      cursor:pointer;
    }
    .btn-primary{
      background:#3b82f6;
      border-color:#2563eb;
      color:white;
    }
    .btn:disabled{opacity:.6;cursor:default;}
    .card{
      background:#020617;
      border-radius:12px;
      border:1px solid #111827;
      padding:14px 16px;
      box-shadow:0 18px 45px rgba(0,0,0,.6);
    }
    .row{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:8px;
      flex-wrap:wrap;
    }
    .top-row-right{display:flex;gap:8px;align-items:center;flex-wrap:wrap;}
    .search-input{
      padding:6px 10px;
      border-radius:999px;
      border:1px solid #374151;
      background:#020617;
      color:#e5e7eb;
      font-size:13px;
      min-width:160px;
    }
    .search-input:focus{
      outline:none;
      border-color:#3b82f6;
      box-shadow:0 0 0 1px #3b82f6;
    }
    .post-list{
      margin-top:12px;
      display:flex;
      flex-direction:column;
      gap:8px;
      max-height:480px;
      overflow:auto;
    }
    .post{
      padding:8px 10px;
      border-radius:10px;
      border:1px solid #1f2937;
      background:#020617;
      cursor:pointer;
    }
    .post:hover{
      border-color:#2563eb;
      background:#020617;
    }
    .post-title{font-size:14px;font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
    .post-meta{font-size:11px;color:#9ca3af;margin-top:2px;}
    .post-body-preview{font-size:12px;margin-top:3px;color:#d1d5db;max-height:32px;overflow:hidden;}
    .msg{font-size:13px;margin-top:8px;color:#f9a8d4;}
    .info{font-size:13px;margin-top:6px;color:#9ca3af;}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div>
        <h1>AsphaltCalc 게시판</h1>
        <p class="sub">
          글 읽기는 누구나 가능하고, 글 작성/수정/삭제와 댓글은 이메일 인증 + 로그인 후에만 가능합니다.
        </p>
      </div>
      <div class="user-area">
        <div id="userStatus">로그인 상태 확인 중…</div>
        <div style="margin-top:4px;">
          <button id="loginBtn" class="btn" onclick="location.href='./login.html'">로그인</button>
          <button id="signupBtn" class="btn" onclick="location.href='./signup.html'">회원가입</button>
          <button id="logoutBtn" class="btn" style="display:none;">로그아웃</button>
        </div>
      </div>
    </header>

    <main class="card">
      <div class="row">
        <div>
          <strong>게시글 목록</strong>
          <div class="info" id="accessInfo">누구나 읽을 수 있고, 검색도 가능합니다.</div>
        </div>
        <div class="top-row-right">
          <input id="searchInput" class="search-input" type="search" placeholder="제목/내용 검색" />
          <button id="writeBtn" class="btn-primary btn">
            ✍️ 글 쓰기
          </button>
        </div>
      </div>

      <div id="postList" class="post-list">
        <div class="info">게시글을 불러오는 중…</div>
      </div>

      <div class="msg" id="mainMsg"></div>
    </main>
  </div>

  <script type="module">
    import {{ initializeApp }} from "https://www.gstatic.com/firebasejs/10.14.0/firebase-app.js";
    import {{
      getAuth,
      onAuthStateChanged,
      signOut
    }} from "https://www.gstatic.com/firebasejs/10.14.0/firebase-auth.js";
    import {{
      getFirestore,
      collection,
      getDocs,
      query,
      orderBy
    }} from "https://www.gstatic.com/firebasejs/10.14.0/firebase-firestore.js";

    const firebaseConfig = {
  apiKey: "AIzaSyCKIndVVlblrQfZGjaGpLBSxlWicLZiqPc",
  authDomain: "asphaltcalc-5d7f3.firebaseapp.com",
  projectId: "asphaltcalc-5d7f3",
  storageBucket: "asphaltcalc-5d7f3.firebasestorage.app",
  messagingSenderId: "388017703504",
  appId: "1:388017703504:web:117317163e1ec45a1d5f55"
};

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const userStatus = document.getElementById("userStatus");
    const accessInfo = document.getElementById("accessInfo");
    const postListEl = document.getElementById("postList");
    const mainMsg = document.getElementById("mainMsg");
    const loginBtn = document.getElementById("loginBtn");
    const signupBtn = document.getElementById("signupBtn");
    const logoutBtn = document.getElementById("logoutBtn");
    const writeBtn = document.getElementById("writeBtn");
    const searchInput = document.getElementById("searchInput");

    let currentUser = null;
    let allPosts = [];

    function renderPosts(filterText = "") {
      const q = filterText.trim().toLowerCase();
      postListEl.innerHTML = "";
      let list = allPosts;
      if (q) {
        list = allPosts.filter(p => (p.title + " " + p.content).toLowerCase().includes(q));
      }
      if (list.length === 0) {
        const div = document.createElement("div");
        div.className = "info";
        div.textContent = q ? "검색 결과가 없습니다." : "아직 작성된 게시글이 없습니다.";
        postListEl.appendChild(div);
        return;
      }
      for (const p of list) {
        const div = document.createElement("div");
        div.className = "post";
        div.innerHTML = `
          <div class="post-title">\${p.title || "(제목 없음)"}</div>
          <div class="post-meta">\${p.authorText}\${p.dateText ? " · " + p.dateText : ""}</div>
          <div class="post-body-preview">\${p.content.slice(0, 120)}</div>
        `;
        div.addEventListener("click", () => {
          location.href = \`./read.html?id=\${encodeURIComponent(p.id)}\`;
        });
        postListEl.appendChild(div);
      }
    }

    async function loadPosts() {
      postListEl.innerHTML = '<div class="info">게시글을 불러오는 중…</div>';
      try {
        const qRef = query(collection(db, "posts"), orderBy("createdAt", "desc"));
        const snap = await getDocs(qRef);
        allPosts = [];
        snap.forEach(docSnap => {
          const d = docSnap.data();
          const id = docSnap.id;
          const title = d.title || "(제목 없음)";
          const content = d.content || "";
          const author = d.authorName || (d.authorEmail ? d.authorEmail.split("@")[0] : "알 수 없음");
          const createdAt = d.createdAt?.toDate ? d.createdAt.toDate() : null;
          const dateStr = createdAt
            ? createdAt.toLocaleString("ko-KR", { month: "2-digit", day: "2-digit", hour: "2-digit", minute: "2-digit" })
            : "";
          allPosts.push({
            id,
            title,
            content,
            authorText: author,
            dateText: dateStr
          });
        });
        renderPosts(searchInput.value);
      } catch (e) {
        console.error(e);
        postListEl.innerHTML = '<div class="info">게시글을 불러오지 못했습니다.</div>';
        mainMsg.textContent = "Firestore 읽기 중 오류가 발생했습니다.";
      }
    }

    onAuthStateChanged(auth, (user) => {
      currentUser = user;
      if (!user) {
        userStatus.textContent = "로그아웃 상태 (읽기만 가능)";
        loginBtn.style.display = "";
        signupBtn.style.display = "";
        logoutBtn.style.display = "none";
      } else {
        const name = user.displayName || (user.email ? user.email.split("@")[0] : "사용자");
        const verifyTag = user.emailVerified ? "✅" : "⚠️";
        userStatus.textContent = `로그인: \${name} (\${user.email}) \${verifyTag}`;
        loginBtn.style.display = "none";
        signupBtn.style.display = "none";
        logoutBtn.style.display = "";
      }
    });

    logoutBtn.addEventListener("click", async () => {
      try { await signOut(auth); } catch (e) { console.error(e); }
    });

    writeBtn.addEventListener("click", () => {
      if (!currentUser) {
        alert("글을 작성하려면 먼저 로그인해야 합니다.");
        location.href = "./login.html";
        return;
      }
      if (!currentUser.emailVerified) {
        alert("이메일 인증이 완료된 계정만 글을 작성할 수 있습니다. 메일함에서 인증 링크를 클릭한 뒤 다시 로그인해주세요.");
        return;
      }
      location.href = "./write.html";
    });

    searchInput.addEventListener("input", () => {
      renderPosts(searchInput.value);
    });

    // 처음 로드시 바로 게시글 로드 (로그인 여부 무관)
    loadPosts();
  </script>
</body>
</html>