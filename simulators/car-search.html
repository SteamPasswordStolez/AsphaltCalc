<!doctype html>
<html lang="ko">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Car Search ‚Äî ÏûêÎèôÏ∞® Í≤ÄÏÉâ</title>
  <meta name="color-scheme" content="light dark" />

  <link rel="icon" href="../assets/favicon.png">
  <link rel="stylesheet" href="../assets/style.css">
  <link rel="stylesheet" href="../assets/themes.css">

  <!-- Theme Init -->
  <script>window.SIM_ID = "car-search";</script>
  <script src="../assets/theme-init.js"></script>
  <link rel="stylesheet" href="../assets/theme-adapter.css">

  <style>
    /* Page Specific Styles */
    /* Note: .container replaces .page-wrap. Max-width logic is handled by shared .container */

    .panel {
      border-radius: 18px;
      padding: 18px 20px 16px;
      background: var(--surface);
      border: 1px solid var(--border);
      box-shadow: var(--shadow-raised, 0 18px 45px rgba(0, 0, 0, .55));
    }

    .panel-title-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
      margin-bottom: 10px;
    }

    .panel-title {
      margin: 0;
      font-size: 16px;
      font-weight: 800;
      letter-spacing: .02em;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .badge-small {
      padding: 2px 6px;
      border-radius: 999px;
      border: 1px solid var(--border-subtle);
      font-size: 10px;
      letter-spacing: .06em;
      text-transform: uppercase;
      color: var(--ink-soft);
      background: var(--surface-soft);
      white-space: nowrap;
    }

    .sort-row {
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
      justify-content: flex-end;
    }

    .sort-chips {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      list-style: none;
      padding: 0;
      margin: 0;
    }

    .sort-chip {
      padding: 3px 10px;
      border-radius: 999px;
      font-size: 11px;
      letter-spacing: .06em;
      text-transform: uppercase;
      border: 1px solid var(--border-soft);
      background: var(--surface-soft);
      color: var(--ink-soft);
      cursor: pointer;
      user-select: none;
      white-space: nowrap;
    }

    .sort-chip.is-active {
      border-color: var(--accent);
      background: var(--accent-soft);
      color: var(--accent-strong);
      font-weight: 600;
    }

    .list-controls {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 10px;
      margin-bottom: 10px;
    }

    .search-wrap {
      flex: 1 1 200px;
      min-width: 0;
    }

    .search-input {
      width: 100%;
      padding: 7px 10px;
      border-radius: 999px;
      border: 1px solid var(--border-soft);
      background: var(--surface-soft);
      color: var(--ink);
      font-size: 13px;
      outline: none;
    }

    .search-input::placeholder {
      color: var(--ink-faint);
    }

    .class-chips {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      list-style: none;
      padding: 0;
      margin: 0;
    }

    .class-chip {
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 11px;
      letter-spacing: .09em;
      text-transform: uppercase;
      border: 1px solid var(--border-soft);
      background: var(--surface-soft);
      color: var(--ink-soft);
      cursor: pointer;
      user-select: none;
    }

    .class-chip.is-active {
      border-color: var(--accent);
      background: var(--accent-soft);
      color: var(--accent-strong);
    }

    .car-list-wrap {
      border-radius: 14px;
      border: 1px solid var(--border-soft);
      background: var(--surface-subtle);
      overflow: hidden;
    }

    .car-list {
      width: 100%;
      border-collapse: collapse;
      font-size: 12px;
    }

    .car-list thead {
      background: var(--surface-soft);
      position: sticky;
      top: 0;
      z-index: 1;
    }

    .car-list th,
    .car-list td {
      padding: 6px 8px;
      text-align: left;
      border-bottom: 1px solid var(--border-subtle);
      white-space: nowrap;
    }

    .car-list th {
      font-size: 11px;
      font-weight: 700;
      letter-spacing: .06em;
      text-transform: uppercase;
      color: var(--ink-soft);
    }

    .car-list tbody tr {
      cursor: pointer;
    }

    .car-list tbody tr:nth-child(2n) {
      background: var(--surface-weak);
    }

    .car-list tbody tr:hover {
      background: var(--surface-hover);
    }

    .col-class {
      width: 38px;
    }

    .col-id {
      width: 52px;
    }

    .col-max-rank {
      width: 80px;
    }

    .col-fuel {
      width: 50px;
    }

    .col-max-star {
      width: 55px;
    }

    .class-badge {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      min-width: 26px;
      padding: 2px 6px;
      border-radius: 999px;
      border: 1px solid var(--border-soft);
      font-size: 11px;
      font-weight: 700;
      color: var(--ink);
    }

    .class-d {
      background: #2a3b55;
      border-color: #3e5372;
      color: #a4c2f4;
    }

    .class-c {
      background: #2f2a55;
      border-color: #463e75;
      color: #c0a4f4;
    }

    .class-b {
      background: #552a2a;
      border-color: #753e3e;
      color: #f4a4a4;
    }

    .class-a {
      background: #55482a;
      border-color: #75633e;
      color: #f4dca4;
    }

    .class-s {
      background: #2a5548;
      border-color: #3e7563;
      color: #a4f4d2;
    }

    .car-name-cell {
      font-weight: 600;
      color: var(--ink);
      font-size: 13px;
    }

    .car-name-cell small {
      font-weight: 400;
      color: var(--ink-muted);
      margin-left: 6px;
    }

    .star-wrap {
      display: flex;
      gap: 1px;
      color: var(--accent-gold);
    }

    .star-wrap.max {
      color: var(--accent);
    }

    /* Loading / Empty states */
    .state-msg {
      padding: 40px;
      text-align: center;
      color: var(--ink-muted);
      font-size: 13px;
    }

    /* Garage Integration Styles */
    .owned-badge {
      display: inline-flex;
      font-size: 9px;
      font-weight: 800;
      color: var(--accent-strong);
      background: var(--accent-soft);
      border: 1px solid var(--accent);
      padding: 1px 5px;
      border-radius: 4px;
      margin-left: 6px;
      vertical-align: middle;
    }

    .owned-row td {
      background: rgba(var(--accent-rgb), 0.03);
    }

    html[data-theme='dark'] .owned-row td {
      background: rgba(var(--accent-rgb), 0.08);
    }

    .toggle-wrap {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 13px;
      color: var(--ink);
      cursor: pointer;
      user-select: none;
      margin-left: auto;
      /* Push to right */
    }
  </style>

  <script src="../assets/lang.js"></script>
  <script src="../assets/i18n.js"></script>
  <script src="../assets/garage.js"></script>
</head>

<body>
  <div class="container">
    <div class="header">
      <div class="brand">
        <h1>üîç <span data-i18n="cs.title">ÏûêÎèôÏ∞® Í≤ÄÏÉâ</span></h1>
      </div>
      <div class="toolbar">
        <a class="btn" href="../index.html" data-i18n="common.back">‚Üê ÌóàÎ∏å</a>
      </div>
    </div>


    <section class="panel">
      <div class="panel-title-row">
        <h2 class="panel-title" data-i18n="cs.all_cars">Ï†ÑÏ≤¥ Ï∞®Îüâ</h2>
        <div class="sort-row">
          <ul class="sort-chips" id="sortChips">
            <li class="sort-chip is-active" data-sort="default" data-i18n="cs.sort_default">Í∏∞Î≥∏</li>
            <li class="sort-chip" data-sort="rank-desc" data-i18n="cs.sort_rank_desc">Îû≠ÌÅ¨‚Üì</li>
            <li class="sort-chip" data-sort="rank-asc" data-i18n="cs.sort_rank_asc">Îû≠ÌÅ¨‚Üë</li>
            <li class="sort-chip" data-sort="id-asc" data-i18n="cs.sort_id_asc">ID‚Üë</li>
            <li class="sort-chip" data-sort="id-desc" data-i18n="cs.sort_id_desc">ID‚Üì</li>
          </ul>
          <span class="badge-small" id="countBadge">Ï¥ù 0ÎåÄ</span>
        </div>
      </div>

      <div class="list-controls">
        <div class="search-wrap">
          <input id="searchInput" class="search-input" type="search" data-placeholder="cs.search_ph"
            placeholder="Ï∞® Ïù¥Î¶Ñ ÎòêÎäî ID Í≤ÄÏÉâ..." onfocus="this.placeholder=''"
            onblur="this.placeholder=I18N.t('cs.search_ph')" autocomplete="off">
        </div>
        <ul class="class-chips" id="classFilter">
          <li class="class-chip is-active" data-class="ALL">ALL</li>
          <li class="class-chip" data-class="D">D</li>
          <li class="class-chip" data-class="C">C</li>
          <li class="class-chip" data-class="B">B</li>
          <li class="class-chip" data-class="A">A</li>
          <li class="class-chip" data-class="S">S</li>
        </ul>

        <!-- Owned Toggle -->
        <label class="toggle-wrap">
          <input type="checkbox" id="filterOwned">
          <span data-i18n="cs.filter_owned">Owned Only</span>
        </label>
      </div>

      <div class="car-list-wrap">
        <table class="car-list">
          <thead>
            <tr>
              <th class="col-class" data-i18n="cs.table.class">Class</th>
              <th class="col-id" data-i18n="cs.table.id">ID</th>
              <th data-i18n="cs.table.name">Ïù¥Î¶Ñ</th>
              <th class="col-max-rank" data-i18n="cs.table.max_rank">Max Rank</th>
              <th class="col-max-star" data-i18n="cs.table.max_star">‚òÖ Max</th>
              <th class="col-fuel" data-i18n="cs.table.fuel">Ïó∞Î£å</th>
            </tr>
          </thead>
          <tbody id="carListBody">
            <!-- JSÎ°ú Î†åÎçîÎßÅ -->
          </tbody>
        </table>
      </div>
    </section>
  </div>

  <script>
    // State
    let allCars = [];
    let state = {
      search: "",
      class: "ALL",
      sort: "default",
      onlyOwned: false
    };

    // Load Data
    async function init() {
      try {
        const res = await fetch('../assets/cars.json');
        if (!res.ok) throw new Error("Failed to load");
        allCars = await res.json();

        // Initial Render
        render();

        // Listeners
        setupListeners();
      } catch (e) {
        console.error(e);
        const body = document.getElementById('carListBody');
        if (body) body.innerHTML = `<tr><td colspan="6" class="state-msg">Error loading data.</td></tr>`;
      }
    }

    // Setup Listeners
    function setupListeners() {
      // Search
      const searchInp = document.getElementById('searchInput');
      if (searchInp) {
        searchInp.addEventListener('input', (e) => {
          state.search = e.target.value.toLowerCase().trim();
          render();
        });
      }

      // Class Filter
      const classFilter = document.getElementById('classFilter');
      if (classFilter) {
        classFilter.addEventListener('click', (e) => {
          const chip = e.target.closest('.class-chip');
          if (!chip) return;

          // Toggle active
          classFilter.querySelectorAll('.class-chip').forEach(c => c.classList.remove('is-active'));
          chip.classList.add('is-active');

          state.class = chip.dataset.class;
          render();
        });
      }

      // Sort Filter
      const sortFilter = document.getElementById('sortFilter');
      if (sortFilter) {
        sortFilter.addEventListener('click', (e) => {
          const chip = e.target.closest('.sort-chip');
          if (!chip) return;

          sortFilter.querySelectorAll('.sort-chip').forEach(c => c.classList.remove('is-active'));
          chip.classList.add('is-active');

          state.sort = chip.dataset.sort;
          render();
        });
      }

      // Owned Filter
      const ownedCheck = document.getElementById('filterOwned');
      if (ownedCheck) {
        ownedCheck.addEventListener('change', (e) => {
          state.onlyOwned = e.target.checked;
          render();
        });
      }
    }

    // Helper: Max Rank Logic
    function getMaxRank(car) {
      if (!car.stat || !Array.isArray(car.stat)) return 0;
      return Math.max(...car.stat.map(s => s.rank || 0));
    }

    function formatNumber(n) {
      return n.toLocaleString();
    }

    // Render List
    function render() {
      const tbody = document.getElementById('carListBody');
      const countLabel = document.getElementById('totalCount');
      if (!tbody) return;

      // 1. Filter
      let list = allCars.filter(c => {
        // Class
        if (state.class !== 'ALL' && c.class !== state.class) return false;

        // Search
        if (state.search) {
          const matchName = (c.name || "").toLowerCase().includes(state.search);
          const matchId = String(c.id).includes(state.search);
          if (!matchName && !matchId) return false;
        }

        // Owned
        if (state.onlyOwned && window.GarageManager && !GarageManager.hasCar(c.id)) return false;

        return true;
      });

      // 2. Sort
      if (state.sort !== 'default') {
        list.sort((a, b) => {
          if (state.sort === 'id_asc') return (a.id - b.id);
          if (state.sort === 'id_desc') return (b.id - a.id);
          if (state.sort === 'rank_asc') return getMaxRank(a) - getMaxRank(b);
          if (state.sort === 'rank_desc') return getMaxRank(b) - getMaxRank(a);
          return 0;
        });
      }

      // Update Count
      if (countLabel) countLabel.textContent = list.length;

      // 3. Draw
      tbody.innerHTML = '';

      if (list.length === 0) {
        tbody.innerHTML = `<tr><td colspan="6" class="state-msg" data-i18n="cs.msg_no_result">No cars found.</td></tr>`;
        return;
      }

      const fragment = document.createDocumentFragment();

      list.forEach(car => {
        const tr = document.createElement('tr');
        const isOwned = window.GarageManager && GarageManager.hasCar(car.id);

        if (isOwned) tr.classList.add('owned-row');

        tr.onclick = () => {
          location.href = `car-detail.html?id=${car.id}`;
        };

        // Class Cell
        const tdClass = document.createElement('td');
        tdClass.className = 'col-class';
        tdClass.innerHTML = `<span class="class-badge class-${(car.class || '').toLowerCase()}">${car.class}</span>`;

        // ID Cell
        const tdId = document.createElement('td');
        tdId.className = 'col-id';
        tdId.style.color = 'var(--ink-muted)';
        tdId.textContent = car.id;

        // Name Cell
        const tdName = document.createElement('td');
        tdName.className = 'car-name-cell';
        tdName.innerHTML = `
          ${car.name} 
          ${isOwned ? '<span class="owned-badge">OWNED</span>' : ''}
        `;

        // Max Rank Cell
        const tdMaxRank = document.createElement('td');
        tdMaxRank.className = 'col-max-rank';
        tdMaxRank.textContent = formatNumber(getMaxRank(car));

        // Max Star Cell
        const tdMaxStar = document.createElement('td');
        tdMaxStar.className = 'col-max-star';
        const maxStar = car.max_star || 6;
        let starHtml = `<div class="star-wrap max">`;
        for (let i = 0; i < maxStar; i++) starHtml += `‚òÖ`;
        starHtml += `</div>`;
        tdMaxStar.innerHTML = starHtml;

        // Fuel Cell
        const tdFuel = document.createElement('td');
        tdFuel.className = 'col-fuel';
        tdFuel.textContent = car.fuel;

        tr.appendChild(tdClass);
        tr.appendChild(tdId);
        tr.appendChild(tdName);
        tr.appendChild(tdMaxRank);
        tr.appendChild(tdMaxStar);
        tr.appendChild(tdFuel);

        fragment.appendChild(tr);
      });

      tbody.appendChild(fragment);
    }

    init();
  </script>
  <!-- Hub Back Button Inject -->
  <style>
    #hubBackWrap {
      position: fixed;
      left: 16px;
      top: 16px;
      z-index: 2147483647;
      font-family: ui-sans-serif, system-ui, Segoe UI, Roboto, "Noto Sans KR", Arial
    }

    #hubBackBtn {
      padding: 10px 14px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: var(--chip-bg);
      color: var(--ink);
      cursor: pointer;
      box-shadow: 0 6px 20px rgba(0, 0, 0, .35);
      opacity: .9
    }

    #hubBackBtn:hover {
      opacity: 1
    }

    @media (prefers-color-scheme: light) {
      #hubBackBtn {
        background: var(--chip-bg);
        color: var(--ink)
      }
    }
  </style>
  <div id="hubBackWrap">
    <button id="hubBackBtn" title="Î©îÏù∏ Î©îÎâ¥Î°ú" data-i18n="common.back">
      ‚Üê Î©îÏù∏ÏúºÎ°ú
    </button>
  </div>
  <script>
    (function () {
      var btn = document.getElementById('hubBackBtn');
      if (!btn) return;
      btn.addEventListener('click', function () {
        // If navigated from hub, try back; otherwise go to hub index.html
        if (document.referrer && document.referrer.indexOf('index.html') !== -1) {
          history.back();
        } else {
          // assume hub is one level up
          location.href = '../index.html';
        }
      });
    })();
  </script>
</body>

</html>