<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>프로필 / 닉네임 설정 — AsphaltCalc 게시판</title>
  <meta name="color-scheme" content="light dark" />
  <link rel="icon" href="../assets/favicon.png">
  <link rel="stylesheet" href="../assets/themes.css">
  <link rel="stylesheet" href="../assets/theme-adapter.css">
  <style>
    *{box-sizing:border-box;}
    body{
      margin:0;
      font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Apple SD Gothic Neo,Roboto,Noto Sans KR,Arial;
      background:var(--bg);
      color:var(--ink);
    }
    .wrap{
      max-width:720px;
      margin:32px auto;
      padding:0 16px 32px;
    }
    header{
      display:flex;
      justify-content:space-between;
      align-items:flex-end;
      gap:12px;
      flex-wrap:wrap;
      margin-bottom:20px;
    }
    h1{
      font-size:24px;
      margin:0 0 4px;
    }
    .sub{
      margin:0;
      font-size:14px;
      color:var(--ink-soft);
    }
    .card{
      border-radius:18px;
      padding:18px 20px;
      background:var(--card);
      box-shadow:var(--shadow-soft);
      margin-bottom:16px;
    }
    .row{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:12px;
      flex-wrap:wrap;
    }
    .btn{
      border:none;
      border-radius:999px;
      padding:8px 14px;
      font-size:14px;
      cursor:pointer;
      background:var(--chip-bg);
      color:var(--ink);
    }
    .btn.primary{
      background:var(--accent);
      color:#fff;
    }
    .btn-row{
      display:flex;
      gap:8px;
    }
    label{
      display:block;
      font-size:14px;
      margin-bottom:6px;
    }
    input{
      width:100%;
      padding:8px 10px;
      border-radius:10px;
      border:1px solid var(--border-subtle);
      background:var(--field);
      color:var(--ink);
      font-size:14px;
    }
    .msg{
      font-size:13px;
      margin-top:8px;
      min-height:18px;
    }
    .info{
      font-size:13px;
      color:var(--ink-soft);
    }
    a.back-link{
      font-size:14px;
      text-decoration:none;
      color:var(--accent);
    }
  </style>
<script>
(function(){
  var GKEY = 'simhub_theme_global';
  function resolveSystem(theme){
    if (theme === 'system') {
      var mq = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)');
      return (mq && mq.matches) ? 'dark' : 'light';
    }
    return theme || 'asphalt';
  }
  function currentTheme(){
    var attr = document.documentElement.getAttribute('data-theme');
    if (attr) return attr;
    var g = localStorage.getItem(GKEY);
    return g || 'asphalt';
  }
  function applyTheme(t){
    document.documentElement.setAttribute('data-theme', resolveSystem(t));
  }
  try {
    applyTheme(currentTheme());
  } catch(e) {
    console.warn(e);
  }
})();
</script>

</head>
<body>
  <div class="wrap">
    <header>
      <div>
        <h1>프로필 / 닉네임 설정</h1>
        <p class="sub">현재 로그인된 계정의 닉네임을 확인하고 변경할 수 있습니다.</p>
      </div>
      <div class="btn-row">
        <button id="backBtn" class="btn" type="button">← 게시판으로</button>
      </div>
    </header>

    <div class="card">
      <div class="row" style="margin-bottom:12px;">
        <div>
          <strong>로그인 상태</strong>
          <div id="userStatus" class="info">로그인 상태 확인 중…</div>
        </div>
        <div class="btn-row">
          <button id="loginBtn" class="btn">로그인</button>
          <button id="logoutBtn" class="btn" style="display:none;">로그아웃</button>
        </div>
      </div>
      <p class="info">닉네임은 게시판에서 다른 사람에게 보이는 이름입니다.</p>
    </div>

    <div class="card">
      <label>현재 닉네임</label>
      <div id="currentNickname" class="info">-</div>
      <div style="height:8px;"></div>
      <label for="nicknameInput">새 닉네임</label>
      <input id="nicknameInput" type="text" placeholder="2~12글자 닉네임" maxlength="20" />
      <div id="nickMsg" class="msg"></div>
      <div style="margin-top:12px;display:flex;gap:8px;justify-content:flex-end;">
        <button id="saveBtn" class="btn primary" type="button">닉네임 저장</button>
      </div>
    </div>

    <p class="info">※ 닉네임 변경 후에도 부적절한 표현이 발견되면 관리자에 의해 수정 또는 제한될 수 있습니다.</p>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-app.js";
    import {
      getAuth,
      onAuthStateChanged,
      updateProfile,
      signOut,
      signInWithEmailAndPassword
    } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCKIndVVlblrQfZGjaGpLBSxlWicLZiqPc",
      authDomain: "asphaltcalc-5d7f3.firebaseapp.com",
      projectId: "asphaltcalc-5d7f3",
      storageBucket: "asphaltcalc-5d7f3.firebasestorage.app",
      messagingSenderId: "388017703504",
      appId: "1:388017703504:web:117317163e1ec45a1d5f55"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);

    const backBtn         = document.getElementById("backBtn");
    const userStatus      = document.getElementById("userStatus");
    const loginBtn        = document.getElementById("loginBtn");
    const logoutBtn       = document.getElementById("logoutBtn");
    const currentNickname = document.getElementById("currentNickname");
    const nicknameInput   = document.getElementById("nicknameInput");
    const nickMsg         = document.getElementById("nickMsg");

    let currentUser = null;

    backBtn.addEventListener("click", () => {
      location.href = "./index.html";
    });

    loginBtn.addEventListener("click", () => {
      location.href = "./login.html";
    });

    logoutBtn.addEventListener("click", async () => {
      try {
        await signOut(auth);
      } catch (e) {
        console.error(e);
      }
    });

    function displayUser(user) {
      if (!user) {
        userStatus.textContent = "로그아웃 상태";
        loginBtn.style.display  = "";
        logoutBtn.style.display = "none";
        currentNickname.textContent = "-";
        nicknameInput.value = "";
        nickMsg.textContent = "로그인 후 닉네임을 변경할 수 있습니다.";
        nickMsg.style.color = "var(--danger)";
        return;
      }
      const baseName = user.email ? user.email.split("@")[0] : "사용자";
      const nick = user.displayName || baseName;
      userStatus.textContent = "로그인: " + nick + " (" + (user.email || "") + ")";
      currentNickname.textContent = nick;
      nicknameInput.value = nick;
      loginBtn.style.display  = "none";
      logoutBtn.style.display = "";
      nickMsg.textContent = "닉네임을 수정한 뒤 [닉네임 저장]을 누르면 적용됩니다.";
      nickMsg.style.color = "var(--ink-soft)";
    }

    onAuthStateChanged(auth, (user) => {
      currentUser = user;
      displayUser(user);
    });

    saveBtn.addEventListener("click", async () => {
      nickMsg.style.color = "var(--danger)";
      const user = currentUser;
      if (!user) {
        nickMsg.textContent = "로그인 후 닉네임을 변경할 수 있습니다.";
        return;
      }
      const raw = nicknameInput.value.trim();
      if (raw.length < 2 || raw.length > 12) {
        nickMsg.textContent = "닉네임은 2~12글자 사이로 입력해주세요.";
        return;
      }
      try {
        await updateProfile(user, { displayName: raw });
        nickMsg.style.color = "var(--success)";
        nickMsg.textContent = "닉네임이 변경되었습니다.";
        currentNickname.textContent = raw;
      } catch (e) {
        console.error(e);
        nickMsg.textContent = "닉네임 변경 중 오류가 발생했습니다.";
      }
    });
  </script>
</body>
</html>
