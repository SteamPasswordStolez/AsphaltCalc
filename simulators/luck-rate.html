<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Luck Rate â€” ìš´ë¹¨ìˆ˜ì¹˜ ê³„ì‚°ê¸°</title>
  <meta name="color-scheme" content="light dark" />

  <!-- í—ˆë¸Œì— ë¶™ì¼ ë•Œ ì´ ë‘ ì¤„ë§Œ ì‚´ë¦¬ë©´ ë¨
  <link rel="stylesheet" href="../assets/themes.css">
  <link rel="stylesheet" href="../assets/theme-adapter.css">
-->
  <style>
    * { box-sizing: border-box; }
    html, body { height: 100%; margin: 0; padding: 0; }
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
                   "Apple SD Gothic Neo", "Noto Sans KR", sans-serif;
      background: var(--bg, radial-gradient(circle at top, #141824 0, #050814 55%, #020308 100%));
      color: var(--ink, #f5f5f5);
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 16px;
      overflow: hidden;
    }

    .wrap {
      width: 100%;
      max-width: 880px;
      border-radius: 20px;
      padding: 22px 24px 24px;
      background: rgba(5, 8, 20, 0.92);
      border: 1px solid rgba(255, 255, 255, 0.06);
      box-shadow: 0 20px 50px rgba(0, 0, 0, 0.6);
      backdrop-filter: blur(16px);
      transition: filter .2s ease, opacity .2s ease;
    }

    .wrap.blurred {
      filter: blur(6px);
      opacity: 0.8;
      pointer-events: none;
      user-select: none;
    }

    .title-row {
      display: flex;
      align-items: baseline;
      justify-content: space-between;
      gap: 8px;
      margin-bottom: 10px;
      flex-wrap: wrap;
    }

    h1 {
      margin: 0;
      font-size: 22px;
      letter-spacing: .03em;
      font-weight: 900;
    }

    .subtitle {
      font-size: 12px;
      opacity: 0.75;
    }

    .mode-row {
      display: flex;
      align-items: center;
      gap: 10px;
      margin: 10px 0 12px;
      flex-wrap: wrap;
    }

    label {
      font-size: 13px;
    }

    select {
      border-radius: 999px;
      border: 1px solid rgba(255, 255, 255, 0.18);
      background: rgba(3, 6, 18, 0.9);
      color: inherit;
      padding: 7px 12px;
      font-size: 13px;
      outline: none;
    }
    select:focus {
      border-color: rgba(120, 200, 255, 0.9);
      box-shadow: 0 0 0 1px rgba(120, 200, 255, 0.4);
    }

    .mode-hint {
      font-size: 11px;
      opacity: 0.7;
    }

    .section-title {
      margin: 14px 0 6px;
      font-size: 14px;
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 6px;
      opacity: 0.95;
    }

    .section-title span.tag {
      font-size: 11px;
      padding: 2px 8px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.15);
      opacity: 0.8;
    }

    .input-grid {
      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 10px;
      margin-bottom: 8px;
    }

    @media (max-width: 800px) {
      .input-grid { grid-template-columns: 1fr; }
      .wrap { padding: 18px 16px 20px; }
    }

    .field {
      display: flex;
      flex-direction: column;
      gap: 4px;
      font-size: 13px;
    }

    .field-label {
      display: flex;
      justify-content: space-between;
      gap: 6px;
      opacity: 0.9;
    }

    .field small {
      opacity: 0.7;
      font-size: 11px;
    }

    input[type="number"] {
      width: 100%;
      border-radius: 10px;
      border: 1px solid rgba(255, 255, 255, 0.16);
      background: rgba(3, 6, 18, 0.85);
      color: inherit;
      padding: 8px 10px;
      font-size: 14px;
      outline: none;
      transition: border-color .15s, box-shadow .15s, background .15s, opacity .15s;
    }

    input[type="number"]:focus {
      border-color: rgba(120, 200, 255, 0.9);
      box-shadow: 0 0 0 1px rgba(120, 200, 255, 0.4);
      background: rgba(7, 12, 28, 0.95);
    }

    input[disabled] {
      opacity: 0.45;
      cursor: not-allowed;
    }

    .actions {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      margin-top: 10px;
      margin-bottom: 4px;
      flex-wrap: wrap;
    }

    .hint {
      font-size: 11px;
      opacity: 0.7;
    }

    button {
      border-radius: 999px;
      border: none;
      padding: 8px 20px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      background: linear-gradient(120deg, #31c6ff, #6c6bff, #ff4ecd);
      color: #fdfdfd;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.6);
      white-space: nowrap;
    }
    button:hover:not(:disabled) {
      filter: brightness(1.07);
      transform: translateY(-1px);
    }
    button:active:not(:disabled) {
      filter: brightness(0.96);
      transform: translateY(0);
      box-shadow: 0 6px 18px rgba(0, 0, 0, 0.6);
    }
    button:disabled {
      opacity: 0.45;
      cursor: not-allowed;
      box-shadow: none;
    }

    .error {
      font-size: 12px;
      color: #ff8585;
      margin-top: 6px;
      min-height: 16px;
    }

    /* === ê²°ê³¼ ëª¨ë‹¬ === */
    .result-overlay {
      position: fixed;
      inset: 0;
      display: none;
      align-items: center;
      justify-content: center;
      background: rgba(0, 0, 0, 0.55);
      backdrop-filter: blur(6px);
      z-index: 30;
    }

    .result-modal {
      width: min(360px, 80vw);
      max-height: 90vh;
      border-radius: 24px;
      background: radial-gradient(circle at top, rgba(255,255,255,0.1), rgba(3,5,15,1) 55%);
      border: 1px solid rgba(255,255,255,0.18);
      box-shadow: 0 22px 60px rgba(0,0,0,0.9);
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .result-image-slot {
      width: 100%;
      padding: 10px 10px 0;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .result-image-slot img {
      width: 100%;
      height: auto;
      max-height: 50vh;
      object-fit: contain;
      display: block;
    }

    .result-content {
      flex: 1;
      padding: 12px 16px 14px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      overflow-y: auto;
    }

    .result-title {
      font-size: 13px;
      letter-spacing: .13em;
      text-transform: uppercase;
      opacity: 0.7;
    }

    .luck-lines {
      text-align: center;
      font-size: 15px;
      font-weight: 700;
      line-height: 1.5;
      margin-top: 4px;
    }

    .luck-line + .luck-line {
      margin-top: 8px;
    }

    .luck-highlight {
      font-size: 18px;
      font-weight: 900;
      letter-spacing: .03em;
    }

    .luck-emoji {
      font-size: 20px;
      margin-right: 4px;
    }

    .result-footer {
      width: 100%;
      display: flex;
      justify-content: center;
      margin-top: 6px;
      padding-top: 4px;
      border-top: 1px solid rgba(255,255,255,0.12);
    }

    .close-btn {
      border-radius: 999px;
      border: none;
      padding: 6px 16px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      background: rgba(0,0,0,0.6);
      color: #f5f5f5;
      border: 1px solid rgba(255,255,255,0.25);
    }
    .close-btn:hover {
      background: rgba(255,255,255,0.06);
    }
  </style>
</head>
<body>
  <div class="wrap" id="mainWrap">
    <div class="title-row">
      <h1>ìš´ë¹¨ìˆ˜ì¹˜ ê³„ì‚°ê¸°</h1>
      <div class="subtitle">ì²­ì‚¬ì§„ / íŠ¹ìˆ˜ë¶€í’ˆ / ë‘˜ ë‹¤ Â· Binomial Luck Meter</div>
    </div>

    <div class="mode-row">
      <label for="mode"><b>ë¬´ì—‡ì„ ê¸°ì¤€ìœ¼ë¡œ ìš´ë¹¨ì„ ë³¼ê¹Œ?</b></label>
      <select id="mode">
        <option value="">-- ì„ íƒí•˜ì„¸ìš” --</option>
        <option value="bp">ì²­ì‚¬ì§„ë§Œ</option>
        <option value="sp">íŠ¹ìˆ˜ë¶€í’ˆë§Œ</option>
        <option value="both">ì²­ì‚¬ì§„ + íŠ¹ìˆ˜ë¶€í’ˆ ë‘˜ ë‹¤</option>
      </select>
    </div>
    <div class="mode-hint">
      ë¨¼ì € ì¸¡ì • ëŒ€ìƒì„ ê³ ë¥´ë©´ ì•„ë˜ ì…ë ¥ì°½ë“¤ì´ í™œì„±í™”ë©ë‹ˆë‹¤. ë‘˜ ë‹¤ë¥¼ ì„ íƒí•˜ë©´ ì²­ì‚¬ì§„/íŠ¹ìˆ˜ë¶€í’ˆì˜ ì‹œë„ íšŸìˆ˜ë¥¼ ê°ê° ë”°ë¡œ ë„£ì„ ìˆ˜ ìˆì–´ìš”.
    </div>

    <!-- ì²­ì‚¬ì§„ ì„¹ì…˜ -->
    <div id="bpSection">
      <div class="section-title">
        ì²­ì‚¬ì§„ (ì„¤ê³„ë„)
        <span class="tag">Blueprint</span>
      </div>
      <div class="input-grid">
        <div class="field">
          <div class="field-label">
            <span>ì²­ì‚¬ì§„ ë‹¨ì¼ ì„±ê³µ í™•ë¥ </span><small>(%)</small>
          </div>
          <input id="bpProb" type="number" min="0" max="100" step="0.0001" value="30" disabled />
          <small>ì˜ˆ: í•œ íŒì— ì„¤ê³„ë„ ëœ° í™•ë¥  30% â†’ 30</small>
        </div>
        <div class="field">
          <div class="field-label">
            <span>ì²­ì‚¬ì§„ ì‹œë„ íšŸìˆ˜</span><small>(íŒ ìˆ˜)</small>
          </div>
          <input id="bpTrials" type="number" min="1" step="1" value="90" disabled />
          <small>ì˜ˆ: 90íŒ ì§„í–‰</small>
        </div>
        <div class="field">
          <div class="field-label">
            <span>ì‹¤ì œ ì²­ì‚¬ì§„ íšŸìˆ˜</span><small>(ê°œìˆ˜)</small>
          </div>
          <input id="bpSuccesses" type="number" min="0" step="1" value="27" disabled />
          <small>ì˜ˆ: 27ë²ˆ ë¨¹ìŒ â†’ 27</small>
        </div>
      </div>
    </div>

    <!-- íŠ¹ìˆ˜ë¶€í’ˆ ì„¹ì…˜ -->
    <div id="spSection">
      <div class="section-title">
        íŠ¹ìˆ˜ë¶€í’ˆ
        <span class="tag">Special Part</span>
      </div>
      <div class="input-grid">
        <div class="field">
          <div class="field-label">
            <span>íŠ¹ìˆ˜ë¶€í’ˆ ë‹¨ì¼ ì„±ê³µ í™•ë¥ </span><small>(%)</small>
          </div>
          <input id="spProb" type="number" min="0" max="100" step="0.0001" value="4" disabled />
          <small>ì˜ˆ: í•œ íŒì— íŠ¹ìˆ˜ë¶€í’ˆ ëœ° í™•ë¥  4% â†’ 4</small>
        </div>
        <div class="field">
          <div class="field-label">
            <span>íŠ¹ìˆ˜ë¶€í’ˆ ì‹œë„ íšŸìˆ˜</span><small>(íŒ ìˆ˜)</small>
          </div>
          <input id="spTrials" type="number" min="1" step="1" value="90" disabled />
          <small>ì˜ˆ: 90íŒ ì§„í–‰ (ì²­ì‚¬ì§„ê³¼ ë‹¬ë¼ë„ ë¨)</small>
        </div>
        <div class="field">
          <div class="field-label">
            <span>ì‹¤ì œ íŠ¹ìˆ˜ë¶€í’ˆ íšŸìˆ˜</span><small>(ê°œìˆ˜)</small>
          </div>
          <input id="spSuccesses" type="number" min="0" step="1" value="1" disabled />
          <small>ì˜ˆ: 1ë²ˆ ë¨¹ìŒ â†’ 1</small>
        </div>
      </div>
    </div>

    <div class="actions">
      <div class="hint">
        ë‹¨ì¼ í™•ë¥ , ì‹œë„ ìˆ˜, ì‹¤ì œ íšŸìˆ˜ë¥¼ ë„£ê³ <br>
        <b>â€œìš´ë¹¨ìˆ˜ì¹˜ ê³„ì‚°â€</b> ë²„íŠ¼ì„ ëˆŒëŸ¬ë³´ì„¸ìš”.
      </div>
      <button id="calcBtn" disabled>ìš´ë¹¨ìˆ˜ì¹˜ ê³„ì‚°</button>
    </div>

    <div id="error" class="error"></div>
  </div>

  <!-- ê²°ê³¼ ëª¨ë‹¬ -->
  <div class="result-overlay" id="resultOverlay">
    <div class="result-modal">
      <div class="result-image-slot" id="resultImageSlot">
        <!-- ì´ë¯¸ì§€ëŠ” ì—¬ê¸° srcë§Œ ë°”ê¾¸ë©´ ë¨ -->
        <img id="resultImage"
             src="images/luck-neutral.png"
             alt=""
             loading="lazy">
      </div>
      <div class="result-content">
        <div>
          <div class="result-title">UNBBAL-LUCK METER</div>
          <div class="luck-lines" id="resultLines">
            <!-- JSì—ì„œ ìš´ë¹¨ìˆ˜ì¹˜ í…ìŠ¤íŠ¸ ì±„ì›Œì§ -->
          </div>
        </div>
        <div class="result-footer">
          <button class="close-btn" id="closeResultBtn">ë‹«ê¸°</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    function formatNumber(x, digits = 2) {
      if (!isFinite(x)) return "-";
      return x.toFixed(digits);
    }

    // ì´í•­ë¶„í¬ ê¼¬ë¦¬í™•ë¥  ê³„ì‚°
    function binomialTails(n, p, k) {
      if (p < 0 || p > 1) throw new Error("p out of range");
      if (n < 0 || !Number.isInteger(n)) throw new Error("n invalid");
      if (k < 0 || !Number.isInteger(k)) throw new Error("k invalid");

      if (p === 0) {
        return { lower: (k >= 0) ? 1 : 0, upper: (k <= 0) ? 1 : 0, mean: 0, std: 0 };
      }
      if (p === 1) {
        return { lower: (k >= n) ? 1 : 0, upper: (k <= n) ? 1 : 0, mean: n, std: 0 };
      }

      const mean = n * p;
      const std = Math.sqrt(n * p * (1 - p));

      let pmf;
      let lower = 0;
      let upper = 0;

      for (let i = 0; i <= n; i++) {
        if (i === 0) {
          pmf = Math.pow(1 - p, n);
        } else {
          pmf = pmf * ((n - (i - 1)) / i) * (p / (1 - p));
        }
        if (i <= k) lower += pmf;
        if (i >= k) upper += pmf;
      }

      if (lower > 1) lower = 1;
      if (upper > 1) upper = 1;
      if (lower < 0) lower = 0;
      if (upper < 0) upper = 0;

      return { lower, upper, mean, std };
    }

    // ìƒìœ„ í¼ì„¼íƒ€ì¼(pct)ì— ë”°ë¥¸ ë“±ê¸‰ + ì´ëª¨ì§€ ë§¤í•‘
    function getLuckGrade(pct) {
      // ì´ìŠ¤í„°ì—ê·¸: 69.74%
      if (Math.abs(pct - 69.74) < 0.005) {
        return {
          label: "ë‹¹ì‹ .. ë¬´ìŠ¨ ì§“ì„ í•œê²ë‹ˆê¹Œ..",
          emoji: "ğŸ¥µ"
        };
      }

      // 0.00% ~ 1.00%
      if (pct <= 1.0) {
        return { label: `"ì‹ "`, emoji: "" };
      }
      // 1.01% ~ 5.00%
      if (pct <= 5.0) {
        return { label: "ì „ì„¤ê¸‰ í–‰ìš´", emoji: "â­" };
      }
      // 5.01% ~ 10.00%
      if (pct <= 10.0) {
        return { label: "í¬ê·€í•œ í–‰ìš´", emoji: "ğŸ’§" };
      }
      // 10.01% ~ 20.00%
      if (pct <= 20.0) {
        return { label: "ìš´ìˆ˜ ì¢‹ì€ ë‚ ", emoji: "ğŸ’µ" };
      }
      // 20.01% ~ 40.00%
      if (pct <= 40.0) {
        return { label: "í‰ë²”í•œ í–‰ìš´", emoji: "ğŸ€" };
      }
      // 40.01% ~ 60.00%
      if (pct <= 60.0) {
        return { label: "ê·¸ëƒ¥ì €ëƒ¥..", emoji: "ğŸ˜" };
      }
      // 60.01% ~ 80.00%
      if (pct <= 80.0) {
        return { label: "ìƒˆë˜¥ ë°Ÿì€ ë‚ ..", emoji: "ğŸ’©" };
      }
      // 80.01% ~ 90.00%
      if (pct <= 90.0) {
        return { label: "ì—­ëŒ€ê¸‰ ë¶ˆìš´", emoji: "ğŸ’€" };
      }
      // 90.01% ~ 95.00%
      if (pct <= 95.0) {
        return { label: "ì •ë§ ìš´ì´ ì—†ìœ¼ì‹œë„¤ìš”...", emoji: "ğŸ›¢ï¸" };
      }
      // 95.01% ~ 99.00%
      if (pct <= 99.0) {
        return { label: "ì–´ì©Œë‹¤ ì´ì§€ê²½ê¹Œì§€..", emoji: "ğŸ¤®" };
      }
      // 99.01% ~ 99.99%
      if (pct <= 99.99) {
        return { label: "ë‹¹ì‹ ì€ ì‚¬ëŒì…ë‹ˆê¹Œ..", emoji: "â˜ ï¸" };
      }

      return { label: "ë‹¹ì‹ ì€ ì‚¬ëŒì…ë‹ˆê¹Œ..", emoji: "â˜ ï¸" };
    }

    // í•˜ë‚˜ì˜ ì§€í‘œ(ì²­ì‚¬ì§„ / íŠ¹ìˆ˜ë¶€í’ˆ)ì— ëŒ€í•œ ìš´ë¹¨ìˆ˜ì¹˜ ê³„ì‚°
    function evaluateLuck(kindLabel, probPercent, n, k) {
      if (isNaN(probPercent) || isNaN(n) || isNaN(k)) {
        throw new Error(kindLabel + " ì…ë ¥ê°’ì„ ì˜¬ë°”ë¥´ê²Œ ì±„ì›Œì£¼ì„¸ìš”.");
      }
      if (probPercent <= 0 || probPercent >= 100) {
        throw new Error(kindLabel + " ì„±ê³µ í™•ë¥ ì€ 0ë³´ë‹¤ í¬ê³  100ë³´ë‹¤ ì‘ì€ ê°’ì´ì–´ì•¼ í•©ë‹ˆë‹¤.");
      }
      if (n <= 0 || !Number.isInteger(n)) {
        throw new Error(kindLabel + " ì‹œë„ íšŸìˆ˜ëŠ” 1 ì´ìƒì˜ ì •ìˆ˜ì—¬ì•¼ í•©ë‹ˆë‹¤.");
      }
      if (k < 0 || k > n || !Number.isInteger(k)) {
        throw new Error(kindLabel + " ì„±ê³µ íšŸìˆ˜ëŠ” 0 ì´ìƒ, ì‹œë„ íšŸìˆ˜ ì´í•˜ì˜ ì •ìˆ˜ì—¬ì•¼ í•©ë‹ˆë‹¤.");
      }
      if (n > 1200) {
        throw new Error(kindLabel + " ì‹œë„ íšŸìˆ˜ê°€ ë„ˆë¬´ í½ë‹ˆë‹¤ (n â‰¤ 1200 ê¶Œì¥).");
      }

      const p = probPercent / 100;
      const tails = binomialTails(n, p, k);
      const mean = tails.mean;
      const std = tails.std;
      const lower = tails.lower; // P(X â‰¤ k)  (ë¶ˆìš´ ê¼¬ë¦¬)
      const upper = tails.upper; // P(X â‰¥ k)  (í–‰ìš´ ê¼¬ë¦¬)

      let pct;

      if (std === 0) {
        // p=0 ë˜ëŠ” 1 ê°™ì€ íŠ¹ì´ ì¼€ì´ìŠ¤ëŠ” ê·¸ëƒ¥ ì¤‘ì•™ê°’ ì·¨ê¸‰
        pct = 50;
      } else if (k > mean) {
        // í‰ê· ë³´ë‹¤ ë§ì´ ì„±ê³µ â†’ í–‰ìš´ ìª½ í¬ì†Œë„ ê·¸ëŒ€ë¡œ (0% = ì‹ ê¸‰ í–‰ìš´)
        pct = upper * 100;
      } else if (k < mean) {
        // í‰ê· ë³´ë‹¤ ì ê²Œ ì„±ê³µ â†’ ë¶ˆìš´ ìª½ í¬ì†Œë„ëŠ” ë’¤ì§‘ì–´ì„œ (100% = ì‹ ê¸‰ ë¶ˆìš´)
        pct = 100 - lower * 100;
      } else {
        // ë”± í‰ê· 
        pct = 50;
      }

      // ì•ˆì „ ë²”ìœ„ í´ë¨í”„
      if (pct < 0) pct = 0;
      if (pct > 100) pct = 100;

      const grade = getLuckGrade(pct);

      return {
        kind: kindLabel,     // "ì²­ì‚¬ì§„" / "íŠ¹ìˆ˜ë¶€í’ˆ"
        pct: pct,            // ìƒìœ„ í¼ì„¼íƒ€ì¼ ìˆ«ì
        label: grade.label,  // ê²°ê³¼ í…ìŠ¤íŠ¸
        emoji: grade.emoji   // ì´ëª¨ì§€ (ë˜ëŠ” ë¹ˆ ë¬¸ìì—´)
      };
    }

    // ê°€ì¥ "ê·¹ë‹¨ì ì¸" ìš´ë¹¨ ê¸°ì¤€ìœ¼ë¡œ ì´ë¯¸ì§€ ê³ ë¥´ê¸°
    function pickImageByLuck(lines) {
      if (!lines || !lines.length) return;

      // 50%ì—ì„œ ì–¼ë§ˆë‚˜ ë©€ë¦¬ ë–¨ì–´ì¡ŒëŠ”ì§€ ê¸°ì¤€ìœ¼ë¡œ ê·¹ë‹¨ì„± íŒì •
      let chosen = lines[0];
      for (const l of lines) {
        if (Math.abs(l.pct - 50) > Math.abs(chosen.pct - 50)) {
          chosen = l;
        }
      }

      let src = "images/luck-neutral.png";

      switch (chosen.label) {
        case `"ì‹ "`:
          src = "images/luck-god.png"; break;
        case "ì „ì„¤ê¸‰ í–‰ìš´":
          src = "images/luck-legend.png"; break;
        case "í¬ê·€í•œ í–‰ìš´":
          src = "images/luck-rare.png"; break;
        case "ìš´ìˆ˜ ì¢‹ì€ ë‚ ":
          src = "images/luck-good.png"; break;
        case "í‰ë²”í•œ í–‰ìš´":
          src = "images/luck-normal.png"; break;
        case "ê·¸ëƒ¥ì €ëƒ¥..":
          src = "images/luck-meh.png"; break;
        case "ìƒˆë˜¥ ë°Ÿì€ ë‚ ..":
          src = "images/luck-bad.png"; break;
        case "ì—­ëŒ€ê¸‰ ë¶ˆìš´":
          src = "images/luck-worst.png"; break;
        case "ì •ë§ ìš´ì´ ì—†ìœ¼ì‹œë„¤ìš”...":
          src = "images/luck-oil.png"; break;
        case "ì–´ì©Œë‹¤ ì´ì§€ê²½ê¹Œì§€..":
          src = "images/luck-sick.png"; break;
        case "ë‹¹ì‹ ì€ ì‚¬ëŒì…ë‹ˆê¹Œ..":
          src = "images/luck-not-human.png"; break;
        case "ë‹¹ì‹ .. ë¬´ìŠ¨ ì§“ì„ í•œê²ë‹ˆê¹Œ..":
          src = "images/luck-egg-6974.png"; break;
      }

      const img = document.getElementById("resultImage");
      if (img) img.src = src;
    }

    function setInputsEnabled(sectionId, enabled) {
      const section = document.getElementById(sectionId);
      const inputs = section.querySelectorAll("input[type='number']");
      inputs.forEach(inp => { inp.disabled = !enabled; });
    }

    function showResultModal(lines) {
      const overlay = document.getElementById("resultOverlay");
      const mainWrap = document.getElementById("mainWrap");
      const linesContainer = document.getElementById("resultLines");

      linesContainer.innerHTML = lines.map(line => {
        const pctText = formatNumber(line.pct, 2);
        const emojiPart = line.emoji ? `<span class="luck-emoji">${line.emoji}</span>` : "";
        return `
          <div class="luck-line">
            ${emojiPart}
            <span class="luck-highlight">${line.label}</span>
            <div style="font-size:13px; opacity:.8; margin-top:2px;">
              (${line.kind}, ìƒìœ„ ${pctText}%)
            </div>
          </div>
        `;
      }).join("");

      // ì´ë¯¸ì§€ ìë™ ì„ íƒ
      pickImageByLuck(lines);

      mainWrap.classList.add("blurred");
      overlay.style.display = "flex";
    }

    function hideResultModal() {
      const overlay = document.getElementById("resultOverlay");
      const mainWrap = document.getElementById("mainWrap");
      overlay.style.display = "none";
      mainWrap.classList.remove("blurred");
    }

    function compute() {
      const mode = document.getElementById("mode").value;
      const errorEl = document.getElementById("error");
      errorEl.textContent = "";

      if (!mode) {
        errorEl.textContent = "ë¨¼ì € ë¬´ì—‡ì„ ì¸¡ì •í• ì§€ ì„ íƒí•´ì£¼ì„¸ìš”.";
        return;
      }

      const results = [];

      try {
        if (mode === "bp" || mode === "both") {
          const prob = parseFloat(document.getElementById("bpProb").value);
          const n = parseInt(document.getElementById("bpTrials").value, 10);
          const k = parseInt(document.getElementById("bpSuccesses").value, 10);
          results.push(evaluateLuck("ì²­ì‚¬ì§„", prob, n, k));
        }

        if (mode === "sp" || mode === "both") {
          const prob = parseFloat(document.getElementById("spProb").value);
          const n = parseInt(document.getElementById("spTrials").value, 10);
          const k = parseInt(document.getElementById("spSuccesses").value, 10);
          results.push(evaluateLuck("íŠ¹ìˆ˜ë¶€í’ˆ", prob, n, k));
        }

        if (!results.length) {
          errorEl.textContent = "ê³„ì‚°í•  ëŒ€ìƒì´ ì—†ìŠµë‹ˆë‹¤.";
          return;
        }

        showResultModal(results);
      } catch (e) {
        errorEl.textContent = e.message;
      }
    }

    document.getElementById("mode").addEventListener("change", () => {
      const mode = document.getElementById("mode").value;
      const btn = document.getElementById("calcBtn");
      const errorEl = document.getElementById("error");
      errorEl.textContent = "";

      if (!mode) {
        setInputsEnabled("bpSection", false);
        setInputsEnabled("spSection", false);
        btn.disabled = true;
        return;
      }

      if (mode === "bp") {
        setInputsEnabled("bpSection", true);
        setInputsEnabled("spSection", false);
      } else if (mode === "sp") {
        setInputsEnabled("bpSection", false);
        setInputsEnabled("spSection", true);
      } else if (mode === "both") {
        setInputsEnabled("bpSection", true);
        setInputsEnabled("spSection", true);
      }
      btn.disabled = false;
    });

    document.getElementById("calcBtn").addEventListener("click", compute);
    document.getElementById("closeResultBtn").addEventListener("click", hideResultModal);
    document.getElementById("resultOverlay").addEventListener("click", (e) => {
      if (e.target.id === "resultOverlay") hideResultModal();
    });

    // Enterë¡œë„ ê³„ì‚°
    ["bpProb","bpTrials","bpSuccesses","spProb","spTrials","spSuccesses"].forEach(id => {
      const el = document.getElementById(id);
      el.addEventListener("keydown", e => {
        if (e.key === "Enter" && !document.getElementById("calcBtn").disabled) {
          compute();
        }
      });
    });
  </script>

<!-- Hub Back Button Inject -->
<style>
  #hubBackWrap{position:fixed; left:16px; top:16px; z-index:2147483647; font-family:ui-sans-serif,system-ui,Segoe UI,Roboto,"Noto Sans KR",Arial}
  #hubBackBtn{padding:10px 14px; border-radius:999px; border:1px solid var(--border); background:var(--chip-bg); color:var(--ink); cursor:pointer; box-shadow:0 6px 20px rgba(0,0,0,.35); opacity:.9}
  #hubBackBtn:hover{opacity:1}
  @media (prefers-color-scheme: light){
    #hubBackBtn{background:var(--chip-bg); color:var(--ink)}
  }
</style>
<div id="hubBackWrap">
  <button id="hubBackBtn" title="ë©”ì¸ ë©”ë‰´ë¡œ">
    â† ë©”ì¸ìœ¼ë¡œ
  </button>
</div>
<script>
  (function(){
    var btn = document.getElementById('hubBackBtn');
    if(!btn) return;
    btn.addEventListener('click', function(){
      // If navigated from hub, try back; otherwise go to hub index.html
      if (document.referrer && document.referrer.indexOf('index.html') !== -1) {
        history.back();
      } else {
        // assume hub is one level up
        location.href = '../index.html';
      }
    });
  })();
</script>
</body>
</html>
