
(function(){
  function $(s){ return document.querySelector(s); }
  function el(t,c){ const n=document.createElement(t); if(c) n.className=c; return n; }
  function getFavs(){ try{return JSON.parse(localStorage.getItem('simhub_favs')||'[]')}catch(_){return[]} }
  function setFavs(v){ localStorage.setItem('simhub_favs', JSON.stringify(v)) }
  function isFav(id){ return getFavs().includes(id) }
  function toggleFav(id){ const a=getFavs(); const i=a.indexOf(id); if(i>=0) a.splice(i,1); else a.push(id); setFavs(a); renderList(window.__CAT__) }

  function loadCatalog(){
    const inline = document.getElementById('catalog');
    if(inline && inline.textContent.trim()){
      try{ return JSON.parse(inline.textContent); }catch(_){}
    }
    return [];
  }

  function renderList(cat){
    const q = ($('#q').value||'').toLowerCase().trim();
    const onlyFav = $('#onlyFav').checked;
    const list = $('#simList'); list.innerHTML='';

    // Layout mode (list/grid) -> reflected by body[data-layout]
    const layout = (document.body.dataset.layout || 'list');
    if(layout.startsWith('grid')){
      list.style.display = 'grid';
      const cols = layout==='grid-3' ? 3 : 2;
      list.style.gridTemplateColumns = `repeat(${cols}, minmax(280px, 1fr))`;
      list.style.gap = '12px';
    } else {
      list.style.display = '';
      list.style.gridTemplateColumns = '';
      list.style.gap = '';
    }

    const items = cat.filter(x=>{
      const hay = [x.name, x.description, ...(x.tags||[])].join(' ').toLowerCase();
      const passQ = !q || hay.includes(q);
      const passFav = !onlyFav || isFav(x.id);
      return passQ && passFav;
    });

    if(items.length===0){
      const li = el('li','item'); li.textContent = '표시할 시뮬레이터가 없습니다.'; li.style.opacity=.7; list.appendChild(li);
      return;
    }

    items.forEach(x=>{
      const li = el('li','item');
      if(document.body.dataset.layout && document.body.dataset.layout.startsWith('grid')){
        // card look in grid
        li.style.flexDirection='column';
        li.style.alignItems='flex-start';
        li.style.height='auto';
      }
      const left = el('div','grow');
      left.innerHTML = `<div><b>${x.name}</b>${x.featured?'<span class="badge">FEATURED</span>':''}</div>
                        <div class="meta">${x.description}</div>`;
      const tags = el('div','tags');
      (x.tags||[]).forEach(t=>{ const s=el('span','tag'); s.textContent=t; tags.appendChild(s); });
      left.appendChild(tags);

      const btns = el('div');
      const fav = el('button','button'); fav.textContent = isFav(x.id)?'★ 즐겨찾기':'☆ 즐겨찾기'; fav.onclick = ()=>toggleFav(x.id);
      const open = el('button','button primary'); open.textContent='열기';
      open.onclick = ()=>{
        const mode = (window.__SIMHUB_GET_OPEN_MODE__ && window.__SIMHUB_GET_OPEN_MODE__()) || 'same';
        if(mode==='new') window.open(x.path, '_blank'); else window.location.href = x.path;
      };

      li.appendChild(left); btns.appendChild(fav); btns.appendChild(open); li.appendChild(btns);
      list.appendChild(li);
    });
  }

  const cat = loadCatalog();
  window.__CAT__ = cat;
  // Ensure theme attribute from settings helper (already set in settings script)
  document.addEventListener('DOMContentLoaded', function(){
    renderList(cat);
    $('#q').addEventListener('input', ()=>renderList(cat));
    $('#onlyFav').addEventListener('change', ()=>renderList(cat));
    window.addEventListener('keydown', (e)=>{ if(e.key==='/'){ e.preventDefault(); $('#q').focus(); }});
  });
})();
