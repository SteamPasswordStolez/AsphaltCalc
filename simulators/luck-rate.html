<!doctype html>
<html lang="ko">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="icon" href="../assets/favicon.png">
  <title>Luck Rate â€” ìš´ë¹¨ìˆ˜ì¹˜ ê³„ì‚°ê¸°</title>
  <meta name="color-scheme" content="light dark" />

  <link rel="stylesheet" href="../assets/style.css">
  <link rel="stylesheet" href="../assets/themes.css">

  <script>window.SIM_ID = "luck-rate";</script>
  <script src="../assets/theme-init.js"></script>
  <link rel="stylesheet" href="../assets/theme-adapter.css">

  <style>
    /* Local styles reserved for Luck Rate Modal */
    .result-overlay {
      position: fixed;
      inset: 0;
      display: none;
      align-items: center;
      justify-content: center;
      background: rgba(0, 0, 0, 0.55);
      backdrop-filter: blur(6px);
      z-index: 30;
    }

    .result-modal {
      width: min(360px, 80vw);
      max-height: 90vh;
      border-radius: 24px;
      /* Background handled by global theme vars in .panel/card but we force it here */
      background: var(--panel);
      border: 1px solid var(--border);
      box-shadow: 0 22px 60px rgba(0, 0, 0, 0.9);
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .result-image-slot {
      width: 100%;
      padding: 10px 10px 0;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .result-image-slot img {
      width: 100%;
      height: auto;
      max-height: 50vh;
      object-fit: contain;
      display: block;
    }

    .result-content {
      flex: 1;
      padding: 12px 16px 14px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      overflow-y: auto;
    }

    .result-title {
      font-size: 13px;
      letter-spacing: .13em;
      text-transform: uppercase;
      opacity: 0.7;
    }

    .luck-lines {
      text-align: center;
      font-size: 15px;
      font-weight: 700;
      line-height: 1.5;
      margin-top: 4px;
    }

    .luck-line+.luck-line {
      margin-top: 8px;
    }

    .luck-highlight {
      font-size: 18px;
      font-weight: 900;
      letter-spacing: .03em;
    }

    .luck-emoji {
      font-size: 20px;
      margin-right: 4px;
    }

    .result-footer {
      width: 100%;
      display: flex;
      justify-content: center;
      margin-top: 6px;
      padding-top: 4px;
      border-top: 1px solid var(--border);
    }

    .close-btn {
      border-radius: 999px;
      border: none;
      padding: 6px 16px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      background: rgba(0, 0, 0, 0.6);
      color: #f5f5f5;
      border: 1px solid rgba(255, 255, 255, 0.25);
    }

    .container.blurred {
      filter: blur(6px);
      opacity: 0.8;
      pointer-events: none;
      user-select: none;
    }
  </style>

  <script src="../assets/lang.js"></script>
  <script src="../assets/i18n.js"></script>
</head>

<body>
  <div class="container mobile-full" id="mainWrap">
    <div class="header">
      <div class="brand">
        <h1>ğŸ€ <span data-i18n="lr.title">ìš´ë¹¨ìˆ˜ì¹˜ ê³„ì‚°ê¸°</span></h1>
      </div>
      <div class="toolbar">
        <a class="btn" href="../index.html" data-i18n="common.back">â† í—ˆë¸Œ</a>
        <button id="btnReload" class="btn">
          <span data-i18n="common.reload">ìƒˆë¡œê³ ì¹¨</span>
        </button>
      </div>
    </div>

    <!-- Description -->
    <div class="subtitle meta" style="margin-bottom: 20px;" data-i18n="lr.subtitle">ì²­ì‚¬ì§„ / íŠ¹ìˆ˜ë¶€í’ˆ / ë‘˜ ë‹¤ Â· Binomial Luck
      Meter</div>

    <!-- Mode Select -->
    <div class="card" style="margin-bottom:20px; padding:16px;">
      <div class="form-group">
        <label style="font-size:15px; font-weight:700;"><span data-i18n="lr.label_mode">ë¬´ì—‡ì„ ê¸°ì¤€ìœ¼ë¡œ ìš´ë¹¨ì„ ë³¼ê¹Œ?</span></label>
        <select id="mode">
          <option value="" data-i18n="lr.opt_select">-- ì„ íƒí•˜ì„¸ìš” --</option>
          <option value="bp" data-i18n="lr.opt_bp">ì²­ì‚¬ì§„ë§Œ</option>
          <option value="sp" data-i18n="lr.opt_sp">íŠ¹ìˆ˜ë¶€í’ˆë§Œ</option>
          <option value="both" data-i18n="lr.opt_both">ì²­ì‚¬ì§„ + íŠ¹ìˆ˜ë¶€í’ˆ ë‘˜ ë‹¤</option>
        </select>
        <div class="meta" style="margin-top:8px" data-i18n="lr.hint_mode">
          ë¨¼ì € ì¸¡ì • ëŒ€ìƒì„ ê³ ë¥´ë©´ ì•„ë˜ ì…ë ¥ì°½ë“¤ì´ í™œì„±í™”ë©ë‹ˆë‹¤.
        </div>
      </div>
    </div>

    <!-- BP Section -->
    <div id="bpSection">
      <h2 class="title" style="display:flex;align-items:center;gap:8px">
        <span data-i18n="lr.sec_bp">ì²­ì‚¬ì§„</span>
        <span class="chip">Blueprint</span>
      </h2>
      <div class="card" style="margin-top:10px; padding:16px;">
        <div class="grid-responsive cols-3" style="gap:16px">
          <div class="form-group">
            <label><span data-i18n="lr.label_prob">í™•ë¥ (%)</span></label>
            <input id="bpProb" type="number" min="0" max="100" step="0.0001" value="30" disabled />
            <div class="meta" style="font-size:11px" data-i18n="lr.hint_bp_prob">ì˜ˆ: 30% -> 30</div>
          </div>
          <div class="form-group">
            <label><span data-i18n="lr.label_trials">ì‹œë„ íšŸìˆ˜</span></label>
            <input id="bpTrials" type="number" min="1" step="1" value="90" disabled />
            <div class="meta" style="font-size:11px" data-i18n="lr.hint_bp_trials">ì˜ˆ: 90íŒ</div>
          </div>
          <div class="form-group">
            <label><span data-i18n="lr.label_success">ì„±ê³µ íšŸìˆ˜</span></label>
            <input id="bpSuccesses" type="number" min="0" step="1" value="27" disabled />
            <div class="meta" style="font-size:11px" data-i18n="lr.hint_bp_success">ì˜ˆ: 27ì¥</div>
          </div>
        </div>
      </div>
    </div>

    <!-- SP Section -->
    <div id="spSection" style="margin-top:24px">
      <h2 class="title" style="display:flex;align-items:center;gap:8px">
        <span data-i18n="lr.sec_sp">íŠ¹ìˆ˜ë¶€í’ˆ</span>
        <span class="chip">Special Part</span>
      </h2>
      <div class="card" style="margin-top:10px; padding:16px;">
        <div class="grid-responsive cols-3" style="gap:16px">
          <div class="form-group">
            <label><span data-i18n="lr.label_prob">í™•ë¥ (%)</span></label>
            <input id="spProb" type="number" min="0" max="100" step="0.0001" value="4" disabled />
            <div class="meta" style="font-size:11px" data-i18n="lr.hint_sp_prob">ì˜ˆ: 4% -> 4</div>
          </div>
          <div class="form-group">
            <label><span data-i18n="lr.label_trials">ì‹œë„ íšŸìˆ˜</span></label>
            <input id="spTrials" type="number" min="1" step="1" value="90" disabled />
            <div class="meta" style="font-size:11px" data-i18n="lr.hint_sp_trials">90íŒ</div>
          </div>
          <div class="form-group">
            <label><span data-i18n="lr.label_success">ì„±ê³µ íšŸìˆ˜</span></label>
            <input id="spSuccesses" type="number" min="0" step="1" value="1" disabled />
            <div class="meta" style="font-size:11px" data-i18n="lr.hint_sp_success">1ê°œ</div>
          </div>
        </div>
      </div>
    </div>

    <div class="actions" style="margin-top:24px">
      <button id="calcBtn" class="primary" disabled data-i18n="lr.calculate">ìš´ë¹¨ìˆ˜ì¹˜ ê³„ì‚°</button>
    </div>

    <div id="error" class="danger-hint" style="margin-top:10px; text-align:center;"></div>

  </div>

  <!-- ê²°ê³¼ ëª¨ë‹¬ -->
  <div class="result-overlay" id="resultOverlay">
    <div class="result-modal">
      <div class="result-image-slot" id="resultImageSlot">
        <img id="resultImage" src="../images/luck-neutral.png" alt="" loading="lazy">
      </div>
      <div class="result-content">
        <div>
          <div class="result-title" data-i18n="lr.res_title">UNBBAL-LUCK METER</div>
          <div class="luck-lines" id="resultLines"></div>
        </div>
        <div class="result-footer">
          <button class="close-btn" id="closeResultBtn" data-i18n="common.close">ë‹«ê¸°</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    function formatNumber(x, digits = 2) {
      if (!isFinite(x)) return "-";
      return x.toFixed(digits);
    }

    // ì´í•­ë¶„í¬ ê¼¬ë¦¬í™•ë¥  ê³„ì‚°
    function binomialTails(n, p, k) {
      if (p < 0 || p > 1) throw new Error("p out of range");
      if (n < 0 || !Number.isInteger(n)) throw new Error("n invalid");
      if (k < 0 || !Number.isInteger(k)) throw new Error("k invalid");

      if (p === 0) {
        return { lower: (k >= 0) ? 1 : 0, upper: (k <= 0) ? 1 : 0, mean: 0, std: 0 };
      }
      if (p === 1) {
        return { lower: (k >= n) ? 1 : 0, upper: (k <= n) ? 1 : 0, mean: n, std: 0 };
      }

      const mean = n * p;
      const std = Math.sqrt(n * p * (1 - p));

      let pmf;
      let lower = 0;
      let upper = 0;

      for (let i = 0; i <= n; i++) {
        if (i === 0) {
          pmf = Math.pow(1 - p, n);
        } else {
          pmf = pmf * ((n - (i - 1)) / i) * (p / (1 - p));
        }
        if (i <= k) lower += pmf;
        if (i >= k) upper += pmf;
      }
      return { lower: Math.min(1, Math.max(0, lower)), upper: Math.min(1, Math.max(0, upper)), mean, std };
    }

    // ìƒìœ„ í¼ì„¼íƒ€ì¼ -> ë“±ê¸‰/ì´ëª¨ì§€
    function getLuckGrade(pct) {
      if (Math.abs(pct - 69.74) < 0.005) return { key: "lr.grade_egg", emoji: "ğŸ¥µ" };
      if (pct <= 1.0) return { key: "lr.grade_god", emoji: "" };
      if (pct <= 5.0) return { key: "lr.grade_legend", emoji: "â­" };
      if (pct <= 10.0) return { key: "lr.grade_rare", emoji: "ğŸ’§" };
      if (pct <= 20.0) return { key: "lr.grade_good", emoji: "ğŸ’µ" };
      if (pct <= 40.0) return { key: "lr.grade_normal", emoji: "ğŸ€" };
      if (pct <= 60.0) return { key: "lr.grade_meh", emoji: "ğŸ˜" };
      if (pct <= 80.0) return { key: "lr.grade_bad", emoji: "ğŸ’©" };
      if (pct <= 90.0) return { key: "lr.grade_worst", emoji: "ğŸ’€" };
      if (pct <= 95.0) return { key: "lr.grade_oil", emoji: "ğŸ›¢ï¸" };
      if (pct <= 99.0) return { key: "lr.grade_sick", emoji: "ğŸ¤®" };
      return { key: "lr.grade_not_human", emoji: "â˜ ï¸" };
    }

    function evaluateLuck(kindLabel, probPercent, n, k) {
      const p = probPercent / 100;
      const tails = binomialTails(n, p, k);
      const mean = tails.mean;
      const std = tails.std;
      const lower = tails.lower;
      const upper = tails.upper;

      let pct;
      if (std === 0) pct = 50;
      else if (k > mean) pct = upper * 100;
      else if (k < mean) pct = 100 - lower * 100;
      else pct = 50;

      if (pct < 0) pct = 0; if (pct > 100) pct = 100;
      const grade = getLuckGrade(pct);

      return { kind: kindLabel, pct: pct, labelKey: grade.key, emoji: grade.emoji };
    }

    function pickImageByLuck(lines) {
      if (!lines || !lines.length) return;
      let chosen = lines[0];
      for (const l of lines) {
        if (Math.abs(l.pct - 50) > Math.abs(chosen.pct - 50)) chosen = l;
      }
      let src = "../images/luck-neutral.png";
      switch (chosen.labelKey) {
        case "lr.grade_god": src = "../images/luck-god.png"; break;
        case "lr.grade_legend": src = "../images/luck-legend.png"; break;
        case "lr.grade_rare": src = "../images/luck-rare.png"; break;
        case "lr.grade_good": src = "../images/luck-good.png"; break;
        case "lr.grade_normal": src = "../images/luck-normal.png"; break;
        case "lr.grade_meh": src = "../images/luck-meh.png"; break;
        case "lr.grade_bad": src = "../images/luck-bad.png"; break;
        case "lr.grade_worst": src = "../images/luck-worst.png"; break;
        case "lr.grade_oil": src = "../images/luck-oil.png"; break;
        case "lr.grade_sick": src = "../images/luck-sick.png"; break;
        case "lr.grade_not_human": src = "../images/luck-not-human.png"; break;
        case "lr.grade_egg": src = "../images/luck-egg-6974.png"; break;
      }
      const img = document.getElementById("resultImage");
      if (img) img.src = src;
    }

    function setInputsEnabled(sectionId, enabled) {
      const section = document.getElementById(sectionId);
      const inputs = section.querySelectorAll("input[type='number']");
      inputs.forEach(inp => { inp.disabled = !enabled; });
    }

    function showResultModal(lines) {
      const overlay = document.getElementById("resultOverlay");
      const mainWrap = document.getElementById("mainWrap");
      const linesContainer = document.getElementById("resultLines");

      linesContainer.innerHTML = lines.map(line => {
        const pctText = formatNumber(line.pct, 2);
        const emojiPart = line.emoji ? `<span class="luck-emoji">${line.emoji}</span>` : "";
        return `
          <div class="luck-line">
            ${emojiPart}
            <span class="luck-highlight">${I18N.t(line.labelKey)}</span>
            <div style="font-size:13px; opacity:.8; margin-top:2px;">
              (${I18N.t(line.kind)}, ${I18N.t('lr.res_upper').replace('{n}', pctText)})
            </div>
          </div>
        `;
      }).join("");

      pickImageByLuck(lines);
      mainWrap.classList.add("blurred");
      overlay.style.display = "flex";
    }

    function hideResultModal() {
      const overlay = document.getElementById("resultOverlay");
      const mainWrap = document.getElementById("mainWrap");
      overlay.style.display = "none";
      mainWrap.classList.remove("blurred");
    }

    function compute() {
      const mode = document.getElementById("mode").value;
      const errorEl = document.getElementById("error");
      errorEl.textContent = "";

      if (!mode) {
        errorEl.textContent = I18N.t('lr.err_select_mode');
        return;
      }

      const results = [];
      try {
        if (mode === "bp" || mode === "both") {
          const prob = parseFloat(document.getElementById("bpProb").value);
          const n = parseInt(document.getElementById("bpTrials").value, 10);
          const k = parseInt(document.getElementById("bpSuccesses").value, 10);
          const label = "lr.sec_bp";
          if (isNaN(prob)) throw new Error(I18N.t('lr.err_input_req').replace('{kind}', I18N.t(label)));
          if (prob < 0 || prob > 100) throw new Error(I18N.t('lr.err_prob_range').replace('{kind}', I18N.t(label)));
          if (n <= 0 || !Number.isInteger(n)) throw new Error(I18N.t('lr.err_n_int').replace('{kind}', I18N.t(label)));
          if (k < 0 || k > n || !Number.isInteger(k)) throw new Error(I18N.t('lr.err_k_range').replace('{kind}', I18N.t(label)));
          results.push(evaluateLuck(label, prob, n, k));
        }
        if (mode === "sp" || mode === "both") {
          const prob = parseFloat(document.getElementById("spProb").value);
          const n = parseInt(document.getElementById("spTrials").value, 10);
          const k = parseInt(document.getElementById("spSuccesses").value, 10);
          const label = "lr.sec_sp";
          if (isNaN(prob)) throw new Error(I18N.t('lr.err_input_req').replace('{kind}', I18N.t(label)));
          if (prob < 0 || prob > 100) throw new Error(I18N.t('lr.err_prob_range').replace('{kind}', I18N.t(label)));
          if (n <= 0 || !Number.isInteger(n)) throw new Error(I18N.t('lr.err_n_int').replace('{kind}', I18N.t(label)));
          if (k < 0 || k > n || !Number.isInteger(k)) throw new Error(I18N.t('lr.err_k_range').replace('{kind}', I18N.t(label)));
          results.push(evaluateLuck(label, prob, n, k));
        }

        if (!results.length) {
          errorEl.textContent = I18N.t('lr.err_no_target');
          return;
        }
        showResultModal(results);
      } catch (e) {
        errorEl.textContent = e.message;
      }
    }

    document.getElementById("mode").addEventListener("change", () => {
      const mode = document.getElementById("mode").value;
      const btn = document.getElementById("calcBtn");
      const errorEl = document.getElementById("error");
      errorEl.textContent = "";

      if (!mode) {
        setInputsEnabled("bpSection", false);
        setInputsEnabled("spSection", false);
        btn.disabled = true;
        return;
      }
      if (mode === "bp") {
        setInputsEnabled("bpSection", true);
        setInputsEnabled("spSection", false);
      } else if (mode === "sp") {
        setInputsEnabled("bpSection", false);
        setInputsEnabled("spSection", true);
      } else if (mode === "both") {
        setInputsEnabled("bpSection", true);
        setInputsEnabled("spSection", true);
      }
      btn.disabled = false;
    });

    document.getElementById("calcBtn").addEventListener("click", compute);
    document.getElementById("closeResultBtn").addEventListener("click", hideResultModal);
    document.getElementById("resultOverlay").addEventListener("click", (e) => {
      if (e.target.id === "resultOverlay") hideResultModal();
    });

    // Reload btn
    var btnReload = document.getElementById("btnReload");
    if (btnReload) btnReload.addEventListener("click", function () { location.reload(); });

  </script>
</body>

</html>