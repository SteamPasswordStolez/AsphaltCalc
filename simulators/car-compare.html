<!doctype html>
<html lang="ko">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="icon" href="../assets/favicon.png">
  <title>Car Stat Compare â€” ì°¨ ìŠ¤íƒ¯ ë¹„êµ</title>
  <meta name="color-scheme" content="light dark" />

  <link rel="stylesheet" href="../assets/style.css">
  <link rel="stylesheet" href="../assets/themes.css">

  <!-- Theme Init -->
  <script>window.SIM_ID = "car-compare";</script>
  <script src="../assets/theme-init.js"></script>
  <link rel="stylesheet" href="../assets/theme-adapter.css">
  <script src="../assets/lang.js"></script>
  <script src="../assets/i18n.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    /* Variable Mapping: Legacy -> Shared */
    :root {
      --bg: var(--bg);
      --fg: var(--ink);
      --muted: var(--ink-soft);
      --card: var(--panel);
      --border: var(--border);
      --brand: var(--accent);
      --accent: var(--accent);
      --radius: 16px;
      --shadow: 0 10px 24px rgba(0, 0, 0, .35), 0 2px 10px rgba(0, 0, 0, .35);
      --tab: var(--surface-soft);
      --tabActive: var(--surface-hover);
    }

    /* Override specific styles to match shared look */
    body {
      background: var(--bg);
      color: var(--fg);
      font-family: system-ui, sans-serif;
    }

    .panel {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 16px 16px 18px;
    }

    input,
    select {
      border: 1px solid var(--border);
    }

    input:focus,
    select:focus {
      outline: 2px solid var(--accent);
      border-color: var(--accent);
    }

    :root {
      --bg: #0b1220;
      --fg: #e5e7eb;
      --muted: #9aa4b2;
      --card: #111827;
      --border: #1f2937;
      --brand: #7c3aed;
      --accent: #22d3ee;
      --radius: 16px;
      --shadow: 0 10px 24px rgba(0, 0, 0, .35), 0 2px 10px rgba(0, 0, 0, .35);
      --tab: #0f172a;
      --tabActive: #1f2937;
    }

    @media (prefers-color-scheme: light) {
      :root {
        --bg: #ffffff;
        --fg: #0f172a;
        --muted: #475569;
        --card: #f8fafc;
        --border: #e2e8f0;
        --brand: #6d28d9;
        --accent: #0891b2;
        --shadow: 0 10px 20px rgba(2, 6, 23, .06), 0 2px 6px rgba(2, 6, 23, .08);
        --tab: #eef2f7;
        --tabActive: #ffffff;
      }
    }

    * {
      box-sizing: border-box
    }

    body {
      margin: 0;
      background: var(--bg);
      color: var(--fg);
      font: 16px/1.55 ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
    }

    header {
      position: sticky;
      top: 0;
      backdrop-filter: saturate(160%) blur(8px);
      border-bottom: 1px solid var(--border);
      background: color-mix(in srgb, var(--bg) 82%, transparent);
      z-index: 20;
    }

    header .inner {
      max-width: 1100px;
      margin: auto;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 14px 16px;
    }

    .brand {
      display: flex;
      align-items: center;
      gap: 10px;
      font-weight: 800;
      letter-spacing: .2px;
    }

    .dot {
      width: 28px;
      height: 28px;
      border-radius: 10px;
      background: linear-gradient(135deg, var(--brand), var(--accent));
      box-shadow: inset 0 0 0 2px color-mix(in srgb, var(--brand) 25%, #fff), var(--shadow);
    }

    main {
      max-width: 1100px;
      margin: auto;
      padding: 18px 16px 26px;
      display: flex;
      flex-direction: column;
      gap: 14px;
    }

    h1 {
      margin: 0;
      font-size: 22px;
    }

    .subtitle {
      font-size: 14px;
      color: var(--muted);
      margin-top: 4px;
    }

    .subtitle small {
      display: block;
      font-size: 12px;
      margin-top: 2px;
    }

    .chip-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 8px;
    }

    .chip {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: var(--tab);
      color: var(--muted);
      font-size: 12px;
    }

    .chip code {
      font-family: ui-monospace, Menlo, Consolas, monospace;
      font-size: 11px;
    }

    .panel {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 16px 16px 18px;
    }

    .grid {
      display: grid;
      gap: 12px;
    }

    .grid.cols-2 {
      grid-template-columns: repeat(2, minmax(0, 1fr));
    }

    @media (max-width:900px) {
      .grid.cols-2 {
        grid-template-columns: 1fr;
      }
    }

    label {
      font-size: 12px;
      color: var(--muted);
    }

    input,
    select {
      width: 100%;
      padding: 9px 11px;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: transparent;
      color: inherit;
      font: 14px ui-sans-serif, system-ui;
    }

    input::placeholder {
      color: var(--muted);
    }

    input:focus,
    select:focus {
      outline: 2px solid color-mix(in srgb, var(--accent) 55%, transparent);
      outline-offset: 1px;
      border-color: color-mix(in srgb, var(--accent) 60%, var(--border));
    }

    .field-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 4px;
    }

    .field-row>* {
      flex: 1 1 0;
      min-width: 0;
    }

    .side-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-end;
      margin-bottom: 8px;
    }

    .side-title {
      font-size: 15px;
      font-weight: 700;
    }

    .side-tag {
      font-size: 11px;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: .18em;
    }

    .filter-bar {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 8px;
    }

    .class-filter {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
    }

    .class-pill {
      padding: 4px 10px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: var(--tab);
      color: var(--muted);
      font-size: 11px;
      cursor: pointer;
      user-select: none;
    }

    .class-pill.active {
      background: var(--tabActive);
      color: var(--fg);
      border-color: color-mix(in srgb, var(--accent) 50%, var(--border));
    }

    .summary-box {
      margin-top: 10px;
      padding: 9px 11px;
      border-radius: 12px;
      border: 1px solid color-mix(in srgb, var(--border) 85%, var(--bg));
      /* â˜… íŒ¨ë„ê³¼ ë¹„ìŠ·í•œ í†¤ */
      background: color-mix(in srgb, var(--card) 94%, var(--bg));
      font-size: 13px;
      color: var(--muted);
    }

    .car-chip {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 9px;
      border-radius: 999px;
      border: 1px solid color-mix(in srgb, var(--border) 80%, var(--bg));
      /* â˜… ìš”ì•½ ë°•ìŠ¤ë³´ë‹¤ ì‚´ì§ ì§„í•˜ê²Œ */
      background: color-mix(in srgb, var(--card) 88%, var(--bg));
      font-size: 12px;
      color: var(--fg);
    }

    .car-chip .cls {
      font-weight: 700;
      color: var(--accent);
    }


    .result-header {
      display: flex;
      justify-content: space-between;
      gap: 10px;
      align-items: center;
      margin-bottom: 10px;
    }

    .result-title {
      font-size: 13px;
      font-weight: 700;
      letter-spacing: .16em;
      text-transform: uppercase;
      color: var(--muted);
    }

    .badge {
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: var(--tab);
      font-size: 12px;
      color: var(--muted);
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
    }

    thead th {
      border-bottom: 1px solid var(--border);
      padding: 6px 6px 8px;
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: .12em;
      color: var(--muted);
      text-align: center;
    }

    thead th:first-child {
      text-align: left;
    }

    /* í–‰ ë°°ê²½ â€“ í…Œë§ˆ ìƒ‰ì— ë”°ë¼ ìë™ìœ¼ë¡œ ì–´ë‘ì›Œì§€ë„ë¡ */
    tbody tr:nth-child(odd) {
      background: color-mix(in srgb, var(--card) 90%, var(--bg));
    }

    tbody tr:nth-child(even) {
      background: color-mix(in srgb, var(--card) 78%, var(--bg));
    }


    tbody th,
    tbody td {
      padding: 7px 6px;
      border-bottom: 1px solid rgba(15, 23, 42, .8);
    }

    tbody th {
      text-align: left;
      font-weight: 600;
      color: var(--muted);
      width: 26%;
    }

    tbody td {
      text-align: center;
      font-variant-numeric: tabular-nums;
    }

    .value-better {
      background: linear-gradient(90deg,
          color-mix(in srgb, var(--accent) 38%, transparent),
          transparent);
    }

    .value-worse {
      opacity: .72;
    }

    .indicator {
      font-size: 10px;
      margin-left: 4px;
    }

    .indicator.up {
      color: #4ade80;
    }

    .indicator.down {
      color: #f97373;
    }

    .empty-state {
      font-size: 13px;
      color: var(--muted);
    }

    #searchInput {
      min-width: 220px;
    }

    @media (max-width:600px) {
      header .inner {
        padding-inline: 10px;
      }

      main {
        padding-inline: 10px;
      }
    }
  </style>

</head>

<body>
  <div class="container">
    <div class="header">
      <div class="brand">
        <h1>ğŸ“Š <span data-i18n="cc.title">ìë™ì°¨ ìŠ¤íƒ¯ ë¹„êµ</span></h1>
      </div>
      <div class="toolbar">
        <a class="btn" href="../index.html" data-i18n="common.back">â† í—ˆë¸Œ</a>
      </div>
    </div>

    <div class="content-stack" style="display:flex; flex-direction:column; gap:14px; padding-top:18px;">
      <section>
        <h1 data-i18n="cc.h1_compare">ë‘ ì°¨ëŸ‰ ìŠ¤íƒ¯ ë¹„êµ</h1>
        <p class="subtitle" data-i18n="cc.subtitle">
          ê° ì°¨ëŸ‰ì— ëŒ€í•´ ìŠ¤í†¡, 1ì„±, 2ì„±, 3ì„±, 4ì„±, 5ì„±, íŠ¹ë¶€ ì œì™¸ í’€ì—…, ê¸ˆë”± ì¤‘ í•˜ë‚˜ë¥¼ ì„ íƒí•´ì„œ ë­í¬/ìµœê³ ì†ë„/ê°€ì†/í•¸ë“¤/ë‹ˆíŠ¸ë¡œë¥¼ ë¹„êµí•©ë‹ˆë‹¤.
          <small>ë°ì´í„°ëŠ” <code>cars.json</code>ì˜ <code>stat</code> ë°°ì—´ì„ ì‚¬ìš©í•©ë‹ˆë‹¤.</small>
        </p>
        <div class="chip-row">
          <div class="chip" data-i18n="cc.chip_source">ğŸ“ ë°ì´í„° ì†ŒìŠ¤: <code>cars.json</code></div>
          <div class="chip" data-i18n="cc.chip_sort">âš™ ì •ë ¬: í´ë˜ìŠ¤ D â†’ C â†’ B â†’ A â†’ S, í´ë˜ìŠ¤ ë‚´ì—ì„œëŠ” id ì˜¤ë¦„ì°¨ìˆœ</div>
        </div>
      </section>

      <!-- ì „ì²´ í•„í„° -->
      <section class="panel">
        <label data-i18n="cc.filter_label">ì „ì²´ ì°¨ëŸ‰ í•„í„°</label>
        <div class="filter-bar">
          <div class="class-filter" id="classFilter">
            <div class="class-pill active" data-class="ALL">ALL</div>
            <div class="class-pill" data-class="D">D</div>
            <div class="class-pill" data-class="C">C</div>
            <div class="class-pill" data-class="B">B</div>
            <div class="class-pill" data-class="A">A</div>
            <div class="class-pill" data-class="S">S</div>
          </div>
          <input id="searchInput" type="text" data-placeholder="cc.search_ph" placeholder="ì°¨ëŸ‰ ì´ë¦„ ê²€ìƒ‰..." />
        </div>
      </section>

      <!-- ì¢Œ/ìš° ì„ íƒ -->
      <section class="grid cols-2">
        <div class="panel">
          <div class="side-header">
            <div class="side-title" data-i18n="cc.side_left">ì¢Œì¸¡ ì°¨ëŸ‰</div>
            <div class="side-tag" data-i18n="cc.player_a">PLAYER A</div>
          </div>
          <label data-i18n="cc.label_car">ì°¨ëŸ‰ ì„ íƒ</label>
          <div class="field-row">
            <select id="carSelectLeft">
              <option value="" data-i18n="cc.opt_select_car">ì°¨ëŸ‰ì„ ì„ íƒí•˜ì„¸ìš”</option>
            </select>
          </div>

          <label style="margin-top:8px;" data-i18n="cc.label_stage">ì¢Œì¸¡ ë‹¨ê³„</label>
          <div class="field-row">
            <select id="stageSelectLeft"></select>
          </div>

          <div id="summaryLeft" class="summary-box" data-i18n="cc.select_hint">
            ì°¨ëŸ‰ê³¼ ë‹¨ê³„ë¥¼ ì„ íƒí•˜ë©´ ìš”ì•½ ì •ë³´ê°€ ì´ê³³ì— í‘œì‹œë©ë‹ˆë‹¤.
          </div>
        </div>

        <div class="panel">
          <div class="side-header">
            <div class="side-title" data-i18n="cc.side_right">ìš°ì¸¡ ì°¨ëŸ‰</div>
            <div class="side-tag" data-i18n="cc.player_b">PLAYER B</div>
          </div>
          <label data-i18n="cc.label_car">ì°¨ëŸ‰ ì„ íƒ</label>
          <div class="field-row">
            <select id="carSelectRight">
              <option value="" data-i18n="cc.opt_select_car">ì°¨ëŸ‰ì„ ì„ íƒí•˜ì„¸ìš”</option>
            </select>
          </div>

          <label style="margin-top:8px;" data-i18n="cc.label_stage">ìš°ì¸¡ ë‹¨ê³„</label>
          <div class="field-row">
            <select id="stageSelectRight"></select>
          </div>

          <div id="summaryRight" class="summary-box" data-i18n="cc.select_hint">
            ì°¨ëŸ‰ê³¼ ë‹¨ê³„ë¥¼ ì„ íƒí•˜ë©´ ìš”ì•½ ì •ë³´ê°€ ì´ê³³ì— í‘œì‹œë©ë‹ˆë‹¤.
          </div>
        </div>
      </section>

      <!-- ê²°ê³¼ -->
      <section class="panel">
        <div class="result-header">
          <div class="result-title" data-i18n="cc.result_title">STAT COMPARISON</div>
          <div id="headlineBadge" class="badge" data-i18n="cc.msg_start">
            ë‘ ì°¨ëŸ‰ê³¼ ë‹¨ê³„ë¥¼ ëª¨ë‘ ì„ íƒí•˜ë©´ ë¹„êµê°€ ì‹œì‘ë©ë‹ˆë‹¤.
          </div>
        </div>
        <div id="tableContainer">
          <div class="empty-state" data-i18n="cc.msg_empty_table">
            ì¢Œ/ìš° ì°¨ëŸ‰ê³¼ ê°ìì˜ ë‹¨ê³„ë¥¼ ëª¨ë‘ ì„ íƒí•˜ë©´, ì—¬ê¸°ì—ì„œ í•´ë‹¹ ë‹¨ê³„ì˜ ìŠ¤í™ì„ ë¹„êµí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
          </div>
        </div>
        <!-- Chart -->
        <div style="max-width:500px; margin:20px auto; display:none;" id="chartContainer">
          <canvas id="radarChart"></canvas>
        </div>
      </section>
    </div>
  </div>

  <!-- ë¹„êµ ë¡œì§ -->
  <script>
    (function () {
      const CLASS_ORDER = { "D": 0, "C": 1, "B": 2, "A": 3, "S": 4 };

      let allCars = [];
      let filteredCars = [];
      let leftSel = { carId: null };
      let rightSel = { carId: null };

      const carSelectLeft = document.getElementById("carSelectLeft");
      const carSelectRight = document.getElementById("carSelectRight");
      const classFilter = document.getElementById("classFilter");
      const searchInput = document.getElementById("searchInput");
      const summaryLeft = document.getElementById("summaryLeft");
      const summaryRight = document.getElementById("summaryRight");
      const headlineBadge = document.getElementById("headlineBadge");
      const tableContainer = document.getElementById("tableContainer");
      const stageSelectLeft = document.getElementById("stageSelectLeft");
      const stageSelectRight = document.getElementById("stageSelectRight");

      // ===== ë‹¨ê³„ ì •ì˜ =====
      const STAGES = [
        { id: "stock", labelKey: "cc.stage_stock" },
        { id: "star1", labelKey: "cc.stage_star1" },
        { id: "star2", labelKey: "cc.stage_star2" },
        { id: "star3", labelKey: "cc.stage_star3" },
        { id: "star4", labelKey: "cc.stage_star4" },
        { id: "star5", labelKey: "cc.stage_star5" },
        { id: "max_wo_epics", labelKey: "cc.stage_max_wo" },
        { id: "gold", labelKey: "cc.stage_gold" }
      ];

      const STAGE_PRIORITY = [
        "gold", "max_wo_epics", "star5", "star4", "star3", "star2", "star1", "stock"
      ];

      async function loadCars() {
        try {
          const res = await fetch("../assets/cars.json");
          const data = await res.json();
          allCars = Array.isArray(data) ? data.slice() : [];

          allCars.sort((a, b) => {
            const ca = CLASS_ORDER[a.class] ?? 99;
            const cb = CLASS_ORDER[b.class] ?? 99;
            if (ca !== cb) return ca - cb;
            return (a.id ?? 0) - (b.id ?? 0);
          });

          filteredCars = allCars.slice();
          populateCarSelects(false);

          // ì²˜ìŒì—” ì•„ë¬´ ì°¨ë„ ì—†ìœ¼ë‹ˆê¹Œ, ë‹¨ê³„ ë“œë¡­ë‹¤ìš´ì€ ë¹„í™œì„±í™” ìƒíƒœë¡œ
          initEmptyStageSelect(stageSelectLeft);
          initEmptyStageSelect(stageSelectRight);
        } catch (e) {
          console.error(e);
          tableContainer.innerHTML =
            `<div class='empty-state' style='color:#fca5a5;'>${I18N.t('cc.err_load')}</div>`;
        }
      }

      function getCarById(id) {
        if (!id) return null;
        return allCars.find(c => String(c.id) === String(id)) || null;
      }

      function getStars(car) {
        if (!car || !Array.isArray(car.stat)) return [];
        const set = new Set();
        car.stat.forEach(s => { if (typeof s.star === "number") set.add(s.star); });
        return Array.from(set).sort((a, b) => a - b);
      }

      function getMaxStar(car) {
        if (!car) return null;
        if (typeof car.max_star === "number") return car.max_star;
        const stars = getStars(car);
        return stars.length ? stars[stars.length - 1] : null;
      }

      function getStat(car, star, type) {
        if (!car || !Array.isArray(car.stat)) return null;
        return car.stat.find(s =>
          s.star === star &&
          (type ? s.type === type : true)
        ) || null;
      }

      // ì„ íƒëœ ë‹¨ê³„ì— ë”°ë¥¸ ë‹¨ì¼ stat
      function getStatForStage(car, stageId) {
        if (!car) return null;
        const maxStar = getMaxStar(car);

        switch (stageId) {
          case "stock":
            return getStat(car, 1, "stock") || null;
          case "star1":
            return getStat(car, 1, "full") || null;
          case "star2":
            return getStat(car, 2, "full") || null;
          case "star3":
            return getStat(car, 3, "full") || null;
          case "star4":
            return getStat(car, 4, "full") || null;
          case "star5":
            return getStat(car, 5, "full") || null;
          case "max_wo_epics":
            if (maxStar == null) return null;
            return getStat(car, maxStar, "max_wo_epics") || null;
          case "gold":
            if (maxStar == null) return null;
            return getStat(car, maxStar, "gold") || null;
          default:
            return null;
        }
      }

      // ===== ë‹¨ê³„ ë“œë¡­ë‹¤ìš´ ê´€ë ¨ =====

      // ì°¨ê°€ ì—†ì„ ë•Œ: ëª¨ë“  ì˜µì…˜ì„ disabledë¡œ ë³´ì—¬ì£¼ê¸°
      function initEmptyStageSelect(selectEl) {
        selectEl.innerHTML = "";
        STAGES.forEach(s => {
          const opt = document.createElement("option");
          opt.value = s.id;
          opt.textContent = I18N.t(s.labelKey) + ` (${I18N.t('cc.req_select')})`;
          opt.disabled = true;
          selectEl.appendChild(opt);
        });
        selectEl.value = "gold";
        selectEl.disabled = true;
      }

      // íŠ¹ì • ì°¨ ê¸°ì¤€ìœ¼ë¡œ, ì‹¤ì œ ì¡´ì¬í•˜ëŠ” ë‹¨ê³„ë§Œ ë‹¤ì‹œ ì±„ìš°ê¸°
      function rebuildStageSelectForCar(selectEl, car) {
        if (!car) {
          initEmptyStageSelect(selectEl);
          return;
        }

        const prev = selectEl.value || "gold";

        const available = STAGES.filter(s => !!getStatForStage(car, s.id));

        // í˜¹ì‹œë¼ë„ ì§„ì§œë¡œ ì•„ë¬´ ìŠ¤íƒ¯ë„ ì—†ëŠ” ì°¨ë¼ë©´ ë³´í˜¸
        if (!available.length) {
          initEmptyStageSelect(selectEl);
          return;
        }

        selectEl.innerHTML = "";
        available.forEach(s => {
          const opt = document.createElement("option");
          opt.value = s.id;
          opt.textContent = I18N.t(s.labelKey);
          selectEl.appendChild(opt);
        });

        // ì´ì „ì— ì„ íƒí–ˆë˜ ë‹¨ê³„ê°€ ì•„ì§ë„ ìœ íš¨í•˜ë©´ ìœ ì§€
        let chosen = available.some(s => s.id === prev) ? prev : null;

        // ì•„ë‹ˆë©´ ìš°ì„ ìˆœìœ„ëŒ€ë¡œ ì œì¼ ì¢‹ì€ ë‹¨ê³„ ì„ íƒ
        if (!chosen) {
          for (const id of STAGE_PRIORITY) {
            if (available.some(s => s.id === id)) {
              chosen = id;
              break;
            }
          }
        }
        if (!chosen) chosen = available[available.length - 1].id;

        selectEl.value = chosen;
        selectEl.disabled = false;
      }

      function updateSummary(side, car) {
        const box = side === "left" ? summaryLeft : summaryRight;
        const stageSelect = side === "left" ? stageSelectLeft : stageSelectRight;
        const stage = STAGES.find(s => s.id === stageSelect.value);

        if (!car) {
          box.textContent = I18N.t('cc.msg_select_both');
          return;
        }
        const stars = getStars(car);
        const minS = stars[0];
        const maxS = stars[stars.length - 1];

        box.innerHTML = `
      <div class="car-chip">
        <span class="cls">[${car.class || "?"}]</span>
        <span>${car.name || "Unknown"}</span>
      </div>
      <div style="margin-top:4px;font-size:12px;color:var(--muted);">
        ${I18N.t('cc.range_stars')}: ${minS ?? "?"}â˜… ~ ${maxS ?? "?"}â˜…<br>
        ${I18N.t('cc.current_stage')}: ${stage ? I18N.t(stage.labelKey) : "-"}
      </div>
    `;
      }

      function populateCarSelects(keepValue = true) {
        function build(selectEl) {
          const prev = keepValue ? selectEl.value : "";
          selectEl.innerHTML = `<option value=''>${I18N.t('cc.opt_select_car')}</option>`;
          filteredCars.forEach(car => {
            const opt = document.createElement("option");
            opt.value = String(car.id);
            opt.textContent = `[${car.class}] ${car.name} (#${car.id})`;
            selectEl.appendChild(opt);
          });
          if (prev) selectEl.value = prev;
        }

        build(carSelectLeft);
        build(carSelectRight);

        if (!getCarById(leftSel.carId)) {
          leftSel.carId = null;
          carSelectLeft.value = "";
          rebuildStageSelectForCar(stageSelectLeft, null);
          updateSummary("left", null);
        } else {
          rebuildStageSelectForCar(stageSelectLeft, getCarById(leftSel.carId));
          updateSummary("left", getCarById(leftSel.carId));
        }

        if (!getCarById(rightSel.carId)) {
          rightSel.carId = null;
          carSelectRight.value = "";
          rebuildStageSelectForCar(stageSelectRight, null);
          updateSummary("right", null);
        } else {
          rebuildStageSelectForCar(stageSelectRight, getCarById(rightSel.carId));
          updateSummary("right", getCarById(rightSel.carId));
        }

        renderTable();
      }

      function applyFilters() {
        const activePill = classFilter.querySelector(".class-pill.active");
        const cls = activePill ? activePill.dataset.class : "ALL";
        const q = (searchInput.value || "").trim().toLowerCase();

        filteredCars = allCars.filter(car => {
          const classOk = (cls === "ALL") || (car.class === cls);
          const text = `${car.name || ""} ${car.id || ""}`.toLowerCase();
          const searchOk = !q || text.includes(q);
          return classOk && searchOk;
        });

        populateCarSelects(true);
      }

      classFilter.addEventListener("click", e => {
        const pill = e.target.closest(".class-pill");
        if (!pill) return;
        classFilter.querySelectorAll(".class-pill").forEach(p => p.classList.remove("active"));
        pill.classList.add("active");
        applyFilters();
      });

      searchInput.addEventListener("input", applyFilters);

      carSelectLeft.addEventListener("change", () => {
        leftSel.carId = carSelectLeft.value || null;
        const car = getCarById(leftSel.carId);
        rebuildStageSelectForCar(stageSelectLeft, car);
        updateSummary("left", car);
        renderTable();
      });

      carSelectRight.addEventListener("change", () => {
        rightSel.carId = carSelectRight.value || null;
        const car = getCarById(rightSel.carId);
        rebuildStageSelectForCar(stageSelectRight, car);
        updateSummary("right", car);
        renderTable();
      });

      stageSelectLeft.addEventListener("change", () => {
        updateSummary("left", getCarById(leftSel.carId));
        renderTable();
      });
      stageSelectRight.addEventListener("change", () => {
        updateSummary("right", getCarById(rightSel.carId));
        renderTable();
      });

      let radarChartInstance = null;
      function renderRadar() {
        const leftId = leftSel.carId;
        const rightId = rightSel.carId;
        const leftCar = getCarById(leftId);
        const rightCar = getCarById(rightId);
        const stageL = stageSelectLeft.value;
        const stageR = stageSelectRight.value;

        const container = document.getElementById('chartContainer');

        if (!leftCar || !rightCar || stageSelectLeft.disabled || stageSelectRight.disabled) {
          if (container) container.style.display = 'none';
          return;
        }
        if (container) container.style.display = 'block';

        const c1 = getStatForStage(leftCar, stageL);
        const c2 = getStatForStage(rightCar, stageR);

        if (!c1 || !c2) return;

        const ctx = document.getElementById('radarChart').getContext('2d');

        // Normalize 0-100 based on typical max values
        const N = (val, max) => Math.min(100, (parseFloat(val || 0) / max) * 100);

        const getData = (s) => {
          const sp = parseFloat(s.speed || 0);
          const ac = parseFloat(s.accel || 0);
          const hn = parseFloat(s.handling || 0);
          const ni = parseFloat(s.nitro || 0);
          return [
            N(sp, 500),
            N(ac, 90),
            N(hn, 100),
            N(ni, 85)
          ];
        };

        const d1 = getData(c1);
        const d2 = getData(c2);

        if (radarChartInstance) radarChartInstance.destroy();

        radarChartInstance = new Chart(ctx, {
          type: 'radar',
          data: {
            labels: [
              I18N.t('cc.stat_speed') || 'Speed',
              I18N.t('cc.stat_accel') || 'Accel',
              I18N.t('cc.stat_handling') || 'Handling',
              I18N.t('cc.stat_nitro') || 'Nitro'
            ],
            datasets: [{
              label: leftCar.name,
              data: d1,
              fill: true,
              backgroundColor: 'rgba(34, 211, 238, 0.2)',
              borderColor: '#22d3ee',
              pointBackgroundColor: '#22d3ee',
              pointBorderColor: '#fff'
            }, {
              label: rightCar.name,
              data: d2,
              fill: true,
              backgroundColor: 'rgba(124, 58, 237, 0.2)',
              borderColor: '#7c3aed',
              pointBackgroundColor: '#7c3aed',
              pointBorderColor: '#fff'
            }]
          },
          options: {
            scales: {
              r: {
                angleLines: { color: 'rgba(255,255,255,0.1)' },
                grid: { color: 'rgba(255,255,255,0.1)' },
                pointLabels: { color: '#9ca3af' },
                suggestedMin: 30,
                suggestedMax: 100,
                ticks: { display: false }
              }
            },
            plugins: {
              legend: { labels: { color: '#9ca3af' } }
            }
          }
        });
      }

      function renderTable() {
        const carL = getCarById(leftSel.carId);
        const carR = getCarById(rightSel.carId);

        const stageIdL = stageSelectLeft.value;
        const stageIdR = stageSelectRight.value;

        if (!carL || !carR || stageSelectLeft.disabled || stageSelectRight.disabled) {
          headlineBadge.textContent = I18N.t('cc.msg_start');
          tableContainer.innerHTML = `
      <div class="empty-state">
        ${I18N.t('cc.msg_empty_table')}
      </div>`;
          return;
        }

        const nameL = carL.name || "Unknown";
        const nameR = carR.name || "Unknown";
        const stageObjL = STAGES.find(s => s.id === stageIdL);
        const stageObjR = STAGES.find(s => s.id === stageIdR);
        const stageLabelL = stageObjL ? I18N.t(stageObjL.labelKey) : stageIdL;
        const stageLabelR = stageObjR ? I18N.t(stageObjR.labelKey) : stageIdR;

        headlineBadge.innerHTML = `
    <span>${nameL}</span>
    <span style="color:var(--muted);margin-inline:4px;">(${stageLabelL})</span>
    <span style="color:var(--muted);margin-inline:4px;">vs</span>
    <span>${nameR}</span>
    <span style="color:var(--muted);margin-left:4px;">(${stageLabelR})</span>
  `;

        const sL = getStatForStage(carL, stageIdL);
        const sR = getStatForStage(carR, stageIdR);

        if (!sL && !sR) {
          tableContainer.innerHTML =
            `<div class='empty-state' style='color:#fca5a5;'>${I18N.t('cc.err_no_data')}</div>`;
          return;
        }

        const STAT_ROWS = [
          { key: "rank", label: I18N.t('cc.stat_rank'), fmt: v => v?.toLocaleString("ko-KR") ?? "â€”", type: "int" },
          { key: "top_speed", label: I18N.t('cc.stat_speed'), fmt: v => v != null ? v.toFixed(1) : "â€”", type: "float" },
          { key: "accel", label: I18N.t('cc.stat_accel'), fmt: v => v != null ? v.toFixed(2) : "â€”", type: "float" },
          { key: "handling", label: I18N.t('cc.stat_handling'), fmt: v => v != null ? v.toFixed(2) : "â€”", type: "float" },
          { key: "nitro", label: I18N.t('cc.stat_nitro'), fmt: v => v != null ? v.toFixed(2) : "â€”", type: "float" }
        ];

        function formatDiff(row, diff) {
          if (diff == null || Number.isNaN(diff)) return "â€”";
          if (row.type === "int") {
            const sign = diff > 0 ? "+" : diff < 0 ? "âˆ’" : "";
            const val = Math.abs(Math.round(diff)).toLocaleString("ko-KR");
            return sign + val;
          } else {
            const sign = diff > 0 ? "+" : diff < 0 ? "âˆ’" : "";
            const val = Math.abs(diff).toFixed(2);
            return sign + val;
          }
        }

        let html = `
      <table>
        <thead>
          <tr>
            <th>${I18N.t('cc.th_stat')}</th>
            <th>${nameL}<br><span style="font-size:11px;color:var(--muted);">${stageLabelL}</span></th>
            <th>${I18N.t('cc.th_diff')}</th>
            <th>${nameR}<br><span style="font-size:11px;color:var(--muted);">${stageLabelR}</span></th>
          </tr>
        </thead>
        <tbody>
    `;

        STAT_ROWS.forEach(row => {
          const vL = sL ? sL[row.key] : null;
          const vR = sR ? sR[row.key] : null;

          const bothNum =
            typeof vL === "number" && typeof vR === "number" &&
            !Number.isNaN(vL) && !Number.isNaN(vR);

          let clsL = "";
          let clsR = "";
          let indL = "";
          let indR = "";
          let styleL = "";
          let styleR = "";
          let diffVal = null;

          if (bothNum) {
            diffVal = vL - vR;
            const maxAbs = Math.max(Math.abs(vL), Math.abs(vR), 0.0001);
            const rel = Math.min(1, Math.abs(diffVal) / (maxAbs * 0.4)); // 40% ì°¨ì´ ì´ìƒì´ë©´ í’€ê°•
            const pct = 10 + Math.round(50 * rel); // 10% ~ 60%

            if (vL > vR) {
              clsL = "value-better";
              clsR = "value-worse";
              indL = `<span class="indicator up">â–²</span>`;
              indR = `<span class="indicator down">â–¼</span>`;
              styleL = `background:linear-gradient(90deg,color-mix(in srgb,var(--accent) ${pct}%, transparent), transparent);`;
            } else if (vR > vL) {
              clsR = "value-better";
              clsL = "value-worse";
              indR = `<span class="indicator up">â–²</span>`;
              indL = `<span class="indicator down">â–¼</span>`;
              styleR = `background:linear-gradient(270deg,color-mix(in srgb,var(--accent) ${pct}%, transparent), transparent);`;
            }
          }

          const diffText = formatDiff(row, diffVal);
          let diffClass = "diff-chip zero";
          let dirSymbol = "";

          if (bothNum) {
            if (diffVal > 0) {
              diffClass = "diff-chip positive";
              dirSymbol = "L>";
            } else if (diffVal < 0) {
              diffClass = "diff-chip negative";
              dirSymbol = "R>";
            }
          }

          html += `
      <tr>
        <th>${row.label}</th>
        <td class="${clsL}" style="${styleL}">${row.fmt(vL)}${indL}</td>
        <td class="diff-cell">
          <div class="${diffClass}">
            <span class="dir">${dirSymbol}</span>
            <span>${diffText}</span>
          </div>
        </td>
        <td class="${clsR}" style="${styleR}">${row.fmt(vR)}${indR}</td>
      </tr>
    `;
        });

        html += "</tbody></table>";
        tableContainer.innerHTML = html;
        setTimeout(renderRadar, 0);
      }

      loadCars();
    })();
  </script>




</body>

</html>