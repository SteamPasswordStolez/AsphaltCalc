<!doctype html>
<html lang="ko">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="icon" href="../assets/favicon.png">
  <title>Car Hunt â€” ìë™ì°¨ ì‚¬ëƒ¥ ì‹œë®¬ë ˆì´í„°</title>
  <meta name="color-scheme" content="light dark" />

  <link rel="stylesheet" href="../assets/style.css">
  <link rel="stylesheet" href="../assets/themes.css">

  <script>window.SIM_ID = "car-hunt";</script>
  <script src="../assets/theme-init.js"></script>
  <link rel="stylesheet" href="../assets/theme-adapter.css">

  <script src="../assets/lang.js"></script>
  <script src="../assets/i18n.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body>
  <div class="container mobile-full">
    <div class="header">
      <div class="brand">
        <div class="logo"></div>
        <h1><span data-i18n="ch.title">ìë™ì°¨ ì‚¬ëƒ¥ ì‹œë®¬ë ˆì´í„°</span></h1>
      </div>
      <div class="toolbar">
        <a class="btn" href="../index.html" data-i18n="common.back">â† í—ˆë¸Œ</a>
        <button id="btnReload" onclick="location.reload()" class="btn">
          <span data-i18n="common.reload">ìƒˆë¡œê³ ì¹¨</span>
        </button>
      </div>
    </div>

    <!-- Mode Tabs -->
    <div style="margin-bottom:24px; display:flex; gap:12px;">
      <button class="tab active" data-tab="goal" data-i18n="ch.tab_goal">ğŸ¯ ëª©í‘œ ê¸°ì¤€</button>
      <button class="tab" data-tab="time" data-i18n="ch.tab_time">â±ï¸ ì‹œê°„ ê¸°ì¤€</button>
    </div>

    <!-- Main Grid -->
    <div class="grid-responsive cols-3" style="align-items:start">

      <!-- Input Panel -->
      <div class="panel-col" style="grid-column: span 1;">
        <div class="card">
          <div class="body">
            <h2 class="title" data-i18n="ch.input">ì…ë ¥ê°’</h2>

            <div class="form-group">
              <label><span data-i18n="ch.auto_rate">í‹°ì¼“ ìë™ì¶©ì „ ì†ë„ (%)</span></label>
              <input id="autoRate" type="number" min="10" step="1" value="100">
            </div>

            <div class="form-group">
              <label><span data-i18n="ch.charge_method">í‹°ì¼“ ì¶©ì „ ë°©ì‹</span></label>
              <select id="chargeMethod">
                <option value="token" data-i18n="ch.charge_token">í† í°</option>
                <option value="ad" data-i18n="ch.charge_ad">ê´‘ê³ </option>
              </select>
            </div>

            <div class="grid-responsive cols-2" style="gap:12px; margin-bottom:16px;">
              <div class="form-group" style="margin:0">
                <label><span data-i18n="ch.ticket_cost">ë¹„ìš©(ì¥)</span></label>
                <input id="ticketCost" type="number" min="1" value="1">
              </div>
              <div class="form-group" style="margin:0">
                <label class="active-label">
                  <span data-i18n="ch.lp_free">LPë³´ìœ </span>
                  <input id="lpFree" type="checkbox">
                </label>
              </div>
            </div>

            <div class="form-group">
              <label>
                <span data-i18n="ch.mobile_srv">Android/iOS ì„œë²„?</span>
                <input id="mobileSrv" type="checkbox" checked>
              </label>
              <div class="hint" data-i18n="ch.ad_sec">ì²´í¬ ì‹œ ê´‘ê³  40ì´ˆ ê³ ì •</div>
            </div>

            <div class="form-group" id="adSecGroup">
              <label data-i18n="ch.ad_custom_sec">ê´‘ê³  ì‹œê°„(ì´ˆ)</label>
              <input id="adSec" type="number" value="30">
            </div>

            <div class="grid-responsive cols-2" style="gap:12px; margin-bottom:16px;">
              <div class="form-group" style="margin:0">
                <label data-i18n="ch.ticket_ad_max">í‹°ì¼“ê´‘ê³ (íšŒ)</label>
                <input id="ticketAdMax" type="number" value="40">
              </div>
              <div class="form-group" style="margin:0">
                <label data-i18n="ch.credit_ad_max">í¬ë ˆë”§ê´‘ê³ (íšŒ)</label>
                <input id="creditAdMax" type="number" value="40">
              </div>
            </div>
            <div class="form-group">
              <label>
                <span data-i18n="ch.credit_ad">í¬ë ˆë”§ ê´‘ê³  í¬í•¨</span>
                <input id="creditAd" type="checkbox">
              </label>
            </div>

            <div class="grid-responsive cols-2" style="gap:12px; margin-bottom:16px;">
              <div class="form-group" style="margin:0">
                <label data-i18n="ch.map_sec">í”Œë ˆì´(ì´ˆ)</label>
                <input id="mapSec" type="number" value="38">
              </div>
              <div class="form-group" style="margin:0">
                <label data-i18n="ch.lobby_sec">ë¡œë¹„(ì´ˆ)</label>
                <input id="lobbySec" type="number" value="20">
              </div>
            </div>

            <div class="form-group">
              <label data-i18n="ch.packs">íŒë‹¹ íŒ© ê°œìˆ˜</label>
              <input id="packs" type="number" value="3">
            </div>

            <div class="actions">
              <button id="run" class="primary" style="width:100%" data-i18n="ch.run_sim">ì‹œë®¬ë ˆì´ì…˜ ì‹¤í–‰</button>
              <button id="reset" class="sub" style="width:100%" data-i18n="ch.restore_default">ê¸°ë³¸ê°’ ë³µì›</button>
            </div>

          </div>
        </div>
      </div>

      <!-- Settings & Result Panel -->
      <div class="panel-col" style="grid-column: span 2;">

        <!-- Goal Settings -->
        <div id="tab-goal" class="card">
          <div class="body">
            <h2 class="title" data-i18n="ch.goal_setting">ëª©í‘œ ì„¤ì •</h2>

            <div class="grid-responsive cols-2" style="gap:24px;">
              <div>
                <div class="form-group">
                  <label data-i18n="ch.goal_type">ëª©í‘œ ìœ í˜•</label>
                  <select id="goalType">
                    <option value="bp" data-i18n="ch.goal_bp">ì²­ì‚¬ì§„ (Blueprints)</option>
                    <option value="sp" data-i18n="ch.goal_sp">íŠ¹ìˆ˜ë¶€í’ˆ (Import Parts)</option>
                  </select>
                </div>
                <div class="form-group">
                  <label data-i18n="ch.target_bp" id="lblTargetBP">ëª©í‘œ ì²­ì‚¬ì§„ ê°œìˆ˜</label>
                  <input id="targetBP" type="number" value="300">
                  <label data-i18n="ch.target_sp" id="lblTargetSP" style="display:none">ëª©í‘œ íŠ¹ìˆ˜ë¶€í’ˆ ê°œìˆ˜</label>
                  <input id="targetSP" type="number" value="16" style="display:none">
                </div>
              </div>
              <div>
                <div class="form-group">
                  <label data-i18n="ch.bp_rate">ë“œë í™•ë¥  (0~1)</label>
                  <input id="pBP" type="number" step="0.001" value="0.08">
                  <input id="pSP" type="number" step="0.001" value="0.04" style="display:none">
                </div>
                <div class="form-group">
                  <label data-i18n="ch.bp_per_drop">ë“œëë‹¹ íšë“ëŸ‰</label>
                  <input id="bpPerDrop" type="number" value="1">
                </div>
              </div>
            </div>

            <!-- Segments -->
            <div style="margin-top:24px">
              <div class="form-group">
                <label>
                  <span class="pill" data-i18n="ch.use_segments">êµ¬ê°„ë³„ í™•ë¥  ì‚¬ìš©</span>
                  <input id="useSegments" type="checkbox">
                </label>
              </div>
              <div id="segTableWrap" style="opacity:0.5; transition:0.3s">
                <table class="data-table">
                  <thead>
                    <tr>
                      <th data-i18n="ch.seg_start">ì‹œì‘</th>
                      <th data-i18n="ch.seg_end">ë</th>
                      <th data-i18n="ch.seg_prob">í™•ë¥ </th>
                      <th></th>
                    </tr>
                  </thead>
                  <tbody id="segTbody"></tbody>
                </table>
                <button id="addSeg" class="btn sub" style="margin-top:8px; font-size:12px;">+ êµ¬ê°„ ì¶”ê°€</button>
                <button id="resetSeg" class="btn sub" style="margin-top:8px; font-size:12px;">ì´ˆê¸°í™”</button>
              </div>
            </div>
          </div>
        </div>

        <!-- Time Settings (Hidden by default) -->
        <div id="tab-time" class="card hidden">
          <div class="body">
            <h2 class="title" data-i18n="ch.time_input">ì‹œê°„ ê¸°ì¤€ ì„¤ì •</h2>
            <div class="grid-responsive cols-3">
              <div class="form-group">
                <label data-i18n="ch.time_h">ì‹œê°„(Hour)</label>
                <input id="timeH" type="number" value="1">
              </div>
              <div class="form-group">
                <label data-i18n="ch.time_m">ë¶„(Min)</label>
                <input id="timeM" type="number" value="0">
              </div>
              <div class="form-group">
                <label data-i18n="ch.time_s">ì´ˆ(Sec)</label>
                <input id="timeS" type="number" value="0">
              </div>
            </div>

            <div class="form-group" style="display:none"> <!-- Hidden as we show both results -->
              <label data-i18n="ch.result_type">ê²°ê³¼ ì´ˆì </label>
              <select id="timeGoalType">
                <option value="both" data-i18n="ch.goal_both">ì²­ì‚¬ì§„ + íŠ¹ìˆ˜ë¶€í’ˆ</option>
              </select>
            </div>

            <div class="grid-responsive cols-2" style="margin-top:20px; gap:20px;">
              <div>
                <label class="subtitle" data-i18n="ch.goal_bp">ì²­ì‚¬ì§„ í™•ë¥ </label>
                <input id="pBP_time" type="number" step="0.001" value="0.08" class="input" style="margin-bottom:8px">
                <label style="display:flex;align-items:center;gap:8px;font-size:13px">
                  <input id="useSegmentsBP_time" type="checkbox"> <span data-i18n="ch.use_segments">êµ¬ê°„ ì‚¬ìš©</span>
                </label>
                <table class="data-table" id="segTableBP_time" style="margin-top:8px">
                  <tbody id="segTbodyBP_time"></tbody>
                </table>
                <button id="addSegBP_time" class="btn sub" style="font-size:11px; margin-top:4px">+ ì¶”ê°€</button>
              </div>
              <div>
                <label class="subtitle" data-i18n="ch.goal_sp">íŠ¹ìˆ˜ë¶€í’ˆ í™•ë¥ </label>
                <input id="pSP_time" type="number" step="0.001" value="0.04" class="input" style="margin-bottom:8px">
                <label style="display:flex;align-items:center;gap:8px;font-size:13px">
                  <input id="useSegmentsSP_time" type="checkbox"> <span data-i18n="ch.use_segments">êµ¬ê°„ ì‚¬ìš©</span>
                </label>
                <table class="data-table" id="segTableSP_time" style="margin-top:8px">
                  <tbody id="segTbodySP_time"></tbody>
                </table>
                <button id="addSegSP_time" class="btn sub" style="font-size:11px; margin-top:4px">+ ì¶”ê°€</button>
              </div>
            </div>
          </div>
        </div>

        <!-- Result Area -->
        <div class="card" style="margin-top:24px; min-height:400px">
          <div class="body">
            <h2 class="title" data-i18n="ch.result">ì‹œë®¬ë ˆì´ì…˜ ê²°ê³¼</h2>
            <div class="grid-responsive cols-3" id="resultBox">
              <div class="kpi-box">
                <div class="label" data-i18n="ch.res_time">ì´ ì†Œìš” ì‹œê°„</div>
                <div class="value" id="timeStr">-</div>
              </div>
              <div class="kpi-box">
                <div class="label" data-i18n="ch.res_tokens">ì‚¬ìš© í† í°</div>
                <div class="value" id="tokensUsed">-</div>
              </div>
              <div class="kpi-box">
                <div class="label" data-i18n="ch.res_bp">íšë“ ì²­ì‚¬ì§„</div>
                <div class="value" id="bpGained">-</div>
              </div>
              <div class="kpi-box">
                <div class="label" data-i18n="ch.res_sp">íšë“ íŠ¹ìˆ˜ë¶€í’ˆ</div>
                <div class="value" id="spGained">-</div>
              </div>
              <div class="kpi-box">
                <div class="label">5% ~ 95% êµ¬ê°„</div>
                <div class="value" id="p595Time" style="font-size:18px">-</div>
              </div>
            </div>

            <h3 class="subtitle" style="margin-top:32px" data-i18n="ch.histogram">ë¶„í¬ ì°¨íŠ¸</h3>
            <div class="viewer" style="height:320px; background:transparent; border:none; box-shadow:none">
              <canvas id="hist"></canvas>
            </div>

            <div id="paramsEcho" class="meta mono" style="margin-top:12px; font-size:11px; word-break:break-all"></div>
          </div>
        </div>

        <!-- Presets (Simplified for now) -->
        <div class="card" style="margin-top:24px">
          <div class="body">
            <h3 class="subtitle">í”„ë¦¬ì…‹ (Beta)</h3>
            <div style="font-size:13px; color:var(--muted)">í”„ë¦¬ì…‹ ê¸°ëŠ¥ì€ í˜„ì¬ ê°œì„  ì¤‘ì…ë‹ˆë‹¤.</div>
          </div>
        </div>

      </div>
    </div>
  </div>

  <script>
    (function () {
      const $ = (id) => document.getElementById(id);
      const safeFloat = (v, d = 0) => { const f = parseFloat(v); return isNaN(f) ? d : f; };
      const safeInt = (v, d = 0) => { const i = parseInt(v, 10); return isNaN(i) ? d : i; };

      // --- Tabs & UI Logic ---
      const tabBtns = document.querySelectorAll('.tab');
      tabBtns.forEach(btn => btn.addEventListener('click', () => {
        tabBtns.forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        const t = btn.dataset.tab;
        $('tab-goal').classList.toggle('hidden', t !== "goal");
        $('tab-time').classList.toggle('hidden', t !== "time");
        updateEnables();
      }));

      // --- Segments ---
      function createSegRow(start, end, p) {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td><input type="number" class="table-input seg-start" value="${start}" style="width:50px"></td>
                         <td><input type="number" class="table-input seg-end" value="${end}" style="width:50px"></td>
                         <td><input type="number" step="0.001" class="table-input seg-p" value="${p}" style="width:60px"></td>
                         <td><button class="btn warn seg-del" style="padding:4px 8px; font-size:10px">Ã—</button></td>`;
        tr.querySelector('.seg-del').addEventListener('click', () => tr.remove());
        return tr;
      }
      function loadSegDefault() {
        const tb = $('segTbody'); tb.innerHTML = '';
        tb.appendChild(createSegRow(0, 120, 0.08));
        tb.appendChild(createSegRow(121, 150, 0.05));
        tb.appendChild(createSegRow(151, 9999, 0.03));

        $('segTbodyBP_time').innerHTML = '';
        $('segTbodyBP_time').appendChild(createSegRow(0, 9999, 0.08));
        $('segTbodySP_time').innerHTML = '';
        $('segTbodySP_time').appendChild(createSegRow(0, 9999, 0.04));
      }
      $('addSeg').addEventListener('click', () => $('segTbody').appendChild(createSegRow(0, 9999, 0.08)));
      $('resetSeg').addEventListener('click', loadSegDefault);
      $('addSegBP_time').addEventListener('click', () => $('segTbodyBP_time').appendChild(createSegRow(0, 9999, 0.08)));
      $('addSegSP_time').addEventListener('click', () => $('segTbodySP_time').appendChild(createSegRow(0, 9999, 0.04)));
      loadSegDefault(); // Init

      // --- Enables ---
      function updateEnables() {
        const isBP = $('goalType').value === 'bp';
        $('lblTargetBP').style.display = isBP ? 'block' : 'none'; $('targetBP').style.display = isBP ? 'block' : 'none';
        $('lblTargetSP').style.display = !isBP ? 'block' : 'none'; $('targetSP').style.display = !isBP ? 'block' : 'none';
        $('pBP').style.display = isBP ? 'block' : 'none';
        $('pSP').style.display = !isBP ? 'block' : 'none';

        const segOn = $('useSegments').checked && isBP;
        $('segTableWrap').style.opacity = segOn ? 1 : 0.4;
        $('segTableWrap').style.pointerEvents = segOn ? 'auto' : 'none';

        const mobile = $('mobileSrv').checked;
        $('adSecGroup').style.opacity = mobile ? 0.5 : 1;
        $('adSec').disabled = mobile;
        if (mobile) $('adSec').value = 40;

        const method = $('chargeMethod').value;
        $('ticketAdMax').disabled = method !== 'ad';
      }
      ['goalType', 'chargeMethod', 'mobileSrv', 'useSegments'].forEach(id => {
        const el = $(id); if (el) el.addEventListener('change', updateEnables);
      });
      updateEnables();

      // --- Simulation Core ---
      function getProb(count, cfg, type) {
        // Flatten configs
        let useSeg = false, tableId = '';
        let defaultP = 0;
        if (cfg.mode === 'goal') {
          if (type === 'bp' && cfg.useSegments && cfg.goalType === 'bp') { useSeg = true; tableId = 'segTbody'; }
          defaultP = (type === 'bp') ? cfg.pBP : cfg.pSP;
        } else {
          if (type === 'bp' && cfg.useSegmentsBP_time) { useSeg = true; tableId = 'segTbodyBP_time'; }
          if (type === 'sp' && cfg.useSegmentsSP_time) { useSeg = true; tableId = 'segTbodySP_time'; }
          defaultP = (type === 'bp') ? cfg.pBP_time : cfg.pSP_time;
        }

        if (useSeg && tableId) {
          const rows = document.querySelectorAll('#' + tableId + ' tr');
          for (let r of rows) {
            const s = safeFloat(r.querySelector('.seg-start').value);
            const e = safeFloat(r.querySelector('.seg-end').value);
            if (count >= s && count <= e) return safeFloat(r.querySelector('.seg-p').value);
          }
        }
        return defaultP;
      }

      function runOneSim(cfg) {
        let time = 0;
        let tickets = 10;
        let autoTimer = 0;
        const MAX_TICKETS = cfg.lpFree ? 15 : 10;
        const autoPeriod = (10000 / cfg.autoRate) * 60; // seconds per ticket

        let bp = 0, sp = 0;
        let tokensUsed = 0, ticketAdsUsed = 0, creditAdsUsed = 0;

        const isDone = () => {
          if (cfg.mode === 'goal') {
            if (cfg.goalType === 'bp') return bp >= cfg.targetBP;
            else return sp >= cfg.targetSP;
          } else return time >= cfg.targetTimeSec;
        };

        while (!isDone()) {
          // 1. Refill if needed
          if (tickets < cfg.ticketCost) {
            // Try Use Ad ticket overrides
            let refilled = false;
            // Policy: Use Ads if available, then Tokens
            if (cfg.chargeMethod === 'ad' && ticketAdsUsed < cfg.ticketAdMax) {
              ticketAdsUsed++; // Assume 1 ad = 1 ticket (simplified as user requested tickets per race vs refill)
              // Actually, usually users use "Refill All with Tokens" or "Watch Ad for 1 ticket".
              // If ticketAdMax is high, maybe they watch multiple ads?
              // Let's assume 1 Ad = 1 Ticket for now.
              time += cfg.adSec;
              tickets++;
              refilled = true;
            } else if (cfg.chargeMethod !== 'ad' || ticketAdsUsed >= cfg.ticketAdMax) {
              // Token Refill? Only if we assume user wants to spend tokens.
              // If chargeMethod is 'token', always spend.
              // If 'ad' and ran out, spend tokens? Default to yes to avoid infinite loops if no regen.
              // Assume refill to MAX. Cost = 50 roughly?
              // Let's charge 5 tokens per ticket missing from MAX.
              const needed = MAX_TICKETS - tickets;
              tokensUsed += needed * 5; // approx 5 tokens/ticket
              tickets = MAX_TICKETS;
              refilled = true;
            }
          }

          // 2. Race
          if (tickets >= cfg.ticketCost) {
            tickets -= cfg.ticketCost;
            time += cfg.mapSec + cfg.lobbySec;

            // Drops
            for (let i = 0; i < cfg.packs; i++) {
              const r = Math.random();
              const pB = getProb(bp, cfg, 'bp');
              const pS = getProb(sp, cfg, 'sp');
              if (r < pB) bp += cfg.bpPerDrop;
              else if (r < pB + pS) sp++;
            }

            // Credit Ads
            if (cfg.creditAd && creditAdsUsed < cfg.creditAdMax) {
              creditAdsUsed++;
              time += cfg.adSec;
            }

            // Regen during race time
            const raceTime = cfg.mapSec + cfg.lobbySec + (cfg.creditAd ? cfg.adSec : 0);
            if (tickets < MAX_TICKETS && autoTimer > 0) {
              autoTimer -= raceTime;
              while (autoTimer <= 0) {
                if (tickets < MAX_TICKETS) { tickets++; autoTimer += autoPeriod; }
                else { autoTimer = 0; break; }
              }
            } else if (tickets < MAX_TICKETS && autoTimer <= 0) {
              autoTimer = autoPeriod;
              // consume time? no, raceTime passed.
            }

          } else {
            // Wait for regen (shouldn't happen with token refill, but just in case)
            time += autoPeriod;
            tickets++;
          }
        }
        return { time, tokensUsed, bp, sp };
      }

      function run() {
        const cfg = {
          mode: $('tab-goal').classList.contains('hidden') ? 'time' : 'goal',
          autoRate: safeFloat($('autoRate').value, 100),
          chargeMethod: $('chargeMethod').value,
          ticketCost: safeInt($('ticketCost').value, 1),
          lpFree: $('lpFree').checked,
          mobileSrv: $('mobileSrv').checked,
          adSec: safeInt($('adSec').value, 30),
          ticketAdMax: safeInt($('ticketAdMax').value, 0),
          creditAd: $('creditAd').checked,
          creditAdMax: safeInt($('creditAdMax').value, 0),
          mapSec: safeFloat($('mapSec').value, 38),
          lobbySec: safeFloat($('lobbySec').value, 20),
          packs: safeInt($('packs').value, 3),

          goalType: $('goalType').value,
          targetBP: safeInt($('targetBP').value, 300),
          targetSP: safeInt($('targetSP').value, 16),
          pBP: safeFloat($('pBP').value, 0.08),
          pSP: safeFloat($('pSP').value, 0.04),
          bpPerDrop: safeInt($('bpPerDrop').value, 1),
          useSegments: $('useSegments').checked,

          targetTimeSec: safeInt($('timeH').value) * 3600 + safeInt($('timeM').value) * 60 + safeInt($('timeS').value),
          pBP_time: safeFloat($('pBP_time').value, 0.08),
          pSP_time: safeFloat($('pSP_time').value, 0.04),
          useSegmentsBP_time: $('useSegmentsBP_time').checked,
          useSegmentsSP_time: $('useSegmentsSP_time').checked,
        };

        const N = 1000;
        const results = [];
        const t0 = performance.now();
        for (let i = 0; i < N; i++) results.push(runOneSim(cfg));
        const t1 = performance.now();

        // Stats
        const sumFn = (key) => results.reduce((a, b) => a + b[key], 0);
        const avgTime = sumFn('time') / N;
        const avgTokens = sumFn('tokensUsed') / N;
        const avgBP = sumFn('bp') / N;
        const avgSP = sumFn('sp') / N;

        results.sort((a, b) => cfg.mode === 'goal' ? a.time - b.time : a.bp - b.bp);
        const p05 = results[Math.floor(N * 0.05)];
        const p95 = results[Math.floor(N * 0.95)];

        // Display
        const fmtT = (s) => {
          const h = Math.floor(s / 3600); const m = Math.floor((s % 3600) / 60);
          return `${h}ì‹œê°„ ${m}ë¶„`;
        };

        $('timeStr').innerText = fmtT(avgTime);
        $('tokensUsed').innerText = Math.round(avgTokens);
        $('bpGained').innerText = avgBP.toFixed(1);
        $('spGained').innerText = avgSP.toFixed(1);

        const rngStr = cfg.mode === 'goal' ? `${fmtT(p05.time)} ~ ${fmtT(p95.time)}` : `${Math.floor(p05.bp)} ~ ${Math.floor(p95.bp)} BP`;
        $('p595Time').innerText = rngStr;

        $('paramsEcho').innerText = `Sim Info: ${N} runs in ${(t1 - t0).toFixed(0)}ms.`;

        drawChart(results, cfg.mode);
      }

      let chartCtx = null;
      function drawChart(results, mode) {
        if (chartCtx) chartCtx.destroy();
        const vals = results.map(r => mode === 'goal' ? r.time / 3600 : r.bp);
        const min = Math.min(...vals), max = Math.max(...vals);
        const bins = 20, step = (max - min) / bins || 1;
        const counts = new Array(bins).fill(0);
        vals.forEach(v => {
          let idx = Math.floor((v - min) / step); if (idx >= bins) idx = bins - 1;
          counts[idx]++;
        });
        const labels = counts.map((_, i) => {
          const s = min + i * step; const e = s + step;
          return mode === 'goal' ? `${s.toFixed(1)}` : `${Math.floor(s)}`;
        });

        chartCtx = new Chart($('hist'), {
          type: 'bar',
          data: {
            labels,
            datasets: [{
              label: 'Frequency',
              data: counts,
              backgroundColor: 'rgba(34, 211, 238, 0.4)',
              borderColor: '#22d3ee',
              borderWidth: 1
            }]
          },
          options: {
            responsive: true, maintainAspectRatio: false,
            plugins: { legend: { display: false } },
            scales: { x: { ticks: { color: '#94a3b8' } }, y: { display: false } }
          }
        });
      }

      $('run').addEventListener('click', run);
      $('reset').addEventListener('click', () => location.reload()); // Simple reset
    })();
  </script>
</body>

</html>