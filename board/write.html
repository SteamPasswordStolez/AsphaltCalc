<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ê¸€ ì‘ì„±/ìˆ˜ì • â€” AsphaltCalc ê²Œì‹œíŒ</title>
  <meta name="color-scheme" content="light dark" />
  <link rel="icon" href="../assets/favicon.png">
  <link rel="stylesheet" href="../assets/themes.css">
  <link rel="stylesheet" href="../assets/theme-adapter.css">
  <style>
    *{box-sizing:border-box;}
    body{
      margin:0;
      font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Apple SD Gothic Neo,Roboto,Noto Sans KR,Arial;
      background:var(--bg);
      color:var(--ink);
    }
    .wrap{
      max-width:720px;
      margin:32px auto 40px;
      padding:0 16px;
    }
    h1{
      margin:0 0 6px;
      font-size:24px;
      font-weight:800;
      letter-spacing:.02em;
    }
    .sub{
      margin:0 0 16px;
      font-size:13px;
      color:var(--muted);
    }
    .card{
      border-radius:18px;
      padding:18px 20px 20px;
      background:var(--panel);
      box-shadow:0 18px 45px rgba(0,0,0,.75);
    }
    .info{
      font-size:13px;
      color:var(--muted);
      margin-bottom:8px;
    }
    label{
      display:block;
      font-size:13px;
      margin:10px 0 4px;
    }
    input[type="text"]{
      width:100%;
      padding:8px 10px;
      font-size:14px;
      border-radius:8px;
      border:1px solid var(--control-border);
      background:var(--control-bg);
      color:var(--ink);
    }
    input[type="text"]:focus{
      outline:none;
      border-color:var(--accent);
      box-shadow:0 0 0 1px var(--accent);
    }
    textarea{
      width:100%;
      min-height:220px;
      padding:10px 11px;
      font-size:13px;
      line-height:1.6;
      resize:vertical;
      font-family:ui-monospace,Menlo,Consolas,monospace;
      border-radius:10px;
      border:1px solid var(--control-border);
      background:var(--control-bg);
      color:var(--ink);
    }
    textarea:focus{
      outline:none;
      border-color:var(--accent);
      box-shadow:0 0 0 1px var(--accent);
    }
    .btn-row{
      display:flex;
      justify-content:space-between;
      gap:8px;
      margin-top:14px;
      flex-wrap:wrap;
    }
    .btn{
      padding:7px 13px;
      border-radius:999px;
      border:1px solid var(--border);
      background:var(--chip-bg);
      color:var(--ink);
      font-size:13px;
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:6px;
    }
    .btn.primary{
      border-color:var(--accent);
      background:linear-gradient(135deg,var(--accent),var(--accent2));
      color:#fff;
    }
    .btn:disabled{
      opacity:.6;
      cursor:default;
    }
    .msg{
      font-size:13px;
      margin-top:8px;
      min-height:18px;
      color:var(--danger);
    }
    a{
      color:var(--accent);
      text-decoration:none;
    }
    a:hover{
      text-decoration:underline;
    }
    .toolbar{
      display:flex;
      flex-wrap:wrap;
      gap:6px;
      padding:6px 8px;
      margin-bottom:6px;
      border-radius:10px;
      border:1px solid var(--border);
      background:var(--panelSoft);
    }
    .tool-btn{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      padding:5px 10px;
      border-radius:999px;
      border:1px solid var(--border);
      background:var(--chip-bg);
      color:var(--ink);
      font-size:12px;
      cursor:pointer;
      gap:4px;
    }
    .tool-btn.accent{
      border-color:var(--accent);
      background:linear-gradient(135deg,var(--accent),var(--accent2));
      color:#fff;
    }
  </style>
</head>
<body>
  <div class="wrap">
    <h1 id="pageTitle">ìƒˆ ê¸€ ì‘ì„±</h1>
    <p class="sub" id="pageSub">ì´ë©”ì¼ ì¸ì¦ + ê¸€ì“°ê¸° ê¶Œí•œì´ ìˆëŠ” ê³„ì •ë§Œ ì‹¤ì œë¡œ ê¸€ì„ ì €ì¥í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>

    <div class="card">
      <div id="userInfo" class="info">ë¡œê·¸ì¸ ë° ê¶Œí•œ í™•ì¸ ì¤‘â€¦</div>
      <div id="guardMsg" class="info"></div>

      <div id="formWrap" style="display:none;">
        <label for="title">ì œëª©</label>
        <input id="title" type="text" maxlength="80" />

        <label for="content">ë‚´ìš©</label>
        <div class="toolbar" aria-label="ë§ˆí¬ë‹¤ìš´ ë„êµ¬">
          <button type="button" class="tool-btn" data-md="bold">êµµê²Œ</button>
          <button type="button" class="tool-btn" data-md="italic">ê¸°ìš¸ì„</button>
          <button type="button" class="tool-btn" data-md="h2">ì œëª©</button>
          <button type="button" class="tool-btn" data-md="list">ëª©ë¡</button>
          <button type="button" class="tool-btn" data-md="link">ë§í¬</button>
          <button type="button" class="tool-btn" data-md="code">ì½”ë“œë¸”ëŸ­</button>
          <button type="button" class="tool-btn accent" data-md="img-url">ğŸ–¼ ì´ë¯¸ì§€ ë§í¬</button>
          <button type="button" class="tool-btn accent" data-md="video-url">ğŸ¬ ë™ì˜ìƒ ë§í¬</button>
        </div>
        <textarea id="content" maxlength="8000" placeholder="ë§ˆí¬ë‹¤ìš´ì„ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. (êµµê²Œ, ì œëª©, ëª©ë¡, ë§í¬, ì½”ë“œë¸”ëŸ­, ì´ë¯¸ì§€, ë™ì˜ìƒ ë“±)"></textarea>

        <div class="btn-row">
          <button id="backBtn" class="btn" type="button">â† ëª©ë¡ìœ¼ë¡œ</button>
          <button id="submitBtn" class="btn primary" type="button">ê²Œì‹œ</button>
        </div>

        <div id="msg" class="msg"></div>
      </div>

      <div class="info" style="margin-top:12px;font-size:12px;">
        <a href="./index.html">â† ê²Œì‹œíŒìœ¼ë¡œ ëŒì•„ê°€ê¸°</a>
      </div>
    </div>
  </div>

<script>
(function(){
  var GKEY = 'simhub_theme_global';
  function resolveSystem(theme){
    if (theme === 'system') {
      var mq = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)');
      return (mq && mq.matches) ? 'dark' : 'light';
    }
    return theme || 'asphalt';
  }
  function currentTheme(){
    var attr = document.documentElement.getAttribute('data-theme');
    if (attr) return attr;
    var g = localStorage.getItem(GKEY);
    return g || 'asphalt';
  }
  function applyTheme(t){
    document.documentElement.setAttribute('data-theme', resolveSystem(t));
  }
  try {
    applyTheme(currentTheme());
  } catch(e) {
    console.warn(e);
  }
})();
</script>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-app.js";
    import {
      getAuth,
      onAuthStateChanged
    } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-auth.js";
    import {
      getFirestore,
      doc,
      getDoc,
      collection,
      addDoc,
      updateDoc,
      serverTimestamp
    } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyCKIndVVlblrQfZGjaGpLBSxlWicLZiqPc",
  authDomain: "asphaltcalc-5d7f3.firebaseapp.com",
  projectId: "asphaltcalc-5d7f3",
  storageBucket: "asphaltcalc-5d7f3.firebasestorage.app",
  messagingSenderId: "388017703504",
  appId: "1:388017703504:web:117317163e1ec45a1d5f55"
};


    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db   = getFirestore(app);

    const pageTitle = document.getElementById("pageTitle");
    const pageSub   = document.getElementById("pageSub");
    const userInfo  = document.getElementById("userInfo");
    const guardMsg  = document.getElementById("guardMsg");
    const formWrap  = document.getElementById("formWrap");
    const titleEl   = document.getElementById("title");
    const contentEl = document.getElementById("content");
    const backBtn   = document.getElementById("backBtn");
    const submitBtn = document.getElementById("submitBtn");
    const msgEl     = document.getElementById("msg");
    const toolbar   = document.querySelector(".toolbar");

    const params = new URLSearchParams(location.search);
    const postId = params.get("id");
    const isEdit = !!postId;

    let currentUser = null;
    let loadedPost  = null;

    function insertAroundSelection(before, after) {
      const el = contentEl;
      const start = el.selectionStart || 0;
      const end   = el.selectionEnd || 0;
      const value = el.value;
      const selected = value.slice(start, end) || "í…ìŠ¤íŠ¸";
      const nextValue = value.slice(0, start) + before + selected + after + value.slice(end);
      el.value = nextValue;
      const cursor = start + before.length + selected.length + after.length;
      el.focus();
      el.setSelectionRange(cursor, cursor);
    }

    function insertTemplate(template, cursorOffset) {
      const el = contentEl;
      const start = (typeof el.selectionStart === "number") ? el.selectionStart : el.value.length;
      const value = el.value;
      const nextValue = value.slice(0, start) + template + value.slice(start);
      el.value = nextValue;
      const cursor = start + (cursorOffset || template.length);
      el.focus();
      el.setSelectionRange(cursor, cursor);
    }

    if (toolbar) {
      toolbar.addEventListener("click", function(e) {
        const btn = e.target.closest(".tool-btn");
        if (!btn) return;
        const type = btn.getAttribute("data-md");
        switch (type) {
          case "bold":
            insertAroundSelection("**", "**");
            break;
          case "italic":
            insertAroundSelection("*", "*");
            break;
          case "h2":
            insertTemplate("\n\n## ì œëª©\n\n", 4);
            break;
          case "list":
            insertTemplate("\n\n- í•­ëª© 1\n- í•­ëª© 2\n\n", 4);
            break;
          case "link":
            insertTemplate("[í…ìŠ¤íŠ¸](https://example.com)", 1);
            break;
          case "code":
            insertTemplate("\n\n```\nì½”ë“œë¥¼ ì—¬ê¸°ì— ì‘ì„±í•˜ì„¸ìš”\n```\n\n", 6);
            break;
          case "img-url": {
            const url = window.prompt("ì´ë¯¸ì§€ URLì„ ì…ë ¥í•˜ì„¸ìš” (https://...)");
            if (!url) return;
            const alt = window.prompt("ì´ë¯¸ì§€ ì„¤ëª…(ëŒ€ì²´ í…ìŠ¤íŠ¸)ì„ ì…ë ¥í•˜ì„¸ìš” (ì„ íƒ)");
            const altText = alt && alt.trim() ? alt.trim() : "ì´ë¯¸ì§€";
            insertTemplate("\n\n![" + altText + "](" + url + ")\n\n");
            break;
          }
          case "video-url": {
            const url = window.prompt("ë™ì˜ìƒ URLì„ ì…ë ¥í•˜ì„¸ìš” (YouTube, Twitch ë“±)");
            if (!url) return;
            insertTemplate("\n\n[ë™ì˜ìƒ ë§í¬](" + url + ")\n\n");
            break;
          }
        }
      });
    }

    function applyEditModeUI() {
      if (!isEdit) return;
      pageTitle.textContent = "ê¸€ ìˆ˜ì •";
      pageSub.textContent   = "ì´ì „ì— ì‘ì„±í•œ ê²Œì‹œê¸€ì„ ìˆ˜ì •í•©ë‹ˆë‹¤. ì‘ì„±ì ê³„ì •ìœ¼ë¡œë§Œ ìˆ˜ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.";
      submitBtn.textContent = "ìˆ˜ì • ì €ì¥";
    }

    async function loadPostIfEdit() {
      if (!isEdit) {
        formWrap.style.display = "none";
        return;
      }
      try {
        msgEl.textContent = "";
        guardMsg.textContent = "ê²Œì‹œê¸€ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤â€¦";
        const ref = doc(db, "posts", postId);
        const snap = await getDoc(ref);
        if (!snap.exists()) {
          guardMsg.textContent = "í•´ë‹¹ ê²Œì‹œê¸€ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.";
          formWrap.style.display = "none";
          return;
        }
        loadedPost = snap.data();
        loadedPost.id = snap.id;
        titleEl.value   = loadedPost.title || "";
        contentEl.value = loadedPost.content || "";
        guardMsg.textContent = "ê²Œì‹œê¸€ì„ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤. ì‘ì„±ì ê³„ì •ìœ¼ë¡œ ë¡œê·¸ì¸í•˜ë©´ ìˆ˜ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.";
      } catch (e) {
        console.error(e);
        guardMsg.textContent = "ê²Œì‹œê¸€ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.";
        formWrap.style.display = "none";
      }
    }

    function checkAuthorPermission() {
      if (!isEdit || !currentUser || !loadedPost) return;
      if (currentUser.uid !== loadedPost.authorUid) {
        guardMsg.textContent = "ì´ ê²Œì‹œê¸€ì„ ì‘ì„±í•œ ê³„ì •ì´ ì•„ë‹ˆì–´ì„œ ìˆ˜ì •í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.";
        formWrap.style.display = "none";
      } else {
        guardMsg.textContent = "ì´ ê²Œì‹œê¸€ì˜ ì‘ì„±ì ê³„ì •ìœ¼ë¡œ ë¡œê·¸ì¸ë˜ì–´ ìˆìŠµë‹ˆë‹¤. ìˆ˜ì • í›„ ì €ì¥í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.";
        formWrap.style.display = "";
      }
    }

    onAuthStateChanged(auth, function(user) {
      currentUser = user;
      msgEl.textContent = "";
      msgEl.style.color = "var(--danger)";

      if (!user) {
        userInfo.textContent = "ë¡œê·¸ì•„ì›ƒ ìƒíƒœ";
        guardMsg.textContent = "ë¡œê·¸ì¸ ë° ì´ë©”ì¼ ì¸ì¦ì´ í•„ìš”í•©ë‹ˆë‹¤.";
        formWrap.style.display = "none";
        return;
      }
      const name = user.displayName || (user.email ? user.email.split("@")[0] : "ì‚¬ìš©ì");
      userInfo.textContent = "ë¡œê·¸ì¸: " + name + " (" + user.email + ")";

      if (!user.emailVerified) {
        guardMsg.textContent = "ì´ë©”ì¼ ì¸ì¦ì´ ì™„ë£Œë˜ì§€ ì•Šì•„ ê¸€ì„ ì‘ì„±/ìˆ˜ì •í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ë©”ì¼í•¨ì—ì„œ ì¸ì¦ ë§í¬ë¥¼ í´ë¦­í•œ ë’¤ ë‹¤ì‹œ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.";
        formWrap.style.display = "none";
        return;
      }

      if (!isEdit) {
        guardMsg.textContent = "ì´ë©”ì¼ ì¸ì¦ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ì‹¤ì œ ê¸€ì“°ê¸° ê¶Œí•œì€ Firestore ê·œì¹™(í™”ì´íŠ¸ë¦¬ìŠ¤íŠ¸)ì—ì„œ ê²°ì •ë©ë‹ˆë‹¤.";
        formWrap.style.display = "";
      } else {
        checkAuthorPermission();
      }
    });

    backBtn.addEventListener("click", function() {
      if (history.length > 1) history.back();
      else location.href = "./index.html";
    });

    submitBtn.addEventListener("click", async function() {
      msgEl.textContent = "";
      msgEl.style.color = "var(--danger)";

      if (!currentUser) {
        msgEl.textContent = "ë¨¼ì € ë¡œê·¸ì¸í•˜ì„¸ìš”.";
        return;
      }
      if (!currentUser.emailVerified) {
        msgEl.textContent = "ì´ë©”ì¼ ì¸ì¦ì´ í•„ìš”í•©ë‹ˆë‹¤.";
        return;
      }

      const title   = (titleEl.value || "").trim();
      const content = (contentEl.value || "").trim();
      if (!title || !content) {
        msgEl.textContent = "ì œëª©ê³¼ ë‚´ìš©ì„ ëª¨ë‘ ì…ë ¥í•˜ì„¸ìš”.";
        return;
      }

      submitBtn.disabled = true;
      try {
        if (isEdit) {
          if (!loadedPost) {
            msgEl.textContent = "ê²Œì‹œê¸€ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.";
            return;
          }
          await updateDoc(doc(db, "posts", postId), {
            title: title,
            content: content,
            updatedAt: serverTimestamp()
          });
          msgEl.style.color = "var(--success)";
          msgEl.textContent = "ìˆ˜ì •ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.";
          window.setTimeout(function() {
            location.href = "./read.html?id=" + encodeURIComponent(postId);
          }, 700);
        } else {
          const displayName = currentUser.displayName || (currentUser.email ? currentUser.email.split("@")[0] : "ì‚¬ìš©ì");
          const ref = await addDoc(collection(db, "posts"), {
            title: title,
            content: content,
            authorUid: currentUser.uid,
            authorEmail: currentUser.email,
            authorName: displayName,
            createdAt: serverTimestamp()
          });
          msgEl.style.color = "var(--success)";
          msgEl.textContent = "ì‘ì„±ë˜ì—ˆìŠµë‹ˆë‹¤!";
          window.setTimeout(function() {
            location.href = "./read.html?id=" + encodeURIComponent(ref.id);
          }, 700);
        }
      } catch (e) {
        console.error(e);
        if (e && e.code === "permission-denied") {
          msgEl.textContent = "ê¸€ì“°ê¸° ê¶Œí•œì´ ì—†ëŠ” ê³„ì •ì…ë‹ˆë‹¤. ê´€ë¦¬ìê°€ í™”ì´íŠ¸ë¦¬ìŠ¤íŠ¸ì— ì¶”ê°€í•´ì•¼ í•©ë‹ˆë‹¤.";
        } else {
          msgEl.textContent = "ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.";
        }
      } finally {
        submitBtn.disabled = false;
      }
    });

    applyEditModeUI();
    loadPostIfEdit();
  </script>
</body>
</html>
