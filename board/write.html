<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>글 작성/수정 — AsphaltCalc 게시판</title>
  <style>
    *{box-sizing:border-box;}
    body{
      margin:0;
      font-family:system-ui,-apple-system,"Segoe UI","Noto Sans KR",sans-serif;
      background:#020617;
      color:#e5e7eb;
    }
    .wrap{
      max-width:720px;
      margin:32px auto;
      padding:0 16px;
    }
    h1{margin:0 0 6px;font-size:22px;}
    .sub{font-size:13px;color:#9ca3af;margin:0 0 14px;}
    .card{
      background:#020617;
      border-radius:12px;
      border:1px solid #1f2937;
      padding:14px 16px 16px;
      box-shadow:0 18px 40px rgba(0,0,0,.6);
    }
    label{display:block;font-size:13px;margin-bottom:4px;}
    input,textarea{
      width:100%;
      padding:8px 10px;
      border-radius:8px;
      border:1px solid #374151;
      background:#020617;
      color:#e5e7eb;
      margin-bottom:8px;
      font-family:inherit;
      font-size:14px;
    }
    textarea{min-height:180px;resize:vertical;}
    input:focus,textarea:focus{outline:none;border-color:#3b82f6;box-shadow:0 0 0 1px #3b82f6;}
    .btn-row{display:flex;justify-content:space-between;gap:8px;margin-top:8px;flex-wrap:wrap;}
    .btn{
      padding:8px 12px;
      border-radius:999px;
      border:1px solid #374151;
      background:#111827;
      color:#e5e7eb;
      font-size:14px;
      cursor:pointer;
    }
    .btn-primary{background:#3b82f6;border-color:#2563eb;color:white;}
    .btn:disabled{opacity:.6;cursor:default;}
    .msg{font-size:13px;margin-top:8px;min-height:18px;}
    a{color:#60a5fa;text-decoration:none;}
    a:hover{text-decoration:underline;}
    .info{font-size:13px;color:#9ca3af;margin-bottom:10px;}
  </style>
</head>
<body>
  <div class="wrap">
    <h1 id="pageTitle">새 글 작성</h1>
    <p class="sub" id="pageSub">이메일 인증 + 글쓰기 권한이 있는 계정만 실제로 글을 저장할 수 있습니다.</p>

    <div class="card">
      <div class="info" id="userInfo">로그인 및 권한 확인 중…</div>
      <div class="info" id="guardMsg"></div>

      <div id="formWrap" style="display:none;">
        <label for="title">제목</label>
        <input id="title" type="text" maxlength="80" />

        <label for="content">내용</label>
        <textarea id="content" maxlength="8000"></textarea>

        <div class="btn-row">
          <button id="backBtn" class="btn" type="button">← 목록으로</button>
          <button id="submitBtn" class="btn btn-primary" type="button">게시</button>
        </div>

        <div id="msg" class="msg"></div>
      </div>

      <div style="margin-top:10px;font-size:12px;">
        <a href="./index.html">게시판으로 돌아가기</a>
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-app.js";
    import {
      getAuth,
      onAuthStateChanged
    } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-auth.js";
    import {
      getFirestore,
      collection,
      addDoc,
      serverTimestamp,
      doc,
      getDoc,
      updateDoc
    } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-firestore.js";

    const firebaseConfig = {
  apiKey: "AIzaSyCKIndVVlblrQfZGjaGpLBSxlWicLZiqPc",
  authDomain: "asphaltcalc-5d7f3.firebaseapp.com",
  projectId: "asphaltcalc-5d7f3",
  storageBucket: "asphaltcalc-5d7f3.firebasestorage.app",
  messagingSenderId: "388017703504",
  appId: "1:388017703504:web:117317163e1ec45a1d5f55"
};

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const userInfo = document.getElementById("userInfo");
    const guardMsg = document.getElementById("guardMsg");
    const formWrap = document.getElementById("formWrap");
    const titleEl = document.getElementById("title");
    const contentEl = document.getElementById("content");
    const backBtn = document.getElementById("backBtn");
    const submitBtn = document.getElementById("submitBtn");
    const msgEl = document.getElementById("msg");
    const pageTitle = document.getElementById("pageTitle");
    const pageSub = document.getElementById("pageSub");

    const params = new URLSearchParams(location.search);
    const editId = params.get("id");
    const isEdit = !!editId;

    let currentUser = null;
    let loadedPost = null;

    if (isEdit) {
      pageTitle.textContent = "게시글 수정";
      pageSub.textContent = "이 게시글을 작성한 계정만 수정할 수 있습니다. (이메일 인증 + 권한 필요)";
      submitBtn.textContent = "수정 저장";
    }

    async function loadPostForEdit(id) {
      try {
        const ref = doc(db, "posts", id);
        const snap = await getDoc(ref);
        if (!snap.exists()) {
          guardMsg.textContent = "해당 게시글을 찾을 수 없습니다.";
          formWrap.style.display = "none";
          return;
        }
        const d = snap.data();
        loadedPost = { id, ...d };
        titleEl.value = d.title || "";
        contentEl.value = d.content || "";
        // 작성자 체크는 onAuthStateChanged에서 처리
        checkAuthorPermission();
      } catch (e) {
        console.error(e);
        guardMsg.textContent = "게시글을 불러오는 중 오류가 발생했습니다.";
        formWrap.style.display = "none";
      }
    }

    function checkAuthorPermission() {
      if (!isEdit || !currentUser || !loadedPost) return;
      if (currentUser.uid !== loadedPost.authorUid) {
        guardMsg.textContent = "이 게시글을 작성한 계정이 아니어서 수정할 수 없습니다.";
        formWrap.style.display = "none";
      } else {
        guardMsg.textContent = "이 게시글의 작성자 계정으로 로그인되어 있습니다. 수정 후 저장할 수 있습니다.";
        formWrap.style.display = "";
      }
    }

    onAuthStateChanged(auth, (user) => {
      currentUser = user;
      msgEl.textContent = "";
      msgEl.style.color = "#fca5a5";

      if (!user) {
        userInfo.textContent = "로그아웃 상태";
        guardMsg.textContent = "로그인 및 이메일 인증이 필요합니다.";
        formWrap.style.display = "none";
        return;
      }
      const name = user.displayName || (user.email ? user.email.split("@")[0] : "사용자");
      userInfo.textContent = `로그인: \${name} (\${user.email})`;

      if (!user.emailVerified) {
        guardMsg.textContent = "이메일 인증이 완료되지 않아 글을 작성/수정할 수 없습니다. 메일함에서 인증 링크를 클릭한 뒤 다시 로그인해주세요.";
        formWrap.style.display = "none";
        return;
      }

      if (isEdit) {
        if (!loadedPost) loadPostForEdit(editId);
        else checkAuthorPermission();
      } else {
        guardMsg.textContent = "이메일 인증은 완료되었습니다. 실제 글쓰기 권한은 Firestore 규칙(화이트리스트)에서 결정됩니다.";
        formWrap.style.display = "";
      }
    });

    backBtn.addEventListener("click", () => {
      location.href = "./index.html";
    });

    submitBtn.addEventListener("click", async () => {
      msgEl.textContent = "";
      msgEl.style.color = "#fca5a5";

      if (!currentUser) {
        msgEl.textContent = "먼저 로그인하세요.";
        return;
      }
      if (!currentUser.emailVerified) {
        msgEl.textContent = "이메일 인증이 필요합니다.";
        return;
      }

      const title = titleEl.value.trim();
      const content = contentEl.value.trim();

      if (!title || !content) {
        msgEl.textContent = "제목과 내용을 모두 입력하세요.";
        return;
      }

      try {
        submitBtn.disabled = true;
        const displayName = currentUser.displayName || (currentUser.email ? currentUser.email.split("@")[0] : "사용자");

        if (isEdit) {
          if (!loadedPost) {
            msgEl.textContent = "게시글을 아직 불러오지 못했습니다.";
            return;
          }
          const ref = doc(db, "posts", editId);
          await updateDoc(ref, {
            title,
            content,
            updatedAt: serverTimestamp()
          });
          msgEl.style.color = "#a5f3fc";
          msgEl.textContent = "수정되었습니다! 잠시 후 글 상세 페이지로 이동합니다.";
          setTimeout(() => {
            location.href = `./read.html?id=\${encodeURIComponent(editId)}`;
          }, 900);
        } else {
          const docRef = await addDoc(collection(db, "posts"), {
            title,
            content,
            authorUid: currentUser.uid,
            authorEmail: currentUser.email,
            authorName: displayName,
            createdAt: serverTimestamp()
          });
          msgEl.style.color = "#a5f3fc";
          msgEl.textContent = "작성되었습니다! 잠시 후 글 상세 페이지로 이동합니다.";
          setTimeout(() => {
            location.href = `./read.html?id=\${encodeURIComponent(docRef.id)}`;
          }, 900);
        }
      } catch (e) {
        console.error(e);
        if (e.code === "permission-denied") {
          msgEl.style.color = "#fca5a5";
          msgEl.textContent = "글쓰기/수정 권한이 없습니다. (이메일 인증/화이트리스트 권한을 운영자에게 문의하세요)";
        } else {
          msgEl.style.color = "#fca5a5";
          msgEl.textContent = "글 저장 중 오류가 발생했습니다.";
        }
      } finally {
        submitBtn.disabled = false;
      }
    });
  </script>
</body>
</html>