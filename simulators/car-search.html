<!doctype html>
<html lang="ko">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Car Search ‚Äî ÏûêÎèôÏ∞® Í≤ÄÏÉâ</title>
  <meta name="color-scheme" content="light dark" />

  <link rel="icon" href="../assets/favicon.png">
  <link rel="stylesheet" href="../assets/style.css">
  <link rel="stylesheet" href="../assets/themes.css">

  <!-- Theme Init -->
  <script>window.SIM_ID = "car-search";</script>
  <script src="../assets/theme-init.js"></script>
  <link rel="stylesheet" href="../assets/theme-adapter.css">

  <style>
    /* Page Specific Styles */
    /* Note: .container replaces .page-wrap. Max-width logic is handled by shared .container */

    .panel {
      border-radius: 18px;
      padding: 18px 20px 16px;
      background: var(--surface);
      border: 1px solid var(--border);
      box-shadow: var(--shadow-raised, 0 18px 45px rgba(0, 0, 0, .55));
    }

    .panel-title-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
      margin-bottom: 10px;
    }

    .panel-title {
      margin: 0;
      font-size: 16px;
      font-weight: 800;
      letter-spacing: .02em;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .badge-small {
      padding: 2px 6px;
      border-radius: 999px;
      border: 1px solid var(--border-subtle);
      font-size: 10px;
      letter-spacing: .06em;
      text-transform: uppercase;
      color: var(--ink-soft);
      background: var(--surface-soft);
      white-space: nowrap;
    }

    .sort-row {
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
      justify-content: flex-end;
    }

    .sort-chips {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      list-style: none;
      padding: 0;
      margin: 0;
    }

    .sort-chip {
      padding: 3px 10px;
      border-radius: 999px;
      font-size: 11px;
      letter-spacing: .06em;
      text-transform: uppercase;
      border: 1px solid var(--border-soft);
      background: var(--surface-soft);
      color: var(--ink-soft);
      cursor: pointer;
      user-select: none;
      white-space: nowrap;
    }

    .sort-chip.is-active {
      border-color: var(--accent);
      background: var(--accent-soft);
      color: var(--accent-strong);
      font-weight: 600;
    }

    .list-controls {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 10px;
      margin-bottom: 10px;
    }

    .search-wrap {
      flex: 1 1 200px;
      min-width: 0;
    }

    .search-input {
      width: 100%;
      padding: 7px 10px;
      border-radius: 999px;
      border: 1px solid var(--border-soft);
      background: var(--surface-soft);
      color: var(--ink);
      font-size: 13px;
      outline: none;
    }

    .search-input::placeholder {
      color: var(--ink-faint);
    }

    .class-chips {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      list-style: none;
      padding: 0;
      margin: 0;
    }

    .class-chip {
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 11px;
      letter-spacing: .09em;
      text-transform: uppercase;
      border: 1px solid var(--border-soft);
      background: var(--surface-soft);
      color: var(--ink-soft);
      cursor: pointer;
      user-select: none;
    }

    .class-chip.is-active {
      border-color: var(--accent);
      background: var(--accent-soft);
      color: var(--accent-strong);
    }

    .car-list-wrap {
      border-radius: 14px;
      border: 1px solid var(--border-soft);
      background: var(--surface-subtle);
      overflow: hidden;
    }

    .car-list {
      width: 100%;
      border-collapse: collapse;
      font-size: 12px;
    }

    .car-list thead {
      background: var(--surface-soft);
      position: sticky;
      top: 0;
      z-index: 1;
    }

    .car-list th,
    .car-list td {
      padding: 6px 8px;
      text-align: left;
      border-bottom: 1px solid var(--border-subtle);
      white-space: nowrap;
    }

    .car-list th {
      font-size: 11px;
      font-weight: 700;
      letter-spacing: .06em;
      text-transform: uppercase;
      color: var(--ink-soft);
    }

    .car-list tbody tr {
      cursor: pointer;
    }

    .car-list tbody tr:nth-child(2n) {
      background: var(--surface-weak);
    }

    .car-list tbody tr:hover {
      background: var(--surface-hover);
    }

    .col-class {
      width: 38px;
    }

    .col-id {
      width: 52px;
    }

    .col-max-rank {
      width: 80px;
    }

    .col-fuel {
      width: 50px;
    }

    .col-max-star {
      width: 55px;
    }

    .class-badge {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      min-width: 26px;
      padding: 2px 6px;
      border-radius: 999px;
      border: 1px solid var(--border-soft);
      font-size: 11px;
      font-weight: 700;
      color: var(--ink);
    }

    .class-d {
      background: #2a3b55;
      border-color: #3e5372;
      color: #a4c2f4;
    }

    .class-c {
      background: #2f2a55;
      border-color: #463e75;
      color: #c0a4f4;
    }

    .class-b {
      background: #552a2a;
      border-color: #753e3e;
      color: #f4a4a4;
    }

    .class-a {
      background: #55482a;
      border-color: #75633e;
      color: #f4dca4;
    }

    .class-s {
      background: #2a5548;
      border-color: #3e7563;
      color: #a4f4d2;
    }

    .car-name-cell {
      font-weight: 600;
      color: var(--ink);
      font-size: 13px;
    }

    .car-name-cell small {
      font-weight: 400;
      color: var(--ink-muted);
      margin-left: 6px;
    }

    .star-wrap {
      display: flex;
      gap: 1px;
      color: var(--accent-gold);
    }

    .star-wrap.max {
      color: var(--accent);
    }

    /* Loading / Empty states */
    .state-msg {
      padding: 40px;
      text-align: center;
      color: var(--ink-muted);
      font-size: 13px;
    }
  </style>

  <script src="../assets/lang.js"></script>
  <script src="../assets/i18n.js"></script>
</head>

<body>
  <div class="container">
    <div class="header">
      <div class="brand">
        <h1>üîç <span data-i18n="cs.title">ÏûêÎèôÏ∞® Í≤ÄÏÉâ</span></h1>
      </div>
      <div class="toolbar">
        <a class="btn" href="../index.html" data-i18n="common.back">‚Üê ÌóàÎ∏å</a>
      </div>
    </div>


    <section class="panel">
      <div class="panel-title-row">
        <h2 class="panel-title" data-i18n="cs.all_cars">Ï†ÑÏ≤¥ Ï∞®Îüâ</h2>
        <div class="sort-row">
          <ul class="sort-chips" id="sortChips">
            <li class="sort-chip is-active" data-sort="default" data-i18n="cs.sort_default">Í∏∞Î≥∏</li>
            <li class="sort-chip" data-sort="rank-desc" data-i18n="cs.sort_rank_desc">Îû≠ÌÅ¨‚Üì</li>
            <li class="sort-chip" data-sort="rank-asc" data-i18n="cs.sort_rank_asc">Îû≠ÌÅ¨‚Üë</li>
            <li class="sort-chip" data-sort="id-asc" data-i18n="cs.sort_id_asc">ID‚Üë</li>
            <li class="sort-chip" data-sort="id-desc" data-i18n="cs.sort_id_desc">ID‚Üì</li>
          </ul>
          <span class="badge-small" id="countBadge">Ï¥ù 0ÎåÄ</span>
        </div>
      </div>

      <div class="list-controls">
        <div class="search-wrap">
          <input id="searchInput" class="search-input" type="search" data-placeholder="cs.search_ph"
            placeholder="Ï∞® Ïù¥Î¶Ñ ÎòêÎäî ID Í≤ÄÏÉâ..." onfocus="this.placeholder=''"
            onblur="this.placeholder=I18N.t('cs.search_ph')" autocomplete="off">
        </div>
        <ul class="class-chips" id="classFilter">
          <li class="class-chip is-active" data-class="ALL">ALL</li>
          <li class="class-chip" data-class="D">D</li>
          <li class="class-chip" data-class="C">C</li>
          <li class="class-chip" data-class="B">B</li>
          <li class="class-chip" data-class="A">A</li>
          <li class="class-chip" data-class="S">S</li>
        </ul>
      </div>

      <div class="car-list-wrap">
        <table class="car-list">
          <thead>
            <tr>
              <th class="col-class" data-i18n="cs.table.class">Class</th>
              <th class="col-id" data-i18n="cs.table.id">ID</th>
              <th data-i18n="cs.table.name">Ïù¥Î¶Ñ</th>
              <th class="col-max-rank" data-i18n="cs.table.max_rank">Max Rank</th>
              <th class="col-max-star" data-i18n="cs.table.max_star">‚òÖ Max</th>
              <th class="col-fuel" data-i18n="cs.table.fuel">Ïó∞Î£å</th>
            </tr>
          </thead>
          <tbody id="carListBody">
            <!-- JSÎ°ú Î†åÎçîÎßÅ -->
          </tbody>
        </table>
      </div>
    </section>
  </div>

  <script>
    async function loadCarData() {
      if (Array.isArray(window.CAR_DATA)) return window.CAR_DATA;

      try {
        var res = await fetch("../assets/cars.json");
        if (res.ok) {
          var data = await res.json();
          if (Array.isArray(data)) return data;
          return Object.values(data);
        }
      } catch (e) {
        console.warn(I18N.t('cs.err_load'), e);
      }
      return [];
    }

    function getMaxRank(car) {
      if (!car || !Array.isArray(car.stat) || car.stat.length === 0) return null;
      var goldEntry = null;
      var maxRankEntry = null;
      for (var i = 0; i < car.stat.length; i++) {
        var s = car.stat[i];
        if (!maxRankEntry || (typeof s.rank === "number" && s.rank > maxRankEntry.rank)) {
          maxRankEntry = s;
        }
        if (s.type === "gold") goldEntry = s;
      }
      return (goldEntry && typeof goldEntry.rank === "number")
        ? goldEntry.rank
        : (maxRankEntry && typeof maxRankEntry.rank === "number")
          ? maxRankEntry.rank
          : null;
    }

    function formatNumber(n) {
      if (typeof n !== "number" || !isFinite(n)) return "-";
      return n.toLocaleString("ko-KR");
    }

    function initCarList(cars) {
      var carListBody = document.getElementById("carListBody");
      var searchInput = document.getElementById("searchInput");
      var classFilter = document.getElementById("classFilter");
      var sortChips = document.getElementById("sortChips");
      var countBadge = document.getElementById("countBadge");

      var allCars = Array.isArray(cars) ? cars.slice() : [];
      var filteredCars = allCars.slice();
      var currentClassFilter = "ALL";
      var currentSearch = "";
      var currentSort = "default"; // Í∏∞Î≥∏

      countBadge.textContent = I18N.t('cs.total_count').replace('{n}', allCars.length);

      function sortCars() {
        var classOrder = { "D": 0, "C": 1, "B": 2, "A": 3, "S": 4 };

        filteredCars.sort(function (a, b) {
          var idA = Number(a.id);
          var idB = Number(b.id);
          if (!isFinite(idA)) idA = 0;
          if (!isFinite(idB)) idB = 0;

          var ra = getMaxRank(a);
          var rb = getMaxRank(b);
          var aHasRank = (typeof ra === "number" && isFinite(ra));
          var bHasRank = (typeof rb === "number" && isFinite(rb));

          // Í∏∞Î≥∏: ÌÅ¥ÎûòÏä§ D‚ÜíC‚ÜíB‚ÜíA‚ÜíS, Í∞ôÏùÄ ÌÅ¥ÎûòÏä§Îäî "ÏµúÎåÄ Îû≠ÌÅ¨ Ïò§Î¶ÑÏ∞®Ïàú"
          if (currentSort === "default") {
            var ca = classOrder[a.class] != null ? classOrder[a.class] : 99;
            var cb = classOrder[b.class] != null ? classOrder[b.class] : 99;
            if (ca !== cb) return ca - cb;

            if (!aHasRank && !bHasRank) {
              return idA - idB;
            }
            if (!aHasRank) return 1;
            if (!bHasRank) return -1;

            if (ra !== rb) return ra - rb;
            return idA - idB;
          }

          // ID Ï†ïÎ†¨
          if (currentSort === "id-asc") {
            if (idA !== idB) return idA - idB;
            return 0;
          }
          if (currentSort === "id-desc") {
            if (idA !== idB) return idB - idA;
            return 0;
          }

          // Îû≠ÌÅ¨ Ï†ïÎ†¨
          if (!aHasRank && !bHasRank) {
            var ca2 = classOrder[a.class] != null ? classOrder[a.class] : 99;
            var cb2 = classOrder[b.class] != null ? classOrder[b.class] : 99;
            if (ca2 !== cb2) return ca2 - cb2;
            return idA - idB;
          }
          if (!aHasRank) return 1;
          if (!bHasRank) return -1;

          if (currentSort === "rank-asc") {
            if (ra !== rb) return ra - rb;
            return idA - idB;
          }
          // ÎÇòÎ®∏ÏßÄÎäî rank-desc (Îû≠ÌÅ¨ ÎÜíÏùÄ Ïàú)
          if (ra !== rb) return rb - ra;
          return idA - idB;
        });
      }

      function applyFilter() {
        var q = currentSearch.trim().toLowerCase();
        filteredCars = allCars.filter(function (car) {
          if (currentClassFilter !== "ALL" && car.class !== currentClassFilter) return false;
          if (q) {
            var name = (car.name || "").toLowerCase();
            var idStr = String(car.id || "");
            return name.indexOf(q) !== -1 || idStr.indexOf(q) !== -1;
          }
          return true;
        });
        sortCars();
        renderList();
      }

      function renderList() {
        carListBody.innerHTML = "";
        if (filteredCars.length === 0) {
          var tr = document.createElement("tr");
          var td = document.createElement("td");
          td.colSpan = 6;
          td.textContent = I18N.t('cs.msg_no_result');
          td.style.fontSize = "12px";
          td.style.color = "var(--ink-soft)";
          td.style.padding = "10px 8px";
          tr.appendChild(td);
          carListBody.appendChild(tr);
          return;
        }

        for (var i = 0; i < filteredCars.length; i++) {
          var car = filteredCars[i];
          var tr = document.createElement("tr");
          tr.dataset.carId = car.id;

          var tdClass = document.createElement("td");
          tdClass.className = "col-class";
          var spanClass = document.createElement("span");
          spanClass.className = "class-badge";
          spanClass.textContent = car.class || "-";
          tdClass.appendChild(spanClass);

          var tdId = document.createElement("td");
          tdId.className = "col-id";
          tdId.textContent = car.id != null ? car.id : "-";

          var tdName = document.createElement("td");
          tdName.textContent = car.name || "-";

          var tdMaxRank = document.createElement("td");
          tdMaxRank.className = "col-max-rank";
          var maxRank = getMaxRank(car);
          tdMaxRank.textContent = maxRank == null ? "-" : formatNumber(maxRank);

          var tdMaxStar = document.createElement("td");
          tdMaxStar.className = "col-max-star";
          tdMaxStar.textContent = car.max_star != null ? car.max_star : "-";

          var tdFuel = document.createElement("td");
          tdFuel.className = "col-fuel";
          tdFuel.textContent = car.fuel != null ? car.fuel : "-";

          tr.appendChild(tdClass);
          tr.appendChild(tdId);
          tr.appendChild(tdName);
          tr.appendChild(tdMaxRank);
          tr.appendChild(tdMaxStar);
          tr.appendChild(tdFuel);

          carListBody.appendChild(tr);
        }
      }

      // Í≤ÄÏÉâ
      searchInput.addEventListener("input", function () {
        currentSearch = searchInput.value;
        applyFilter();
      });

      // ÌÅ¥ÎûòÏä§ Ïπ©
      classFilter.addEventListener("click", function (e) {
        var chip = e.target.closest(".class-chip");
        if (!chip) return;
        var cls = chip.dataset.class;
        if (!cls) return;

        currentClassFilter = cls;
        var chips = classFilter.querySelectorAll(".class-chip");
        for (var i = 0; i < chips.length; i++) {
          chips[i].classList.toggle("is-active", chips[i] === chip);
        }
        applyFilter();
      });

      // Ï†ïÎ†¨ Ïπ©
      sortChips.addEventListener("click", function (e) {
        var chip = e.target.closest(".sort-chip");
        if (!chip) return;
        var sortKey = chip.dataset.sort;
        if (!sortKey) return;

        currentSort = sortKey;
        var chips = sortChips.querySelectorAll(".sort-chip");
        for (var i = 0; i < chips.length; i++) {
          chips[i].classList.toggle("is-active", chips[i] === chip);
        }
        applyFilter();
      });

      // Ìñâ ÌÅ¥Î¶≠ ‚Üí ÏÉÅÏÑ∏ ÌéòÏù¥ÏßÄ Ïù¥Îèô
      carListBody.addEventListener("click", function (e) {
        var tr = e.target.closest("tr");
        if (!tr || !tr.dataset.carId) return;
        var carId = tr.dataset.carId;
        window.location.href = "car-detail.html?id=" + encodeURIComponent(carId);
      });

      // Ï¥àÍ∏∞ Î†åÎçî
      applyFilter();
    }

    (async function () {
      var cars = await loadCarData();
      initCarList(cars);
    })();
  </script>
  <!-- Hub Back Button Inject -->
  <style>
    #hubBackWrap {
      position: fixed;
      left: 16px;
      top: 16px;
      z-index: 2147483647;
      font-family: ui-sans-serif, system-ui, Segoe UI, Roboto, "Noto Sans KR", Arial
    }

    #hubBackBtn {
      padding: 10px 14px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: var(--chip-bg);
      color: var(--ink);
      cursor: pointer;
      box-shadow: 0 6px 20px rgba(0, 0, 0, .35);
      opacity: .9
    }

    #hubBackBtn:hover {
      opacity: 1
    }

    @media (prefers-color-scheme: light) {
      #hubBackBtn {
        background: var(--chip-bg);
        color: var(--ink)
      }
    }
  </style>
  <div id="hubBackWrap">
    <button id="hubBackBtn" title="Î©îÏù∏ Î©îÎâ¥Î°ú" data-i18n="common.back">
      ‚Üê Î©îÏù∏ÏúºÎ°ú
    </button>
  </div>
  <script>
    (function () {
      var btn = document.getElementById('hubBackBtn');
      if (!btn) return;
      btn.addEventListener('click', function () {
        // If navigated from hub, try back; otherwise go to hub index.html
        if (document.referrer && document.referrer.indexOf('index.html') !== -1) {
          history.back();
        } else {
          // assume hub is one level up
          location.href = '../index.html';
        }
      });
    })();
  </script>
</body>

</html>