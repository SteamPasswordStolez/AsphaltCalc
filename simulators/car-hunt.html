<!doctype html>
<html lang="ko">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="icon" href="../assets/favicon.png">
  <title>Car Hunt â€” ìë™ì°¨ ì‚¬ëƒ¥ ì‹œë®¬ë ˆì´í„°</title>
  <style>
    * {
      box-sizing: border-box
    }

    body {
      margin: 0;
      font-family: ui-sans-serif, system-ui, Segoe UI, Apple SD Gothic Neo, Apple Color Emoji, Roboto, Noto Sans KR, Arial;
      background: linear-gradient(180deg, var(--bg), #0e131a 40%, var(--bg));
      color: var(--ink)
    }

    .wrap {
      max-width: 1180px;
      margin: 32px auto;
      padding: 0 16px
    }

    h1 {
      font-size: 26px;
      margin: 0 0 16px
    }

    .grid {
      display: grid;
      grid-template-columns: 1.1fr 1fr;
      gap: var(--gap)
    }

    .card {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow)
    }

    .card h2 {
      font-size: 18px;
      margin: 0 0 8px
    }

    .card .body {
      padding: 16px
    }

    label {
      display: grid;
      grid-template-columns: 1.2fr 1fr;
      align-items: center;
      gap: 10px;
      margin: 10px 0;
      color: var(--muted)
    }

    input[type="number"],
    input[type="text"],
    select {
      width: 100%;
      padding: 10px 12px;
      border-radius: 10px;
      border: 1px solid var(--control-border);
      background: var(--control-bg);
      color: var(--ink)
    }

    .row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px
    }

    .actions {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 10px
    }

    button {
      padding: 10px 14px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: var(--chip-bg);
      color: var(--ink);
      cursor: pointer
    }

    button.primary {
      border-color: #17576b;
      background: linear-gradient(180deg, #14384a, #0f2a38);
    }

    button.sub {
      background: var(--chip-bg)
    }

    button.warn {
      background: #2a1010;
      border-color: #4a1c1c
    }

    button:disabled {
      opacity: .5;
      cursor: not-allowed
    }

    .result {
      font-variant-numeric: tabular-nums;
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 12px
    }

    .stat {
      background: #0c141f;
      border: 1px solid #1a2433;
      border-radius: 12px;
      padding: 10px
    }

    .stat .k {
      color: var(--muted);
      font-size: 12px
    }

    .stat .v {
      font-size: 20px;
      margin-top: 6px
    }

    .mono {
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace
    }

    .footer {
      opacity: .7;
      font-size: 12px;
      margin-top: 12px;
      white-space: pre-wrap
    }

    canvas {
      width: 100%;
      height: 220px;
      background: #0a1018;
      border: 1px solid #1a2433;
      border-radius: 10px
    }

    @media (max-width: 1024px) {
      .grid {
        grid-template-columns: 1fr
      }
    }

    .tabs {
      display: flex;
      gap: 8px;
      margin-bottom: 12px
    }

    .tab {
      padding: 10px 14px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: var(--chip-bg);
      cursor: pointer
    }

    .tab.active {
      background: #14384a;
      border-color: #17576b
    }

    .hidden {
      display: none
    }

    .muted {
      opacity: .6
    }

    .seg-table {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0 6px;
    }

    .seg-table th {
      font-size: 12px;
      color: var(--muted);
      font-weight: 600;
      text-align: left;
      padding: 2px 6px
    }

    .seg-table td {
      padding: 0 6px
    }

    .seg-row {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr auto;
      gap: 8px;
      align-items: center
    }

    .seg-row input {
      width: 100%
    }

    .pill {
      padding: 6px 10px;
      border-radius: 999px;
      background: var(--chip-bg);
      border: 1px solid var(--border);
      font-size: 12px
    }

    .twocol {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: var(--gap);
    }

    .list {
      list-style: none;
      padding: 0;
      margin: 8px 0 0
    }

    .list li {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      border: 1px solid var(--border);
      background: var(--control-bg);
      padding: 8px 10px;
      border-radius: 10px;
      margin-bottom: 8px
    }

    .list .meta {
      font-size: 12px;
      color: var(--muted)
    }

    .chip {
      font-size: 12px;
      padding: 2px 8px;
      border: 1px solid var(--control-border);
      border-radius: 999px;
      background: var(--chip-bg);
      margin-left: 6px
    }

    .grow {
      flex: 1 1 auto;
      min-width: 0
    }

    /* Theme token normalization (inlined) */
    .card {
      background: var(--panel);
      border-color: var(--border);
      color: var(--ink);
    }

    .stat {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 12px;
    }

    input[type="number"],
    input[type="text"],
    select {
      background: var(--control-bg);
      color: var(--ink);
      border: 1px solid var(--control-border);
    }

    .pill,
    .chip {
      background: var(--chip-bg);
      color: var(--ink);
      border: 1px solid var(--border);
    }

    .seg-table th,
    .seg-table td {
      border-color: var(--border)
    }

    .warn {
      background: color-mix(in srgb, var(--danger) 20%, transparent);
      color: var(--ink);
      border: 1px solid color-mix(in srgb, var(--danger) 45%, var(--border));
    }
  </style>
  <link rel="stylesheet" href="../assets/themes.css">

  <script>
    (function () {
      var SIM_ID = "car-hunt";
      var GKEY = "simhub_theme_global";
      var OKEY = "simhub_theme_overrides";
      function resolveSystem(theme) {
        if (theme !== "system") return theme;
        var isDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
        return isDark ? "dark" : "light";
      }
      function apply() {
        var g = localStorage.getItem(GKEY) || "asphalt";
        try { var map = JSON.parse(localStorage.getItem(OKEY) || "{}"); } catch (_) {
          var map = {};
        }
        var t = map[SIM_ID] || g;
        document.documentElement.dataset.theme = resolveSystem(t);
      }
      try { apply(); } catch (e) { console.warn(e); }
    })();
  </script>

  <link rel="stylesheet" href="../assets/theme-adapter.css">
  <script src="../assets/lang.js"></script>
  <script src="../assets/i18n.js"></script>

  <style>
    /* --- Car Hunt theming fixes --- */
    /* Histogram panel */
    #histPanel,
    .histogram,
    .histogram .panel,
    #histCanvas {
      background: var(--panel) !important;
      border: 1px solid var(--border) !important;
      color: var(--ink) !important;
      border-radius: 12px !important;
    }

    /* Primary action buttons: run simulation, 'ì´ ì„¤ì •ìœ¼ë¡œ ì‹¤í–‰', history clear, preset delete */
    button.run,
    button.run-sim,
    #btnRun,
    .btn-run,
    #historyRun,
    .history-run,
    .btn-history-run,
    #btnHistoryClear,
    .btn-history-clear,
    .preset-delete,
    .btn-preset-delete {
      background: linear-gradient(135deg, var(--accent), var(--accent2)) !important;
      color: #fff !important;
      border: none !important;
      border-radius: 12px !important;
      box-shadow: 0 6px 18px rgba(0, 0, 0, .25) !important;
      font-weight: 700 !important;
    }

    /* Secondary gray buttons map to chip color */
    button.gray,
    .btn-gray,
    .btn-secondary {
      background: var(--chip-bg) !important;
      color: var(--ink) !important;
      border: 1px solid var(--border) !important;
      border-radius: 12px !important;
    }

    /* History / Preset cards */
    .history-card,
    .preset-card {
      background: var(--panel) !important;
      border: 1px solid var(--border) !important;
      color: var(--ink) !important;
    }

    /* Segmented table borders */
    .seg-table th,
    .seg-table td {
      border-color: var(--border) !important;
    }
  </style>


  <style>
    /* Histogram correct target */
    #hist {
      background: var(--panel) !important;
      border: 1px solid var(--border) !important;
      border-radius: 12px !important;
    }

    /* Container tweaks for histogram panel if exists */
    #histPanel {
      background: var(--panel) !important;
      border: 1px solid var(--border) !important;
      border-radius: 12px !important;
    }

    /* Mobile readability */
    @media (max-width: 860px) {
      .wrap {
        grid-template-columns: 1fr !important;
        gap: 12px !important;
      }

      .card {
        padding: 12px !important;
      }

      .field label {
        font-size: 14px !important;
      }

      input,
      select,
      textarea {
        font-size: 16px !important;
        padding: 10px 12px !important;
      }

      /* bigger touch targets */
      .button,
      .btn,
      .pill {
        font-size: 15px !important;
        padding: 10px 14px !important;
      }

      /* Results grid stack */
      .stat {
        min-height: 60px !important;
      }

      #hist {
        width: 100% !important;
        height: 260px !important;
      }
    }
  </style>

</head>

<body>
  <div class="wrap">
    <div class="brand">
      <div class="logo"></div>
      <h1 data-i18n="ch.title">ìë™ì°¨ ì‚¬ëƒ¥ ì‹œë®¬ë ˆì´í„°</h1>
    </div>
    <div class="toolbar">
      <a class="btn" href="../index.html" data-i18n="common.back">â† í—ˆë¸Œ</a>
      <button id="btnReload" class="btn">
        <svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
          <path
            d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15">
          </path>
        </svg>
        <span data-i18n="common.reload">ìƒˆë¡œê³ ì¹¨</span>
      </button>
    </div>

    <div class="tabs">
      <button class="tab active" data-tab="goal" data-i18n="ch.tab_goal">ğŸ¯ ëª©í‘œ ê¸°ì¤€</button>
      <button class="tab" data-tab="time" data-i18n="ch.tab_time">â±ï¸ ì‹œê°„ ê¸°ì¤€</button>
    </div>

    <div class="grid">
      <div class="card">
        <div class="body">
          <h2 data-i18n="ch.input">ì…ë ¥ê°’</h2>

          <div class="row">
            <label><span data-i18n="ch.auto_rate">í‹°ì¼“ ìë™ì¶©ì „ ì†ë„ (%)</span>
              <input id="autoRate" type="number" min="10" step="1" value="100" />
            </label>
            <label><span data-i18n="ch.charge_method">í‹°ì¼“ ì¶©ì „ ë°©ì‹</span>
              <select id="chargeMethod">
                <option value="token" data-i18n="ch.charge_token">í† í°</option>
                <option value="ad" data-i18n="ch.charge_ad">ê´‘ê³ </option>
              </select>
            </label>
          </div>

          <div class="row">
            <label><span data-i18n="ch.ticket_cost">í‹°ì¼“ ë¹„ìš© (íšŒë‹¹)</span>
              <input id="ticketCost" type="number" min="1" step="1" value="1" />
            </label>
            <label><span data-i18n="ch.lp_free">ë ˆì „ë“œ íŒ¨ìŠ¤ ë¬´ë£Œì¶©ì „ ì ìš© (1íšŒ)</span>
              <input id="lpFree" type="checkbox" />
            </label>
          </div>

          <div class="row">
            <label><span data-i18n="ch.mobile_srv">ì•ˆë“œë¡œì´ë“œ/iOS ì„œë²„</span>
              <input id="mobileSrv" type="checkbox" />
            </label>
            <label><span data-i18n="ch.ad_sec">ê´‘ê³  ì‹œì²­ ì‹œê°„ (ì´ˆ)</span>
              <input id="adSec" type="number" min="1" step="1" value="30" />
            </label>
          </div>

          <div class="row">
            <label><span data-i18n="ch.ticket_ad_max">í‹°ì¼“ ê´‘ê³  ìµœëŒ€ íšŸìˆ˜</span>
              <input id="ticketAdMax" type="number" min="0" step="1" value="40" />
            </label>
            <label><span data-i18n="ch.credit_ad">í¬ë ˆë”§ ê´‘ê³  ì—¬ë¶€</span>
              <input id="creditAd" type="checkbox" checked />
            </label>
          </div>

          <div class="row">
            <label><span data-i18n="ch.credit_ad_max">í¬ë ˆë”§ ê´‘ê³  ìµœëŒ€ íšŸìˆ˜</span>
              <input id="creditAdMax" type="number" min="0" step="1" value="40" />
            </label>
            <label><span data-i18n="ch.map_sec">ë§µ 1íšŒ í”Œë ˆì´ ì‹œê°„ (ì´ˆ)</span>
              <input id="mapSec" type="number" min="1" step="1" value="38" />
            </label>
          </div>

          <label><span data-i18n="ch.lobby_sec">ë¡œë¹„ ì²´ë¥˜ ì‹œê°„ (ì´ˆ)</span>
            <input id="lobbySec" type="number" min="0" step="1" value="20" />
          </label>

          <label><span data-i18n="ch.packs">ì‚¬ëƒ¥ 1íŒë‹¹ íŒ© ê°œìˆ˜</span>
            <input id="packs" type="number" min="1" step="1" value="3" />
          </label>

          <hr style="border:0;border-top:1px solid var(--border); margin:10px 0">

          <!-- ëª©í‘œ ê¸°ì¤€ íƒ­ -->
          <div id="tab-goal">
            <div class="row">
              <label><span data-i18n="ch.goal_type">ëª©í‘œ ìœ í˜•</span>
                <select id="goalType">
                  <option value="bp" data-i18n="ch.goal_bp">ì²­ì‚¬ì§„</option>
                  <option value="sp" data-i18n="ch.goal_sp">íŠ¹ìˆ˜ë¶€í’ˆ</option>
                </select>
              </label>
              <label class="muted"><span data-i18n="ch.sim_count">ì‹œë®¬ë ˆì´ì…˜ íšŸìˆ˜ (ê³ ì •)</span>
                <input id="trials" type="number" value="1000" disabled />
              </label>
            </div>

            <div class="row">
              <label><span data-i18n="ch.target_bp">ëª©í‘œ ì²­ì‚¬ì§„ ìˆ˜</span>
                <input id="targetBP" type="number" min="1" step="1" value="300" />
              </label>
              <label><span data-i18n="ch.target_sp">ëª©í‘œ íŠ¹ìˆ˜ë¶€í’ˆ ìˆ˜</span>
                <input id="targetSP" type="number" min="1" step="1" value="16" />
              </label>
            </div>

            <div class="row">
              <label><span data-i18n="ch.bp_per_drop">ì²­ì‚¬ì§„ ë“œë ì‹œ íšë“ëŸ‰</span>
                <input id="bpPerDrop" type="number" min="1" step="1" value="1" />
              </label>
              <label><span data-i18n="ch.bp_rate">ì²­ì‚¬ì§„ ë“œë í™•ë¥  (ê¸°ë³¸)</span>
                <input id="pBP" type="number" min="0" max="1" step="0.001" value="0.08" />
              </label>
            </div>

            <label><span data-i18n="ch.sp_rate">íŠ¹ìˆ˜ë¶€í’ˆ ë“œë í™•ë¥ </span>
              <input id="pSP" type="number" min="0" max="1" step="0.001" value="0.04" />
            </label>

            <div style="margin-top:12px">
              <div class="row" style="align-items:center">
                <label style="grid-column:1 / -1; display:flex; align-items:center; gap:10px">
                  <span class="pill" data-i18n="ch.use_segments">êµ¬ê°„ë³„ ì²­ì‚¬ì§„ í™•ë¥  ì‚¬ìš©</span>
                  <input id="useSegments" type="checkbox" />
                  <span class="muted" style="margin-left:6px" data-i18n="ch.segment_example">ì˜ˆ: 0~120ì¥ 8%, 121~150ì¥ 5%,
                    151~âˆ 3%</span>
                </label>
              </div>
              <table class="seg-table" id="segTable">
                <thead>
                  <tr>
                    <th data-i18n="ch.seg_start">ì‹œì‘ BP</th>
                    <th data-i18n="ch.seg_end">ë BP (í¬í•¨)</th>
                    <th data-i18n="ch.seg_prob">í™•ë¥  p (0~1)</th>
                    <th></th>
                  </tr>
                </thead>
                <tbody id="segTbody"></tbody>
              </table>
              <div class="actions">
                <button id="addSeg" class="sub" data-i18n="ch.add_segment">+ êµ¬ê°„ ì¶”ê°€</button>
                <button id="resetSeg" class="sub" data-i18n="ch.reset_segment">êµ¬ê°„ ê¸°ë³¸ê°’</button>
              </div>
            </div>
          </div>

          <!-- ì‹œê°„ ê¸°ì¤€ íƒ­ -->
          <div id="tab-time" class="hidden">
            <h2 data-i18n="ch.time_input">ì‹œê°„ ê¸°ì¤€ ì…ë ¥</h2>
            <div class="row">
              <label><span data-i18n="ch.time_h">ì´ ì‚¬ëƒ¥ ì‹œê°„ â€” ì‹œ</span>
                <input id="timeH" type="number" min="0" step="1" value="1" />
              </label>
              <label><span data-i18n="ch.time_m">ì´ ì‚¬ëƒ¥ ì‹œê°„ â€” ë¶„</span>
                <input id="timeM" type="number" min="0" max="59" step="1" value="0" />
              </label>
            </div>
            <label><span data-i18n="ch.time_s">ì´ ì‚¬ëƒ¥ ì‹œê°„ â€” ì´ˆ</span>
              <input id="timeS" type="number" min="0" max="59" step="1" value="0" />
            </label>

            <div class="row" style="margin-top:6px">
              <label class="muted"><span data-i18n="ch.sim_count">ì‹œë®¬ë ˆì´ì…˜ íšŸìˆ˜ (ê³ ì •)</span>
                <input id="trialsTime" type="number" value="1000" disabled />
              </label>
              <label><span data-i18n="ch.result_type">ê²°ê³¼ ê¸°ì¤€</span>
                <select id="timeGoalType">
                  <option value="bp" data-i18n="ch.goal_bp">ì²­ì‚¬ì§„</option>
                  <option value="sp" data-i18n="ch.goal_sp">íŠ¹ìˆ˜ë¶€í’ˆ</option>
                  <option value="both" data-i18n="ch.goal_both">ë‘˜ ë‹¤</option>
                </select>
              </label>
            </div>

            <hr style="border:0;border-top:1px solid var(--border); margin:10px 8px">

            <h3 style="margin:6px 0 4px" data-i18n="ch.prob_settings">í™•ë¥  ì„¤ì • (ì‹œê°„ ê¸°ì¤€)</h3>
            <div class="row">
              <label><span data-i18n="ch.bp_base_rate">ì²­ì‚¬ì§„ ê¸°ë³¸ í™•ë¥  (pBP)</span>
                <input id="pBP_time" type="number" min="0" max="1" step="0.001" value="0.08" />
              </label>
              <label><span data-i18n="ch.sp_base_rate">íŠ¹ìˆ˜ë¶€í’ˆ ê¸°ë³¸ í™•ë¥  (pSP)</span>
                <input id="pSP_time" type="number" min="0" max="1" step="0.001" value="0.04" />
              </label>
            </div>
            <div class="row" style="align-items:center">
              <label style="grid-column:1 / -1; display:flex; align-items:center; gap:10px">
                <span class="pill" data-i18n="ch.use_bp_seg">êµ¬ê°„ë³„ ì²­ì‚¬ì§„ í™•ë¥  ì‚¬ìš©</span>
                <input id="useSegmentsBP_time" type="checkbox" />
                <span class="muted" data-i18n="ch.seg_off_hint">(ë„ë©´ pBP ê¸°ë³¸ê°’ ì‚¬ìš©)</span>
              </label>
            </div>
            <table class="seg-table" id="segTableBP_time">
              <thead>
                <tr>
                  <th data-i18n="ch.seg_start">ì‹œì‘ BP</th>
                  <th data-i18n="ch.seg_end">ë BP (í¬í•¨)</th>
                  <th>pBP (0~1)</th>
                  <th></th>
                </tr>
              </thead>
              <tbody id="segTbodyBP_time"></tbody>
            </table>
            <div class="actions">
              <button id="addSegBP_time" class="sub" data-i18n="ch.add_bp_seg">+ BP êµ¬ê°„ ì¶”ê°€</button>
              <button id="resetSegBP_time" class="sub" data-i18n="ch.reset_bp_seg">BP êµ¬ê°„ ê¸°ë³¸ê°’</button>
            </div>

            <div class="row" style="align-items:center; margin-top:12px">
              <label style="grid-column:1 / -1; display:flex; align-items:center; gap:10px">
                <span class="pill" data-i18n="ch.use_sp_seg">êµ¬ê°„ë³„ íŠ¹ìˆ˜ë¶€í’ˆ í™•ë¥  ì‚¬ìš©</span>
                <input id="useSegmentsSP_time" type="checkbox" />
                <span class="muted" data-i18n="ch.seg_off_hint">(ë„ë©´ pSP ê¸°ë³¸ê°’ ì‚¬ìš©)</span>
              </label>
            </div>
            <table class="seg-table" id="segTableSP_time">
              <thead>
                <tr>
                  <th data-i18n="ch.sp_seg_start">ì‹œì‘ SP</th>
                  <th data-i18n="ch.sp_seg_end">ë SP (í¬í•¨)</th>
                  <th data-i18n="ch.sp_seg_prob">pSP (0~1)</th>
                  <th></th>
                </tr>
              </thead>
              <tbody id="segTbodySP_time"></tbody>
            </table>
            <div class="actions">
              <button id="addSegSP_time" class="sub" data-i18n="ch.add_sp_seg">+ SP êµ¬ê°„ ì¶”ê°€</button>
              <button id="resetSegSP_time" class="sub" data-i18n="ch.reset_sp_seg">SP êµ¬ê°„ ê¸°ë³¸ê°’</button>
            </div>
          </div>

          <div class="actions">
            <button id="run" class="primary" data-i18n="ch.run_sim">ì‹œë®¬ë ˆì´ì…˜ ì‹¤í–‰ (1000íšŒ)</button>
            <button id="reset" class="sub" data-i18n="ch.restore_default">ê¸°ë³¸ê°’ ë³µì›</button>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="body">
          <h2 data-i18n="ch.result">ê²°ê³¼</h2>
          <div class="result" id="resultBox">
            <div class="stat">
              <div class="k" data-i18n="ch.res_time">ê±¸ë¦° ì‹œê°„</div>
              <div class="v" id="timeStr">-</div>
            </div>
            <div class="stat">
              <div class="k" data-i18n="ch.res_tokens">ì‚¬ìš©í•œ í† í°</div>
              <div class="v" id="tokensUsed">-</div>
            </div>
            <div class="stat">
              <div class="k" data-i18n="ch.res_bp">íšë“í•œ ì²­ì‚¬ì§„ ìˆ˜</div>
              <div class="v" id="bpGained">-</div>
            </div>
            <div class="stat">
              <div class="k" data-i18n="ch.res_sp">íšë“í•œ íŠ¹ìˆ˜ë¶€í’ˆ ìˆ˜</div>
              <div class="v" id="spGained">-</div>
            </div>
            <div class="stat">
              <div class="k" data-i18n="ch.res_p595">(ì°¸ê³ ) 5%~95% ì‹œê°„/íšë“ì¹˜</div>
              <div class="v" id="p595Time">-</div>
            </div>
            <div class="stat">
              <div class="k" data-i18n="ch.res_std">(ì°¸ê³ ) í‘œì¤€í¸ì°¨</div>
              <div class="v" id="stdTime">-</div>
            </div>
          </div>
          <h2 style="margin-top:14px" data-i18n="ch.histogram">íˆìŠ¤í† ê·¸ë¨</h2>
          <canvas id="hist"></canvas>
          <div class="actions" style="margin-top:12px">
            <label style="display:flex; align-items:center; gap:8px; margin:0">
              <span data-i18n="ch.summary_fmt">ìš”ì•½ í˜•ì‹</span>
              <select id="summaryFmt">
                <option value="text" data-i18n="ch.fmt_text">í…ìŠ¤íŠ¸</option>
                <option value="md" data-i18n="ch.fmt_md">Markdown</option>
                <option value="discord" data-i18n="ch.fmt_discord">Discord</option>
              </select>
            </label>
            <button id="copySummary" class="sub" disabled data-i18n="ch.copy_summary">ìš”ì•½ ë³µì‚¬</button>
            <button id="saveImage" class="sub" disabled data-i18n="ch.save_image">ì´ë¯¸ì§€ ì €ì¥(PNG)</button>
          </div>
          <div class="footer mono" id="paramsEcho"></div>
        </div>
      </div>
    </div>

    <div class="twocol" style="margin-top:var(--gap)">
      <div class="card">
        <div class="body">
          <h2 data-i18n="ch.history">ğŸ•’ ìµœê·¼ 5íšŒ íˆìŠ¤í† ë¦¬</h2>
          <ul id="historyList" class="list"></ul>
          <div class="actions">
            <button id="clearHistory" class="warn" data-i18n="ch.clear_history">íˆìŠ¤í† ë¦¬ ë¹„ìš°ê¸°</button>
          </div>
        </div>
      </div>
      <div class="card">
        <div class="body">
          <h2 data-i18n="ch.presets">â­ í”„ë¦¬ì…‹</h2>
          <div class="actions">
            <input id="presetName" type="text" data-i18n-ph="ch.preset_name" placeholder="í”„ë¦¬ì…‹ ì´ë¦„" class="grow">
            <button id="savePreset" class="sub" data-i18n="common.save">ì €ì¥</button>
            <button id="exportPresets" class="sub" data-i18n="ch.export_json">ë‚´ë³´ë‚´ê¸°(JSON)</button>
            <input id="importFile" type="file" accept="application/json" style="display:none">
            <button id="importPresets" class="sub" data-i18n="ch.import_json">ê°€ì ¸ì˜¤ê¸°</button>
          </div>
          <ul id="presetList" class="list"></ul>
        </div>
      </div>
    </div>

  </div>
  <script>
    (function () {
      const $ = (id) => document.getElementById(id);
      const TOKEN_PER_TICKET = 5; // 1ì¥ë‹¹ í† í° ë¹„ìš©(ê³ ì •)
      let lastStats = null;

      const STORAGE_KEYS = {
        history: 'carhunt_history_v1',
        presets: 'carhunt_presets_v1'
      };

      function nowStr() {
        const d = new Date();
        const y = d.getFullYear(); const m = String(d.getMonth() + 1).padStart(2, '0'); const dd = String(d.getDate()).padStart(2, '0');
        const hh = String(d.getHours()).padStart(2, '0'); const mi = String(d.getMinutes()).padStart(2, '0'); const ss = String(d.getSeconds()).padStart(2, '0');
        return `${y}-${m}-${dd} ${hh}:${mi}:${ss}`;
      }

      // ===== Tabs =====
      const tabBtns = document.querySelectorAll('.tab');
      tabBtns.forEach(btn => btn.addEventListener('click', () => {
        tabBtns.forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        const t = btn.dataset.tab;
        document.getElementById('tab-goal').classList.toggle('hidden', t !== "goal");
        document.getElementById('tab-time').classList.toggle('hidden', t !== "time");
      }));

      // ===== Segment editors (same as v1.4, with tbody-only readers) =====
      function segRow(start = 0, end = 120, p = 0.08) {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td><input type="number" min="0" step="1" class="seg-start" value="${start}"></td>
                    <td><input type="number" min="0" step="1" class="seg-end" value="${end}"></td>
                    <td><input type="number" min="0" max="1" step="0.001" class="seg-p" value="${p}"></td>
                    <td><button class="warn seg-del">${I18N.t('common.delete')}</button></td>`;
        tr.querySelector('.seg-del').addEventListener('click', () => { tr.remove(); });
        return tr;
      }
      function loadSegDefault() {
        const tb = $('segTbody'); tb.innerHTML = '';
        tb.appendChild(segRow(0, 120, 0.08));
        tb.appendChild(segRow(121, 150, 0.05));
        tb.appendChild(segRow(151, 999999, 0.03));
      }
      function readSegments() {
        const rows = Array.from(document.querySelectorAll('#segTbody tr'));
        const segs = rows.map(r => ({ s: +r.querySelector('.seg-start').value, e: +r.querySelector('.seg-end').value, p: +r.querySelector('.seg-p').value }))
          .filter(x => x.p >= 0 && x.p <= 1);
        segs.sort((a, b) => a.s - b.s);
        return segs;
      }
      $('addSeg').addEventListener('click', (e) => { e.preventDefault(); $('segTbody').appendChild(segRow()); });
      $('resetSeg').addEventListener('click', (e) => { e.preventDefault(); loadSegDefault(); });
      loadSegDefault();

      function segRowTime(type, start = 0, end = 120, p = type === 'bp' ? 0.08 : 0.04) {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td><input type="number" min="0" step="1" class="seg-start"></td>
                    <td><input type="number" min="0" step="1" class="seg-end"></td>
                    <td><input type="number" min="0" max="1" step="0.001" class="seg-p"></td>
                    <td><button class="warn seg-del">${I18N.t('common.delete')}</button></td>`;
        const inputs = tr.querySelectorAll('input');
        inputs[0].value = start; inputs[1].value = end; inputs[2].value = p;
        tr.querySelector('.seg-del').addEventListener('click', () => tr.remove());
        return tr;
      }
      function loadSegDefaultBP_time() { const tb = $('segTbodyBP_time'); tb.innerHTML = ''; tb.appendChild(segRowTime('bp', 0, 120, 0.08)); tb.appendChild(segRowTime('bp', 121, 150, 0.05)); tb.appendChild(segRowTime('bp', 151, 999999, 0.03)); }
      function loadSegDefaultSP_time() { const tb = $('segTbodySP_time'); tb.innerHTML = ''; tb.appendChild(segRowTime('sp', 0, 7, 0.04)); tb.appendChild(segRowTime('sp', 8, 12, 0.03)); tb.appendChild(segRowTime('sp', 13, 999999, 0.02)); }
      function readSegmentsFrom(tableSel) {
        const rows = Array.from(document.querySelectorAll(tableSel + ' tbody tr'));
        const segs = rows.map(r => {
          const sEl = r.querySelector('.seg-start');
          const eEl = r.querySelector('.seg-end');
          const pEl = r.querySelector('.seg-p');
          if (!sEl || !eEl || !pEl) return null;
          return { s: +sEl.value, e: +eEl.value, p: +pEl.value };
        }).filter(Boolean).filter(x => x.p >= 0 && x.p <= 1);
        segs.sort((a, b) => a.s - b.s); return segs;
      }
      $('addSegBP_time').addEventListener('click', e => { e.preventDefault(); $('segTbodyBP_time').appendChild(segRowTime('bp')); });
      $('resetSegBP_time').addEventListener('click', e => { e.preventDefault(); loadSegDefaultBP_time(); });
      $('addSegSP_time').addEventListener('click', e => { e.preventDefault(); $('segTbodySP_time').appendChild(segRowTime('sp')); });
      $('resetSegSP_time').addEventListener('click', e => { e.preventDefault(); loadSegDefaultSP_time(); });
      loadSegDefaultBP_time(); loadSegDefaultSP_time();

      // ===== Defaults snapshot =====
      const ids = ['autoRate', 'chargeMethod', 'ticketCost', 'lpFree', 'mobileSrv', 'adSec', 'ticketAdMax', 'creditAd', 'creditAdMax', 'mapSec', 'lobbySec', 'packs', 'goalType', 'trials', 'targetBP', 'targetSP', 'bpPerDrop', 'pBP', 'pSP', 'useSegments', 'timeH', 'timeM', 'timeS', 'trialsTime', 'timeGoalType', 'useSegmentsBP_time', 'useSegmentsSP_time', 'pBP_time', 'pSP_time'];
      const defaults = Object.fromEntries(ids.map(id => [id, $(id) ? ($(id).type === 'checkbox' ? $(id).checked : $(id).value) : null]));

      // ===== Utils =====
      function fmtHMS(totalSec) {
        const s = Math.round(totalSec); const h = Math.floor(s / 3600); const m = Math.floor((s % 3600) / 60); const r = s % 60;
        return `${String(h).padStart(2, '0')}${I18N.t('common.hour')} ${String(m).padStart(2, '0')}${I18N.t('common.minute')} ${String(r).padStart(2, '0')}${I18N.t('common.second')} (${(s / 3600).toFixed(2)}${I18N.t('common.hour')}, ${(s / 86400).toFixed(1)}${I18N.t('common.day')})`;
      }
      function quantiles(arr, qs) { const a = [...arr].sort((x, y) => x - y); const n = a.length; const out = {}; qs.forEach(q => { const i = (n - 1) * q; const lo = Math.floor(i), hi = Math.ceil(i); out[q] = lo === hi ? a[lo] : a[lo] * (hi - i) + a[hi] * (i - lo); }); return out; }
      function mean(a) { return a.reduce((s, v) => s + v, 0) / a.length }
      function std(a) { const m = mean(a); return Math.sqrt(mean(a.map(x => (x - m) ** 2))) }
      function clone(obj) { return JSON.parse(JSON.stringify(obj)); }

      // ===== Enable/disable logic =====
      function updateEnables() {
        const isBP = $('goalType').value === 'bp';
        $('targetBP').disabled = !isBP; $('bpPerDrop').disabled = !isBP; $('pBP').disabled = !isBP || $('useSegments').checked;
        $('targetSP').disabled = isBP; $('pSP').disabled = isBP;

        const method = $('chargeMethod').value; $('ticketAdMax').disabled = method !== 'ad';
        const mobile = $('mobileSrv').checked; $('adSec').disabled = mobile; if (mobile) { $('adSec').value = 40; }

        const segOn = $('useSegments').checked && isBP;
        document.getElementById('segTable').style.opacity = segOn ? 1 : .4;
        document.getElementById('addSeg').disabled = !segOn;
        document.getElementById('resetSeg').disabled = !segOn;

        const segBPtime = document.getElementById('useSegmentsBP_time').checked;
        const segSPtime = document.getElementById('useSegmentsSP_time').checked;
        const pBPtimeEl = document.getElementById('pBP_time');
        const pSPtimeEl = document.getElementById('pSP_time');
        if (pBPtimeEl) pBPtimeEl.disabled = segBPtime;
        if (pSPtimeEl) pSPtimeEl.disabled = segSPtime;
      }
      ;['goalType', 'chargeMethod', 'mobileSrv', 'autoRate', 'useSegments', 'useSegmentsBP_time', 'useSegmentsSP_time']
        .forEach(id => $(id).addEventListener('change', updateEnables));

      // ===== Time & tickets =====
      function advanceTime(state, sec) {
        state.time += sec; state.autoLeft -= sec;
        while (state.autoLeft <= 0) { if (state.tickets < 10) state.tickets += 1; state.autoLeft += state.autoPeriod; }
      }

      function currentPBP(bp, cfg) {
        if (!(cfg.useSegments) || cfg.goalType !== "bp") return cfg.pBP;
        for (const seg of cfg.bpSegs) { if (bp >= seg.s && bp <= seg.e) return seg.p; }
        return cfg.pBP;
      }

      // ===== Simulators =====
      function simulateOnceGoal(cfg) {
        const st = { time: 0, tickets: 10, tokens: 0, autoPeriod: 600 / (cfg.autoRate / 100), autoLeft: 600 / (cfg.autoRate / 100), creditAdLeft: cfg.creditAd ? cfg.creditAdMax : 0, ticketAdLeft: cfg.chargeMethod === 'ad' ? cfg.ticketAdMax : 0, lpLeft: cfg.lpFree ? 1 : 0, bp: 0, sp: 0 };
        const goalReached = () => cfg.goalType === 'bp' ? (st.bp >= cfg.targetBP) : (st.sp >= cfg.targetSP);
        while (!goalReached()) {
          if (st.tickets < cfg.ticketCost) {
            if (st.lpLeft > 0) { st.lpLeft = 0; st.tickets = 10; }
            else if (cfg.chargeMethod === 'ad' && st.ticketAdLeft > 0) {
              while (st.tickets < cfg.ticketCost && st.ticketAdLeft > 0) { st.ticketAdLeft--; st.tickets++; advanceTime(st, cfg.adSec); }
              while (st.tickets < cfg.ticketCost) { st.tokens += TOKEN_PER_TICKET; st.tickets++; }
            } else {
              while (st.tickets < cfg.ticketCost) { st.tokens += TOKEN_PER_TICKET; st.tickets++; }
            }
          }
          st.tickets -= cfg.ticketCost;
          if (cfg.creditAd && st.creditAdLeft > 0) { st.creditAdLeft--; advanceTime(st, +cfg.adSec); }
          advanceTime(st, +cfg.mapSec + +cfg.lobbySec);
          if (cfg.goalType === 'bp') {
            for (let k = 0; k < cfg.packs; k++) {
              const pb = currentPBP(st.bp, cfg);
              if (Math.random() < pb) st.bp += cfg.bpPerDrop;
            }
          } else {
            for (let k = 0; k < cfg.packs; k++) {
              const ps = cfg.pSP;
              if (Math.random() < ps) st.sp += 1;
            }
          }
        }
        return st;
      }

      function simulateOnceTime(cfg) {
        const limit = cfg.timeH * 3600 + cfg.timeM * 60 + cfg.timeS;
        const st = { time: 0, tickets: 10, tokens: 0, autoPeriod: 600 / (cfg.autoRate / 100), autoLeft: 600 / (cfg.autoRate / 100), creditAdLeft: cfg.creditAd ? cfg.creditAdMax : 0, ticketAdLeft: cfg.chargeMethod === 'ad' ? cfg.ticketAdMax : 0, lpLeft: cfg.lpFree ? 1 : 0, bp: 0, sp: 0 };
        const pBP_time = (bp) => { if (!cfg.useSegmentsBP_time) return cfg.pBP_time; for (const seg of cfg.bpSegs_time) { if (bp >= seg.s && bp <= seg.e) return seg.p; } return cfg.pBP_time; };
        const pSP_time = (sp) => { if (!cfg.useSegmentsSP_time) return cfg.pSP_time; for (const seg of cfg.spSegs_time) { if (sp >= seg.s && sp <= seg.e) return seg.p; } return cfg.pSP_time; };

        while (st.time < limit) {
          if (st.tickets < cfg.ticketCost) {
            if (st.lpLeft > 0) { st.lpLeft = 0; st.tickets = 10; }
            else if (cfg.chargeMethod === 'ad' && st.ticketAdLeft > 0) {
              while (st.tickets < cfg.ticketCost && st.ticketAdLeft > 0) { st.ticketAdLeft--; st.tickets++; advanceTime(st, cfg.adSec); if (st.time >= limit) break; }
              while (st.tickets < cfg.ticketCost && st.time < limit) { st.tokens += TOKEN_PER_TICKET; st.tickets++; }
            } else {
              while (st.tickets < cfg.ticketCost && st.time < limit) { st.tokens += TOKEN_PER_TICKET; st.tickets++; }
            }
          }
          if (st.time >= limit) break;

          st.tickets -= cfg.ticketCost;
          if (cfg.creditAd && st.creditAdLeft > 0) { st.creditAdLeft--; advanceTime(st, +cfg.adSec); if (st.time >= limit) break; }
          const runDur = +cfg.mapSec + +cfg.lobbySec; advanceTime(st, runDur); if (st.time > limit) break;

          if (cfg.timeGoalType === 'bp') {
            for (let k = 0; k < cfg.packs; k++) {
              const pb = pBP_time(st.bp);
              if (Math.random() < pb) st.bp += cfg.bpPerDrop;
            }
          }
          else if (cfg.timeGoalType === 'sp') {
            for (let k = 0; k < cfg.packs; k++) {
              const ps = pSP_time(st.sp);
              if (Math.random() < ps) st.sp += 1;
            }
          }
          else { // both
            for (let k = 0; k < cfg.packs; k++) {
              const pb = pBP_time(st.bp);
              const ps = pSP_time(st.sp);
              if (Math.random() < pb) st.bp += cfg.bpPerDrop;
              if (Math.random() < ps) st.sp += 1;
            }
          }
        }
        return st;
      }

      // ===== Chart =====
      function cssVar(name) { try { return getComputedStyle(document.documentElement).getPropertyValue(name).trim() || name } catch (e) { return name } }
      function drawHist(canvas, data, title) {
        const ctx = canvas.getContext('2d');
        if (!ctx) return;
        const DPR = window.devicePixelRatio || 1;
        const W = canvas.width = Math.max(800, canvas.clientWidth * DPR);
        const H = canvas.height = Math.max(300, canvas.clientHeight * DPR);
        ctx.scale(DPR, DPR);
        ctx.clearRect(0, 0, W, H);
        const nbin = 24; const min = Math.min(...data), max = Math.max(...data);
        const eps = (max - min) || 1; const step = eps / nbin; const bins = new Array(nbin).fill(0);
        data.forEach(v => { let i = Math.min(nbin - 1, Math.max(0, Math.floor((v - min) / step))); bins[i]++; });
        const ymax = Math.max(...bins);
        ctx.strokeStyle = cssVar('--control-border'); ctx.lineWidth = 1; ctx.beginPath(); ctx.moveTo(36, H / DPR - 30); ctx.lineTo(W / DPR - 12, H / DPR - 30); ctx.stroke();
        const barW = (W / DPR - 60) / nbin;
        for (let i = 0; i < nbin; i++) {
          const x = 36 + i * barW + 2; const h = Math.round((bins[i] / ymax) * (H / DPR - 60));
          ctx.fillStyle = cssVar('--accent'); ctx.globalAlpha = 0.85; ctx.fillRect(x, H / DPR - 30 - h, barW - 4, h);
        }
        ctx.globalAlpha = 1; ctx.fillStyle = cssVar('--muted'); ctx.font = '12px ui-sans-serif, system-ui, Segoe UI';
        ctx.fillText(title || 'ë¶„í¬', 12, 16);
        const tickN = 6;
        for (let t = 0; t < tickN; t++) {
          const x = 36 + ((W / DPR - 60) / (tickN - 1)) * t;
          const val = Math.round(min + (eps / (tickN - 1)) * t);
          ctx.fillText(String(val), x - 8, H / DPR - 10);
        }
      }

      // ===== Config & echo =====
      function currentCfg() {
        return {
          autoRate: +$('autoRate').value,
          chargeMethod: $('chargeMethod').value,
          ticketCost: +$('ticketCost').value,
          lpFree: $('lpFree').checked,
          mobileSrv: $('mobileSrv').checked,
          adSec: +$('adSec').value,
          ticketAdMax: +$('ticketAdMax').value,
          creditAd: $('creditAd').checked,
          creditAdMax: +$('creditAdMax').value,
          mapSec: +$('mapSec').value,
          lobbySec: +$('lobbySec').value,
          packs: +$('packs').value,
          goalType: $('goalType').value,
          trials: 1000,
          targetBP: +$('targetBP').value,
          targetSP: +$('targetSP').value,
          bpPerDrop: +$('bpPerDrop').value,
          pBP: +$('pBP').value,
          pSP: +$('pSP').value,
          useSegments: $('useSegments').checked,
          bpSegs: readSegments(),
          // time mode
          timeH: +$('timeH').value, timeM: +$('timeM').value, timeS: +$('timeS').value,
          timeGoalType: $('timeGoalType').value,
          useSegmentsBP_time: $('useSegmentsBP_time').checked,
          useSegmentsSP_time: $('useSegmentsSP_time').checked,
          pBP_time: +$('pBP_time').value,
          pSP_time: +$('pSP_time').value,
          bpSegs_time: readSegmentsFrom('#segTableBP_time'),
          spSegs_time: readSegmentsFrom('#segTableSP_time'),
        };
      }

      function applyCfg(cfg) {
        function set(id, v) { const el = $(id); if (!el) return; if (el.type === 'checkbox') el.checked = !!v; else el.value = v; }
        set('autoRate', cfg.autoRate); set('chargeMethod', cfg.chargeMethod); set('ticketCost', cfg.ticketCost);
        set('lpFree', cfg.lpFree); set('mobileSrv', cfg.mobileSrv); set('adSec', cfg.adSec);
        set('ticketAdMax', cfg.ticketAdMax); set('creditAd', cfg.creditAd); set('creditAdMax', cfg.creditAdMax);
        set('mapSec', cfg.mapSec); set('lobbySec', cfg.lobbySec); set('packs', cfg.packs);
        set('goalType', cfg.goalType); set('targetBP', cfg.targetBP); set('targetSP', cfg.targetSP);
        set('bpPerDrop', cfg.bpPerDrop); set('pBP', cfg.pBP); set('pSP', cfg.pSP);
        set('useSegments', cfg.useSegments);

        // goal segs
        const tb = $('segTbody'); tb.innerHTML = '';
        (cfg.bpSegs || []).forEach(s => tb.appendChild(segRow(s.s, s.e, s.p)));

        // time
        set('timeH', cfg.timeH); set('timeM', cfg.timeM); set('timeS', cfg.timeS);
        set('timeGoalType', cfg.timeGoalType);
        set('useSegmentsBP_time', cfg.useSegmentsBP_time);
        set('useSegmentsSP_time', cfg.useSegmentsSP_time);
        set('pBP_time', cfg.pBP_time); set('pSP_time', cfg.pSP_time);
        const tbBP = $('segTbodyBP_time'); tbBP.innerHTML = '';
        (cfg.bpSegs_time || []).forEach(s => tbBP.appendChild(segRowTime('bp', s.s, s.e, s.p)));
        const tbSP = $('segTbodySP_time'); tbSP.innerHTML = '';
        (cfg.spSegs_time || []).forEach(s => tbSP.appendChild(segRowTime('sp', s.s, s.e, s.p)));

        updateEnables();
      }

      function echoParams(cfg) {
        const segInfo = cfg.useSegments ? ` | segs:${cfg.bpSegs.map(s => `[${s.s}~${s.e}:${s.p}]`).join(',')}` : '';
        const tStr = `${String(cfg.timeH).padStart(2, '0')}:${String(cfg.timeM).padStart(2, '0')}:${String(cfg.timeS).padStart(2, '0')}`;
        const segBP = cfg.useSegmentsBP_time ? ` | BPsegs:${cfg.bpSegs_time.map(s => `[${s.s}~${s.e}:${s.p}]`).join(',')}` : '';
        const segSP = cfg.useSegmentsSP_time ? ` | SPsegs:${cfg.spSegs_time.map(s => `[${s.s}~${s.e}:${s.p}]`).join(',')}` : '';
        const echo = `${I18N.t('common.input')} â€” goal:${cfg.goalType} target:${cfg.goalType === 'bp' ? cfg.targetBP : cfg.targetSP} | auto:${cfg.autoRate}% | method:${cfg.chargeMethod} (ad ${cfg.adSec}s, ticketAdMax ${cfg.ticketAdMax}) | creditAd:${cfg.creditAd ? 'ON' : ''}/${cfg.creditAdMax} | map:${cfg.mapSec}s lobby:${cfg.lobbySec}s | packs:${cfg.packs} | pBP:${cfg.pBP} bpPer:${cfg.bpPerDrop} pSP:${cfg.pSP} | trials:1000 | time:${tStr} | timeGoal:${cfg.timeGoalType}${segInfo}${segBP}${segSP}`;
        const el = document.getElementById('paramsEcho'); if (el) el.textContent = echo;
        return echo;
      }

      function collectParamsEcho(cfg) {
        return `goal:${cfg.goalType} target:${cfg.goalType === 'bp' ? cfg.targetBP : cfg.targetSP} | auto:${cfg.autoRate}% | method:${cfg.chargeMethod} (ad ${cfg.adSec}s, ticketAdMax ${cfg.ticketAdMax}) | creditAd:${cfg.creditAd ? 'ON' : ''}/${cfg.creditAdMax} | map:${cfg.mapSec}s lobby:${cfg.lobbySec}s | packs:${cfg.packs} | pBP:${cfg.pBP} bpPer:${cfg.bpPerDrop} pSP:${cfg.pSP} | time:${String(cfg.timeH).padStart(2, '0')}:${String(cfg.timeM).padStart(2, '0')}:${String(cfg.timeS).padStart(2, '0')} | timeGoal:${cfg.timeGoalType}`;
      }

      // ===== Summary & Export (copy/image as in v1.4) =====
      function buildSummary(fmt) {
        if (!lastStats) return '';
        const stamp = nowStr();
        const lines = [
          `# ${I18N.t('ch.summary_title')} (${stamp})`,
          `${I18N.t('ch.sum_mode')}: ${lastStats.mode}`,
          `${I18N.t('ch.sum_time')}: ${fmtHMS(lastStats.avgSec)}`,
          `${I18N.t('ch.sum_tokens')}: ${lastStats.tokens}`,
          `${I18N.t('ch.sum_bp')}: ${lastStats.bp}${I18N.t('ch.sheet')} | ${I18N.t('ch.sum_sp')}: ${lastStats.sp}${I18N.t('ch.unit')}`,
          `5%~95%: ${lastStats.p595}`,
          `${I18N.t('ch.sum_std')}: ${lastStats.sd}`,
          `${I18N.t('ch.sum_input_summary')}: ${lastStats.params}`
        ];
        if (fmt === 'md') {
          return [
            `## ${I18N.t('ch.summary_title')} (${stamp})`,
            `- ${I18N.t('ch.sum_mode')}: **${lastStats.mode}**`,
            `- ${I18N.t('ch.sum_time')}: **${fmtHMS(lastStats.avgSec)}**`,
            `- ${I18N.t('ch.sum_tokens')}: **${lastStats.tokens}**`,
            `- ${I18N.t('ch.sum_bp')}/${I18N.t('ch.sum_sp')}: **${lastStats.bp}${I18N.t('ch.sheet')} / ${lastStats.sp}${I18N.t('ch.unit')}**`,
            `- 5%~95%: **${lastStats.p595}**`,
            `- ${I18N.t('ch.sum_std')}: **${lastStats.sd}**`,
            ``,
            `**${I18N.t('ch.sum_input_summary')}**`,
            `\`${lastStats.params}\``
          ].join('\n');
        } else if (fmt === 'discord') {
          return [
            '```md',
            `# Car Hunt Result (${stamp})`,
            `- Mode: ${lastStats.mode}`,
            `- Time: ${fmtHMS(lastStats.avgSec)}`,
            `- Tokens: ${lastStats.tokens}`,
            `- BP/SP: ${lastStats.bp}/${lastStats.sp}`,
            `- P5~P95: ${lastStats.p595}`,
            `- Std: ${lastStats.sd}`,
            '```',
            `${I18N.t('ch.sum_input')}: \`${lastStats.params}\``
          ].join('\n');
        }
        return lines.join('\n');
      }

      async function copySummary() {
        if (!lastStats) { alert(I18N.t('ch.run_first')); return; }
        const fmt = $('summaryFmt').value;
        const text = buildSummary(fmt);
        try {
          await navigator.clipboard.writeText(text);
          alert(I18N.t('ch.copy_success'));
        } catch (e) {
          const ta = document.createElement('textarea');
          ta.value = text; document.body.appendChild(ta); ta.select();
          try { document.execCommand('copy'); alert(I18N.t('ch.copy_success')); }
          catch (e2) { alert(I18N.t('ch.copy_fail')); }
          finally { document.body.removeChild(ta); }
        }
      }

      function saveImage() {
        if (!lastStats) { alert(I18N.t('ch.run_first')); return; }
        const src = $('hist');
        const DPR = window.devicePixelRatio || 1;
        const exportW = 1400, exportH = 900;
        const canvas = document.createElement('canvas');
        canvas.width = exportW; canvas.height = exportH;
        const ctx = canvas.getContext('2d');
        ctx.fillStyle = cssVar('--bg'); ctx.fillRect(0, 0, exportW, exportH);
        ctx.fillStyle = cssVar('--ink'); ctx.font = 'bold 28px ui-sans-serif, system-ui, Segoe UI';
        const stamp = nowStr();
        ctx.fillText(`${I18N.t('ch.img_title')} (${stamp})`, 24, 40);
        ctx.font = '16px ui-sans-serif, system-ui, Segoe UI'; ctx.fillStyle = cssVar('--muted');
        const stats = [
          `${I18N.t('ch.sum_mode')}: ${lastStats.mode}`,
          `${I18N.t('ch.sum_time')}: ${fmtHMS(lastStats.avgSec)}`,
          `${I18N.t('ch.sum_tokens')}: ${lastStats.tokens}`,
          `${I18N.t('ch.sum_bp')}/${I18N.t('ch.sum_sp')}: ${lastStats.bp} / ${lastStats.sp}`,
          `5%~95%: ${lastStats.p595}`,
          `${I18N.t('ch.sum_std')}: ${lastStats.sd}`
        ];
        stats.forEach((t, i) => ctx.fillText(t, 24, 80 + i * 22));
        const maxWidth = 820;
        const paramText = `${I18N.t('ch.sum_input')}: ${lastStats.params}`;
        wrapText(ctx, paramText, 24, 80 + stats.length * 22 + 16, maxWidth, 20);
        const thumbW = 1200, thumbH = 420;
        ctx.drawImage(src, 24, exportH - thumbH - 24, thumbW, thumbH);
        ctx.strokeStyle = cssVar('--control-border'); ctx.strokeRect(22, exportH - thumbH - 26, thumbW + 4, thumbH + 4);
        const a = document.createElement('a');
        a.href = canvas.toDataURL('image/png');
        const safe = stamp.replace(/[: ]/g, '-');
        a.download = `car-hunt-result-${safe}.png`;
        a.click();
      }

      function wrapText(ctx, text, x, y, maxWidth, lineHeight) {
        const words = text.split(' ');
        let line = '';
        for (let n = 0; n < words.length; n++) {
          const testLine = line + words[n] + ' ';
          const metrics = ctx.measureText(testLine);
          const testWidth = metrics.width;
          if (testWidth > maxWidth && n > 0) {
            ctx.fillText(line, x, y);
            line = words[n] + ' ';
            y += lineHeight;
          } else {
            line = testLine;
          }
        }
        ctx.fillText(line, x, y);
      }

      // ===== History & Presets =====
      function readHistory() {
        try { return JSON.parse(localStorage.getItem(STORAGE_KEYS.history) || '[]'); } catch (_) { return []; }
      }
      function writeHistory(arr) {
        localStorage.setItem(STORAGE_KEYS.history, JSON.stringify(arr));
      }
      function addHistoryEntry(cfg, stats) {
        const item = {
          ts: Date.now(),
          when: nowStr(),
          mode: stats.mode,
          summary: { time: stats.avgSec, tokens: stats.tokens, bp: stats.bp, sp: stats.sp, p595: stats.p595 },
          cfg: clone(cfg)
        };
        let arr = readHistory();
        arr.unshift(item);
        arr = arr.slice(0, 5);
        writeHistory(arr);
        renderHistory();
      }
      function renderHistory() {
        const list = $('historyList'); list.innerHTML = '';
        const arr = readHistory();
        if (arr.length === 0) {
          const li = document.createElement('li'); li.textContent = I18N.t('ch.no_history');
          li.style.opacity = .7; li.style.fontSize = '13px'; list.appendChild(li); return;
        }
        arr.forEach((h, idx) => {
          const li = document.createElement('li');
          const left = document.createElement('div');
          left.className = 'grow';
          left.innerHTML = `<div><b>${h.when}</b> <span class="chip">${h.mode}</span></div>
                        <div class="meta">${I18N.t('ch.sum_time')} ${Math.round(h.summary.time / 60)}${I18N.t('common.min_short')} | ${I18N.t('ch.sum_tokens')} ${h.summary.tokens} | BP ${h.summary.bp} / SP ${h.summary.sp} | 5~95 ${h.summary.p595}</div>`;
          const btns = document.createElement('div');
          const ap = document.createElement('button'); ap.className = 'sub'; ap.textContent = I18N.t('ch.apply');
          ap.addEventListener('click', () => { applyCfg(h.cfg); });
          const runb = document.createElement('button'); runb.className = 'primary'; runb.textContent = I18N.t('ch.run_with_settings');
          runb.addEventListener('click', () => { applyCfg(h.cfg); document.getElementById('run').click(); });
          btns.appendChild(ap); btns.appendChild(runb);
          li.appendChild(left); li.appendChild(btns);
          list.appendChild(li);
        });
      }

      function readPresets() {
        try { return JSON.parse(localStorage.getItem(STORAGE_KEYS.presets) || '{}'); } catch (_) { return {}; }
      }
      function writePresets(obj) {
        localStorage.setItem(STORAGE_KEYS.presets, JSON.stringify(obj));
      }
      function renderPresets() {
        const ul = $('presetList'); ul.innerHTML = '';
        const obj = readPresets();
        const names = Object.keys(obj).sort();
        if (names.length === 0) {
          const li = document.createElement('li'); li.textContent = I18N.t('ch.no_presets'); li.style.opacity = .7; li.style.fontSize = '13px'; ul.appendChild(li); return;
        }
        names.forEach(name => {
          const li = document.createElement('li');
          const left = document.createElement('div');
          left.className = 'grow';
          left.innerHTML = `<b>${name}</b><div class="meta mono">${summarizeCfg(obj[name])}</div>`;
          const btns = document.createElement('div');
          const ap = document.createElement('button'); ap.className = 'sub'; ap.textContent = I18N.t('ch.apply');
          ap.addEventListener('click', () => { applyCfg(obj[name]); });
          const runb = document.createElement('button'); runb.className = 'primary'; runb.textContent = I18N.t('ch.run_with_settings');
          runb.addEventListener('click', () => { applyCfg(obj[name]); document.getElementById('run').click(); });
          const del = document.createElement('button'); del.className = 'warn'; del.textContent = I18N.t('common.delete');
          del.addEventListener('click', () => { if (confirm(I18N.t('ch.delete_confirm'))) { const p = readPresets(); delete p[name]; writePresets(p); renderPresets(); } });
          btns.appendChild(ap); btns.appendChild(runb); btns.appendChild(del);
          li.appendChild(left); li.appendChild(btns);
          ul.appendChild(li);
        });
      }

      function summarizeCfg(cfg) {
        const goal = cfg.goalType === 'bp' ? `BP ${cfg.targetBP}` : `SP ${cfg.targetSP}`;
        return `${I18N.t('ch.goal_short')}:${goal} | ${I18N.t('ch.auto_short')}:${cfg.autoRate}% | ${I18N.t('ch.method_short')}:${cfg.chargeMethod} | ${I18N.t('ch.map_short')}:${cfg.mapSec}s ${I18N.t('ch.lobby_short')}:${cfg.lobbySec}s | ${I18N.t('ch.packs_short')}:${cfg.packs} | pBP:${cfg.pBP} pSP:${cfg.pSP}`;
      }

      $('savePreset').addEventListener('click', () => {
        const name = ($('presetName').value || '').trim();
        if (!name) { alert(I18N.t('common.preset_name_req')); return; }
        const cfg = currentCfg();
        const presets = readPresets();
        presets[name] = clone(cfg);
        writePresets(presets);
        renderPresets();
        alert(I18N.t('ch.preset_saved_fmt').replace('{name}', name));
      });

      $('exportPresets').addEventListener('click', () => {
        const data = JSON.stringify(readPresets(), null, 2);
        const blob = new Blob([data], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url; a.download = 'car-hunt-presets.json'; a.click();
        URL.revokeObjectURL(url);
      });
      $('importPresets').addEventListener('click', () => $('importFile').click());
      $('importFile').addEventListener('change', async (e) => {
        const f = e.target.files[0]; if (!f) return;
        const txt = await f.text();
        try {
          const obj = JSON.parse(txt);
          const curr = readPresets();
          const merged = { ...curr, ...obj };
          writePresets(merged);
          renderPresets();
          alert(I18N.t('common.preset_loaded'));
        } catch (_) {
          alert(I18N.t('common.json_error'));
        } finally {
          e.target.value = '';
        }
      });
      $('clearHistory').addEventListener('click', () => {
        if (confirm(I18N.t('common.history_clear_confirm'))) {
          writeHistory([]);
          renderHistory();
        }
      });

      // ===== Runner =====
      function runSim() {
        const cfg = currentCfg(); updateEnables(); const echo = echoParams(cfg);
        const activeTab = (document.querySelector('.tab.active') && document.querySelector('.tab.active').dataset.tab) || 'goal';

        if (activeTab === 'goal') {
          const times = [], tokens = []; let bp = 0, sp = 0;
          for (let i = 0; i < cfg.trials; i++) {
            const r = simulateOnceGoal(cfg);
            times.push(r.time / 60); tokens.push(r.tokens); bp += r.bp; sp += r.sp;
          }
          const avgMin = mean(times); const avgTok = Math.round(mean(tokens)); const avgSec = avgMin * 60; const q = quantiles(times, [0.05, 0.95]); const sd = std(times);
          $('timeStr').textContent = fmtHMS(avgSec);
          $('tokensUsed').textContent = `${avgTok}${I18N.t('ch.sum_tokens')}`;
          $('bpGained').textContent = `${Math.round(bp / cfg.trials)}${I18N.t('ch.sheet')}`;
          $('spGained').textContent = `${Math.round(sp / cfg.trials)}${I18N.t('ch.unit')}`;
          $('p595Time').textContent = `${q[0.05].toFixed(1)} ~ ${q[0.95].toFixed(1)} ${I18N.t('common.min_short')}`;
          $('stdTime').textContent = `${sd.toFixed(2)}`;
          drawHist($('hist'), times.map(x => Math.round(x)), I18N.t('ch.hist_time_dist'));
          lastStats = { mode: 'goal', avgSec, tokens: avgTok, bp: Math.round(bp / cfg.trials), sp: Math.round(sp / cfg.trials), p595: `${q[0.05].toFixed(1)}~${q[0.95].toFixed(1)}ë¶„`, sd: sd.toFixed(2), params: collectParamsEcho(cfg) };
        } else {
          const gainsBP = [], gainsSP = [], tokens = []; let bp = 0, sp = 0;
          for (let i = 0; i < 1000; i++) {
            const r = simulateOnceTime(cfg);
            gainsBP.push(r.bp); gainsSP.push(r.sp);
            tokens.push(r.tokens); bp += r.bp; sp += r.sp;
          }
          const avgTok = Math.round(mean(tokens));
          const limitSec = cfg.timeH * 3600 + cfg.timeM * 60 + cfg.timeS;
          $('timeStr').textContent = fmtHMS(limitSec);
          $('tokensUsed').textContent = `${avgTok}${I18N.t('ch.sum_tokens')}`;

          if (cfg.timeGoalType === 'bp') {
            const q = quantiles(gainsBP, [0.05, 0.95]); const sd = std(gainsBP); const avgGain = Math.round(mean(gainsBP));
            $('bpGained').textContent = `${avgGain}${I18N.t('ch.sheet')}`;
            $('spGained').textContent = `${Math.round(sp / 1000)}${I18N.t('ch.unit')}`;
            $('p595Time').textContent = `${q[0.05].toFixed(0)} ~ ${q[0.95].toFixed(0)} (${I18N.t('ch.sheet')})`;
            $('stdTime').textContent = `${sd.toFixed(2)} (${I18N.t('ch.sheet')})`;
            lastStats = { mode: 'time-bp', avgSec: limitSec, tokens: avgTok, bp: avgGain, sp: Math.round(sp / 1000), p595: `${q[0.05].toFixed(0)}~${q[0.95].toFixed(0)}ì¥`, sd: sd.toFixed(2), params: collectParamsEcho(cfg) };
          } else if (cfg.timeGoalType === 'sp') {
            const q = quantiles(gainsSP, [0.05, 0.95]); const sd = std(gainsSP); const avgGain = Math.round(mean(gainsSP));
            $('bpGained').textContent = `${Math.round(bp / 1000)}${I18N.t('ch.sheet')}`;
            $('spGained').textContent = `${avgGain}${I18N.t('ch.unit')}`;
            $('p595Time').textContent = `${q[0.05].toFixed(0)} ~ ${q[0.95].toFixed(0)} (${I18N.t('ch.unit')})`;
            $('stdTime').textContent = `${sd.toFixed(2)} (${I18N.t('ch.unit')})`;
            lastStats = { mode: 'time-sp', avgSec: limitSec, tokens: avgTok, bp: Math.round(bp / 1000), sp: avgGain, p595: `${q[0.05].toFixed(0)}~${q[0.95].toFixed(0)}ê°œ`, sd: sd.toFixed(2), params: collectParamsEcho(cfg) };
          } else { // both
            const qBP = quantiles(gainsBP, [0.05, 0.95]); const sdBP = std(gainsBP); const avgBP = Math.round(mean(gainsBP));
            const qSP = quantiles(gainsSP, [0.05, 0.95]); const sdSP = std(gainsSP); const avgSP = Math.round(mean(gainsSP));
            $('bpGained').textContent = `${avgBP}ì¥`;
            $('spGained').textContent = `${avgSP}ê°œ`;
            $('p595Time').textContent = `BP ${qBP[0.05].toFixed(0)}~${qBP[0.95].toFixed(0)} / SP ${qSP[0.05].toFixed(0)}~${qSP[0.95].toFixed(0)}`;
            $('stdTime').textContent = `BP ${sdBP.toFixed(2)} / SP ${sdSP.toFixed(2)}`;
            lastStats = { mode: 'time-both', avgSec: limitSec, tokens: avgTok, bp: avgBP, sp: avgSP, p595: `BP ${qBP[0.05].toFixed(0)}~${qBP[0.95].toFixed(0)} / SP ${qSP[0.05].toFixed(0)}~${qSP[0.95].toFixed(0)}`, sd: `BP ${sdBP.toFixed(2)} / SP ${sdSP.toFixed(2)}`, params: collectParamsEcho(cfg) };
          }
          drawHist($('hist'), tokens, I18N.t('ch.hist_token_dist'));
        }

        // Enable export buttons once results exist
        const canExport = !!lastStats;
        $('copySummary').disabled = !canExport;
        $('saveImage').disabled = !canExport;

        // Save to history
        addHistoryEntry(cfg, lastStats);
      }

      function resetDefaults() {
        Object.entries(defaults).forEach(([k, v]) => { if (!$(k)) return; if ($(k).type === 'checkbox') $(k).checked = v; else $(k).value = v; });
        loadSegDefault();
        loadSegDefaultBP_time();
        loadSegDefaultSP_time();
        $('useSegments').checked = defaults['useSegments'];
        $('useSegmentsBP_time').checked = defaults['useSegmentsBP_time'];
        $('useSegmentsSP_time').checked = defaults['useSegmentsSP_time'];
        updateEnables(); echoParams(currentCfg());
        lastStats = null;
        $('copySummary').disabled = true;
        $('saveImage').disabled = true;
      }

      // Buttons â€” attach
      document.getElementById('run').addEventListener('click', runSim);
      document.getElementById('reset').addEventListener('click', resetDefaults);
      document.getElementById('copySummary').addEventListener('click', copySummary);
      document.getElementById('saveImage').addEventListener('click', saveImage);

      // Preset/history initial render
      renderHistory();
      renderPresets();

      // Initial
      try { updateEnables(); echoParams(currentCfg()); } catch (e) { console.warn(e); }
    })();
  </script>

  <!-- Hub Back Button Inject -->
  <style>
    #hubBackWrap {
      position: fixed;
      left: 16px;
      top: 16px;
      z-index: 2147483647;
      font-family: ui-sans-serif, system-ui, Segoe UI, Roboto, "Noto Sans KR", Arial
    }

    #hubBackBtn {
      padding: 10px 14px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: var(--chip-bg);
      color: var(--ink);
      cursor: pointer;
      box-shadow: 0 6px 20px rgba(0, 0, 0, .35);
      opacity: .9
    }

    #hubBackBtn:hover {
      opacity: 1
    }

    @media (prefers-color-scheme: light) {
      #hubBackBtn {
        background: var(--chip-bg);
        color: var(--ink)
      }
    }
  </style>
  <div id="hubBackWrap">
    <button id="hubBackBtn" title="ë©”ì¸ ë©”ë‰´ë¡œ">
      â† ë©”ì¸ìœ¼ë¡œ
    </button>
  </div>
  <script>
    (function () {
      var btn = document.getElementById('hubBackBtn');
      if (!btn) return;
      btn.addEventListener('click', function () {
        // If navigated from hub, try back; otherwise go to hub index.html
        if (document.referrer && document.referrer.indexOf('index.html') !== -1) {
          history.back();
        } else {
          // assume hub is one level up
          location.href = '../index.html';
        }
      });
    })();
  </script>
  <style>
    .warning-box {
      width: 100%;
      margin: 0 0 12px 0;
      padding: 12px 18px;
      border-radius: 10px;

      background: rgba(255, 200, 0, 0.10);
      /* ì–´ë‘¡ê³  ê³ ê¸‰ìŠ¤ëŸ¬ìš´ í™©ê¸ˆ ë°°ê²½ */
      border: 1px solid rgba(255, 200, 0, 0.35);
      /* ì€ì€í•œ ë…¸ë€ ë¼ì¸ */

      color: #e8c85e;
      /* í…ìŠ¤íŠ¸ ë°ì€ ê¸ˆìƒ‰ */
      font-size: 15px;
      font-weight: 600;

      display: flex;
      align-items: center;
      gap: 8px;
    }

    .warning-box .icon {
      font-size: 17px;
      flex-shrink: 0;
    }
  </style>
  <div class="warning-box">
    <span class="icon">âš ï¸</span>
    <span data-i18n="common.disclaimer">ì‹œë®¬ë ˆì´ì…˜ ê²°ê³¼ëŠ” ì‹¤ì œ ê²Œì„ ê²°ê³¼ì™€ ë‹¤ë¥¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</span>
  </div>


</body>

</html>