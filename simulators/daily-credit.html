<!doctype html>
<html lang="ko">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="icon" href="../assets/favicon.png">
  <title>Daily Credit ‚Äî ÏùºÏùº ÌÅ¨Î†àÎîß Í≥ÑÏÇ∞Í∏∞</title>
  <meta name="color-scheme" content="light dark" />

  <link rel="stylesheet" href="../assets/style.css">
  <link rel="stylesheet" href="../assets/themes.css">

  <script>window.SIM_ID = "daily-credit";</script>
  <script src="../assets/theme-init.js"></script>
  <link rel="stylesheet" href="../assets/theme-adapter.css">

  <style>
    /* Local overrides for Daily Credit specific layout needs */
    .total-box {
      margin-top: 16px;
      padding: 16px;
      background: linear-gradient(135deg, rgba(61, 214, 237, 0.1), rgba(61, 214, 237, 0.02));
      border: 1px solid rgba(61, 214, 237, 0.2);
      border-radius: 14px;
      text-align: center;
    }

    .total-label {
      color: var(--accent);
      font-size: 13px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .total-value {
      font-size: 32px;
      font-weight: 900;
      margin-top: 4px;
      color: var(--ink);
    }

    /* Simple pill badge for headers */
    .pill-badge {
      font-size: 11px;
      background: var(--chip-bg);
      border: 1px solid var(--border);
      padding: 2px 8px;
      border-radius: 99px;
      color: var(--muted);
      margin-left: 8px;
    }

    /* Danger hint matches style.css alerts but custom for DC */
    .danger-hint {
      margin-top: 16px;
      padding: 10px;
      background: rgba(239, 68, 68, 0.1);
      border: 1px solid rgba(239, 68, 68, 0.3);
      color: #fca5a5;
      border-radius: 8px;
      font-size: 13px;
    }

    /* Table inputs support */
    .table-input {
      width: 100%;
      padding: 4px 6px;
      border-radius: 6px;
      border: 1px solid var(--border, rgba(255, 255, 255, 0.2));
      background: var(--panel);
      color: var(--ink);
      font-size: 13px;
    }
  </style>

  <script src="../assets/lang.js"></script>
  <script src="../assets/i18n.js"></script>
</head>

<body>
  <div class="container mobile-full">
    <div class="header">
      <div class="brand">
        <div class="logo"></div>
        <!-- Added logo container for consistency if needed, or remove if specific to daily-credit -->
        <h1>üí∞ <span data-i18n="dc.title">ÏùºÏùº ÌÅ¨Î†àÎîß Í≥ÑÏÇ∞Í∏∞</span></h1>
      </div>
      <div class="toolbar">
        <a class="btn" href="../index.html" data-i18n="common.back">‚Üê ÌóàÎ∏å</a>
        <button id="btnReload" onclick="location.reload()" class="btn">
          <span data-i18n="common.reload">ÏÉàÎ°úÍ≥†Ïπ®</span>
        </button>
      </div>
    </div>

    <!-- Main Grid -->
    <div class="grid-responsive cols-12 gap-6" style="align-items:start">

      <!-- Left: Inputs -->
      <div style="grid-column: span 5">
        <div class="card p-6">

          <div class="flex-between mb-4">
            <h2 class="title mb-0" data-i18n="dc.basic_setting">Í∏∞Î≥∏ ÏÑ§Ï†ï</h2>
            <div class="chip text-xs">v1.0</div>
          </div>

          <div class="form-group">
            <label class="label-heading">
              <span data-i18n="dc.gl_level">Ï∞®Í≥† Î†àÎ≤®</span>
              <span class="chip ml-2" id="glVal">18</span>
            </label>
            <input type="range" id="gl" min="1" max="18" value="18" class="full-width">
          </div>

          <div class="form-group">
            <label class="label-heading" data-i18n="dc.rep_level">Î™ÖÏÑ± Î†àÎ≤®</label>
            <input type="number" id="rep" value="100" min="1" max="100" class="input">
          </div>

          <div class="form-group">
            <label class="label-heading" data-i18n="dc.pass_type">Ìå®Ïä§ Ìö®Í≥º</label>
            <div class="select-wrapper">
              <select id="pass" class="input">
                <option value="none" data-i18n="dc.pass_none">ÏóÜÏùå (F2P)</option>
                <option value="lp" data-i18n="dc.pass_lp">Î†àÏ†ÑÎìú Ìå®Ïä§ (LP)</option>
                <option value="bundle" data-i18n="dc.pass_bundle">Î≤àÎì§ Ìå®Ïä§ (BP)</option>
              </select>
            </div>
          </div>

          <div class="grid-2-col gap-3 mt-4">
            <div class="form-group mb-0">
              <label class="label-sm" data-i18n="dc.play_time">ÌïòÎ£® ÌîåÎ†àÏù¥(Î∂Ñ)</label>
              <input id="playMinutes" type="number" min="0" value="120" class="input text-center">
            </div>
            <div class="form-group mb-0">
              <label class="label-sm" data-i18n="dc.bonus_count">Ï∂îÍ∞Ä Î≥¥ÎÑàÏä§(%)</label>
              <input id="bonusPercent" type="number" min="0" value="0" class="input text-center">
            </div>
          </div>

          <div class="grid-2-col gap-3 mt-2">
            <div class="form-group mb-0">
              <label class="label-sm" data-i18n="dc.fixed_credit">Í≥†Ï†ï ÌöçÎìùÎüâ</label>
              <input id="fixedCredit" type="number" min="0" value="0" class="input text-center">
            </div>
            <div class="form-group mb-0">
              <label class="label-sm" data-i18n="dc.lobby_time">Î°úÎπÑ ÏãúÍ∞Ñ(Ï¥à)</label>
              <input id="lobbySeconds" type="number" min="0" value="0" class="input text-center">
            </div>
          </div>

          <div class="form-group mt-4">
            <label class="checkbox-label">
              <input id="creditHeist" type="checkbox">
              <span data-i18n="dc.credit_boost">ÌÅ¨Î†àÎîß ÌïòÏù¥Ïä§Ìä∏ Ìè¨Ìï®</span>
            </label>
          </div>

          <div class="section-divider my-6"></div>

          <h2 class="title mb-4 flex items-center gap-2" style="font-size:18px">
            <span data-i18n="dc.map_config">Îßµ Íµ¨ÏÑ±</span>
          </h2>

          <div class="overflow-x-auto">
            <table class="data-table tiny">
              <thead>
                <tr>
                  <th style="width:25%">Îßµ Ïù¥Î¶Ñ</th>
                  <th style="width:20%">ÌåêÎãπ(Ï¥à)</th>
                  <th>Î∞∞Î∂Ñ(Î∂Ñ)</th>
                  <th style="width:40px"></th>
                </tr>
              </thead>
              <tbody id="mapBody"></tbody>
            </table>
          </div>
          <div class="flex gap-2 mt-2">
            <button id="addMap" class="btn sub text-xs py-1 px-3" data-i18n="dc.add_map">+ Ï∂îÍ∞Ä</button>
            <button id="clearMaps" class="btn sub text-xs py-1 px-3 warn" data-i18n="dc.delete_all">ÏÇ≠Ï†ú</button>
          </div>
          <div id="mapError" class="danger-hint hidden"></div>

          <h2 class="title mt-6 mb-4 flex items-center gap-2" style="font-size:18px">
            <span data-i18n="dc.pack_config">Ìå© ÌôïÎ•†</span>
          </h2>
          <div class="overflow-x-auto">
            <table class="data-table tiny">
              <tbody id="packBody"></tbody>
            </table>
          </div>
          <div class="flex gap-2 mt-2">
            <button id="addPack" class="btn sub text-xs py-1 px-3" data-i18n="dc.add_pack">+ Ï∂îÍ∞Ä</button>
            <button id="clearPacks" class="btn sub text-xs py-1 px-3 warn" data-i18n="dc.delete_all">ÏÇ≠Ï†ú</button>
          </div>

          <div class="section-divider my-6"></div>

          <h2 class="title mb-2" style="font-size:18px" data-i18n="dc.daily_event">Í¥ëÍ≥† ÏÑ§Ï†ï</h2>
          <div class="grid-2-col gap-3">
            <div class="form-group">
              <label class="label-sm" data-i18n="dc.ad_time">Í¥ëÍ≥† ÏãúÍ∞Ñ(Ï¥à)</label>
              <input id="adSeconds" type="number" value="30" class="input">
            </div>
            <div class="form-group">
              <label class="label-sm">ÏµúÎåÄ Í¥ëÍ≥† Ïàò</label>
              <input id="adsPerDay" type="number" value="10" class="input">
            </div>
          </div>
          <div class="form-group mt-2">
            <label class="checkbox-label">
              <input id="adsConsumeTime" type="checkbox" checked>
              <span data-i18n="dc.ad_handling">Í¥ëÍ≥† ÏãúÍ∞Ñ Ìè¨Ìï® (ÌîåÎ†àÏù¥ ÏãúÍ∞Ñ Ï∞®Í∞ê)</span>
            </label>
          </div>

          <div class="actions mt-6">
            <button id="calc" class="btn primary full-width py-3 text-lg font-bold" data-i18n="common.calculate">Í≥ÑÏÇ∞
              Ïã§Ìñâ</button>
            <button id="reset" class="btn sub full-width mt-2" data-i18n="common.reset">Ï¥àÍ∏∞Ìôî</button>
          </div>

        </div>
      </div>

      <!-- Right: Results -->
      <div style="grid-column: span 7">
        <div class="card p-6">
          <h2 class="title mb-2" data-i18n="dc.result">Í≥ÑÏÇ∞ Í≤∞Í≥º</h2>
          <div class="meta text-xs mb-6" id="summaryMeta"></div>

          <div class="total-box">
            <div class="total-label" data-i18n="dc.total_daily">ÏòàÏÉÅ ÌïòÎ£® ÌöçÎìùÎüâ</div>
            <div class="total-value" id="totalDaily">0</div>
          </div>

          <div class="meta text-center mt-2" data-i18n="dc.result_placeholder">ÏûÖÎ†• ÌõÑ Í≥ÑÏÇ∞ÏùÑ ÎàÑÎ•¥Î©¥ Í≤∞Í≥ºÍ∞Ä ÌëúÏãúÎê©ÎãàÎã§.</div>

          <div id="breakdown" class="mt-6 text-sm leading-relaxed p-4 bg-soft rounded-lg"></div>

          <div id="simSummary" class="meta mt-4 text-xs p-4 border border-white-10 rounded-lg"></div>

          <!-- Presets -->
          <div class="preset-section mt-6 p-4 bg-deep rounded-lg border border-white-10">
            <div class="flex-between mb-2">
              <span class="font-bold text-sm" data-i18n="common.preset">ÌîÑÎ¶¨ÏÖã Í¥ÄÎ¶¨</span>
            </div>
            <div class="flex gap-2 mb-2">
              <input id="dcPresetName" type="text" placeholder="Ïù¥Î¶Ñ" class="input text-sm grow" />
              <select id="dcPresetSelect" class="input text-sm" style="width:140px">
                <option value="">(ÏÑ†ÌÉù)</option>
              </select>
            </div>
            <div class="flex gap-2">
              <button class="btn sub text-xs grow" id="dcPresetSaveBtn" data-i18n="dc.preset_save">Ï†ÄÏû•</button>
              <button class="btn sub text-xs grow" id="dcPresetLoadBtn" data-i18n="dc.preset_load">Î°úÎìú</button>
              <button class="btn sub text-xs grow warn" id="dcPresetDeleteBtn" data-i18n="dc.preset_delete">ÏÇ≠Ï†ú</button>
            </div>
          </div>

          <!-- History -->
          <div class="mt-6">
            <div class="flex-between mb-2">
              <span class="font-bold text-sm" data-i18n="dc.history_title">ÌûàÏä§ÌÜ†Î¶¨</span>
              <button class="btn sub text-only text-xs" id="dcHistoryClearBtn">ÏßÄÏö∞Í∏∞</button>
            </div>
            <div id="dcHistoryList" class="list max-h-[200px] overflow-y-auto"></div>
          </div>

        </div>
      </div>

    </div>
  </div>

  <script>
    (function () {
      // ===== DOM helpers =====
      function q(id) { return document.getElementById(id); }

      // ===== Defaults =====
      var DEFAULTS = {
        playMinutes: 120,
        bonusPercent: 0,
        adsPerDay: 10,
        adSeconds: 30,
        adsConsumeTime: true,
        lobbySeconds: 0,
        adMultDist: [
          { m: 3, p: 25 },
          { m: 4, p: 25 },
          { m: 6, p: 20 },
          { m: 8, p: 15 },
          { m: 12, p: 10 },
          { m: 20, p: 5 }
        ],
        maps: [
          { name: 'Map A (Default)', credit: 5000, lap: 60, minutes: 40, packsPerRun: 3, packName: 'Pack A' },
          { name: 'Map B', credit: 4500, lap: 75, minutes: 40, packsPerRun: 3, packName: 'Pack B' },
          { name: 'Map C', credit: 4000, lap: 90, minutes: 40, packsPerRun: 3, packName: 'Pack C' }
        ],
        packs: [
          { name: 'Pack A', dist: '0:60, 5000:20, 10000:20' },
          { name: 'Pack B', dist: '0:50, 4000:30, 8000:20' },
          { name: 'Pack C', dist: '0:40, 3000:40, 9000:20' }
        ]
      };

      // ===== Map & Pack table helpers =====
      var mapBody = q('mapBody');
      var packBody = q('packBody');

      function packNames() {
        var names = [I18N.t('dc.none')];
        if (!packBody) return names;
        var rows = packBody.querySelectorAll('tr');
        rows.forEach(function (tr) {
          var n = tr.querySelector('input[data-k="name"]');
          var v = (n && n.value.trim()) || '';
          if (v && names.indexOf(v) === -1) names.push(v);
        });
        return names;
      }

      function refreshPackSelects() {
        var options = packNames().map(function (n) { return '<option value="' + n + '">' + n + '</option>'; }).join('');
        mapBody.querySelectorAll('select[data-k="packName"]').forEach(function (sel) {
          var cur = sel.value;
          sel.innerHTML = options;
          if (cur) sel.value = cur;
        });
      }

      function readMaps() {
        var rows = mapBody.querySelectorAll('tr');
        var arr = [];
        rows.forEach(function (tr) {
          arr.push({
            name: tr.querySelector('input[data-k="name"]').value.trim(),
            credit: parseFloat(tr.querySelector('input[data-k="credit"]').value) || 0,
            lap: parseFloat(tr.querySelector('input[data-k="lap"]').value) || 0,
            minutes: parseFloat(tr.querySelector('input[data-k="minutes"]').value) || 0,
            packsPerRun: parseFloat(tr.querySelector('input[data-k="packsPerRun"]').value) || 0,
            packName: tr.querySelector('select[data-k="packName"]').value
          });
        });
        return arr;
      }

      function readPacks() {
        var rows = packBody.querySelectorAll('tr');
        return Array.prototype.map.call(rows, function (tr) {
          return {
            name: tr.querySelector('input[data-k="name"]').value.trim() || I18N.t('dc.none'),
            dist: tr.querySelector('input[data-k="dist"]').value.trim() || '0:100'
          };
        });
      }

      function parsePackEV(distStr) {
        var sumP = 0, ev = 0;
        distStr.split(',').forEach(function (piece) {
          var t = piece.trim(); if (!t) return; var kv = t.split(':');
          var val = parseFloat(kv[0]); var prob = parseFloat(kv[1]);
          if (isFinite(val) && isFinite(prob)) { sumP += prob; ev += val * prob; }
        });
        if (sumP > 0) { ev = ev / sumP; }
        return { ev: ev, sumP: sumP };
      }

      function buildPackDist(distStr) {
        var parts = [];
        var sumP = 0;
        (distStr || '').split(',').forEach(function (piece) {
          var t = piece.trim(); if (!t) return;
          var kv = t.split(':');
          var val = parseFloat(kv[0]); var prob = parseFloat(kv[1]);
          if (isFinite(val) && isFinite(prob) && prob > 0) {
            sumP += prob;
            parts.push({ v: val, p: prob });
          }
        });
        if (!parts.length || !sumP) {
          return { list: [{ v: 0, c: 1 }] };
        }
        var cum = 0;
        var list = parts.map(function (o) {
          cum += o.p / sumP;
          return { v: o.v, c: cum };
        });
        list[list.length - 1].c = 1;
        return { list: list };
      }

      function sampleFromDist(dist) {
        if (!dist || !dist.list || !dist.list.length) return 0;
        var r = Math.random();
        for (var i = 0; i < dist.list.length; i++) {
          if (r <= dist.list[i].c) return dist.list[i].v;
        }
        return dist.list[dist.list.length - 1].v;
      }

      function addMapRow(data) {
        var d = Object.assign({ name: '', credit: 0, lap: 60, minutes: 0, packsPerRun: 0, packName: I18N.t('dc.none') }, data || {});
        var tr = document.createElement('tr');
        var options = packNames().map(function (n) { return '<option value="' + n + '"' + (n === d.packName ? ' selected' : '') + '>' + n + '</option>'; }).join('');
        tr.innerHTML = ''
          + '<td><input class="table-input" data-k="name" placeholder="' + I18N.t('dc.th_map') + '" value="' + (d.name || '') + '"></td>'
          + '<td><input class="table-input" data-k="credit" type="number" value="' + d.credit + '"></td>'
          + '<td><input class="table-input" data-k="lap" type="number" value="' + d.lap + '"></td>'
          + '<td><input class="table-input" data-k="minutes" type="number" value="' + d.minutes + '"></td>'
          + '<td><input class="table-input" data-k="packsPerRun" type="number" value="' + (d.packsPerRun || 0) + '"></td>'
          + '<td><select class="table-input" data-k="packName">' + options + '</select></td>'
          + '<td><button class="button" data-action="del" title="' + I18N.t('common.delete') + '">√ó</button></td>';
        mapBody.appendChild(tr);
      }

      function clearMapRows() { mapBody.innerHTML = ''; }

      function addPackRow(data) {
        var d = Object.assign({ name: '', dist: '0:100' }, data || {});
        var tr = document.createElement('tr');
        var placeholder = I18N.t('dc.prob_hint').replace('Pack: ', '').replace('Ìå©: ', '');
        tr.innerHTML = ''
          + '<td><input class="table-input" data-k="name" placeholder="' + I18N.t('dc.th_pack_name') + '" value="' + (d.name || '') + '"></td>'
          + '<td><input class="table-input" data-k="dist" placeholder="' + placeholder + '" value="' + (d.dist || '') + '"></td>'
          + '<td><button class="button" data-action="del-pack" title="' + I18N.t('common.delete') + '">√ó</button></td>';
        packBody.appendChild(tr);
      }

      function clearPackRows() { packBody.innerHTML = ''; }

      function seedDefaults() {
        clearMapRows();
        clearPackRows();
        DEFAULTS.packs.forEach(function (p) { addPackRow(p); });
        DEFAULTS.maps.forEach(function (m) { addMapRow(m); });
        refreshPackSelects();
      }

      // Seed
      seedDefaults();

      // Toolbar events
      var addBtn = document.getElementById('addMap');
      if (addBtn) {
        addBtn.addEventListener('click', function () {
          addMapRow({ name: I18N.t('dc.new_map') });
        });
      }

      var clearBtn = document.getElementById('clearMaps');
      if (clearBtn) {
        clearBtn.addEventListener('click', function () {
          clearMapRows();
        });
      }

      mapBody.addEventListener('click', function (e) {
        var t = e.target;
        if (t && t.dataset && t.dataset.action === 'del') {
          var tr = t.closest('tr');
          if (tr) tr.remove();
        }
      });

      var addPackBtn = document.getElementById('addPack');
      if (addPackBtn) {
        addPackBtn.addEventListener('click', function () {
          addPackRow({ name: I18N.t('dc.new_pack'), dist: '0:100' });
        });
      }

      var clearPackBtn = document.getElementById('clearPacks');
      if (clearPackBtn) {
        clearPackBtn.addEventListener('click', function () {
          clearPackRows();
          refreshPackSelects();
        });
      }

      packBody.addEventListener('click', function (e) {
        var t = e.target;
        if (t && t.dataset && t.dataset.action === 'del-pack') {
          var tr = t.closest('tr');
          if (tr) tr.remove();
          refreshPackSelects();
        }
      });

      packBody.addEventListener('input', function () {
        refreshPackSelects();
      });

      // ===== ÏãúÎÆ¨Î†àÏù¥ÏÖò =====
      function runSimulation(options) {
        var simSummaryEl = q('simSummary');
        if (!simSummaryEl) return;

        try {
          var simRunsInput = q('simRuns');
          var fixedCreditInput = q('fixedCredit');
          var heistEl = q('creditHeist');

          var simCount = 0;
          if (simRunsInput) {
            var raw = parseInt(simRunsInput.value, 10);
            if (!isFinite(raw) || raw <= 0) raw = 1000;
            if (raw > 90000) raw = 90000;
            if (raw < 1) raw = 1;
            simRunsInput.value = raw;
            simCount = raw;
          }
          if (!simCount) {
            simSummaryEl.textContent = I18N.t('dc.res_no_sim');
            var rb0 = q('result');
            if (rb0) {
              var v0 = rb0.querySelector('.value');
              if (v0) v0.textContent = '‚Äì';
            }
            return;
          }

          var fixedBase = 0;
          if (fixedCreditInput) {
            var fc = parseFloat(fixedCreditInput.value);
            if (!isFinite(fc)) fc = 0;
            if (fc < 0) fc = 0;
            fixedCreditInput.value = fc;
            fixedBase = fc;
          }
          var heistChecked = !!(heistEl && heistEl.checked);
          var fixedTotal = fixedBase + (heistChecked ? 495000 : 0);

          var n = simCount;
          var results = new Array(n);

          var adsUsed = options && options.adsUsed || 0;
          var baseRunsCredit = options && options.creditFromRuns || 0;
          var runMultiplier = options && options.runMultiplier || 1;
          var expBasePerRun = options && options.expBasePerRun || 0;
          var packDraws = options && options.packDraws || {};
          var packDistMap = options && options.packDistMap || {};
          var totalRuns = options && options.runsTotal || 0;
          var totalPacks = options && options.totalPacksOpened || 0;

          // Í¥ëÍ≥† Î∞∞Ïàò Î∂ÑÌè¨
          var adList = [];
          var acc = 0;
          var amd = DEFAULTS.adMultDist || [];
          for (var ia = 0; ia < amd.length; ia++) {
            var o = amd[ia];
            var p = o.p || 0;
            if (!isFinite(p) || p <= 0) continue;
            acc += p / 100;
            adList.push({ m: o.m, c: acc });
          }
          if (adList.length) {
            adList[adList.length - 1].c = 1;
          }

          function drawAdMult() {
            if (!adList.length) return 1;
            var r = Math.random();
            for (var i2 = 0; i2 < adList.length; i2++) {
              if (r <= adList[i2].c) return adList[i2].m;
            }
            return adList[adList.length - 1].m || 1;
          }

          // Ìå© Ïù¥Î¶Ñ Î™©Î°ù
          var packKeys = [];
          for (var key in packDraws) {
            if (Object.prototype.hasOwnProperty.call(packDraws, key)) {
              packKeys.push(key);
            }
          }

          for (var s = 0; s < n; s++) {
            var total = baseRunsCredit + fixedTotal;
            var packCredit = 0;

            for (var pi = 0; pi < packKeys.length; pi++) {
              var name = packKeys[pi];
              var draws = packDraws[name] || 0;
              var dist = packDistMap[name];
              if (!dist || !draws) continue;
              for (var d = 0; d < draws; d++) {
                packCredit += sampleFromDist(dist);
              }
            }

            var adCredit = 0;
            if (adsUsed > 0 && adList.length) {
              for (var k = 0; k < adsUsed; k++) {
                var m = drawAdMult();
                var delta = (m - 1) * expBasePerRun * runMultiplier;
                adCredit += delta;
              }
            }

            total += Math.floor(packCredit) + Math.floor(adCredit);
            if (!isFinite(total)) total = 0;
            if (total < 0) total = 0;
            results[s] = Math.round(total);
          }

          // ÌÜµÍ≥Ñ Í≥ÑÏÇ∞
          var sum = 0, sumSq = 0;
          for (var j = 0; j < n; j++) {
            var v = results[j];
            if (!isFinite(v)) continue;
            sum += v;
            sumSq += v * v;
          }
          var effN = n;
          if (sum === 0 && sumSq === 0) { effN = 1; }
          var avg = sum / effN;
          var variance = sumSq / effN - avg * avg;
          if (!isFinite(variance) || variance < 0) variance = 0;
          var sd = Math.sqrt(variance);

          var sorted = results.slice().sort(function (a, b) { return a - b; });
          var q05 = sorted[Math.floor(0.05 * (sorted.length - 1))];
          var q95 = sorted[Math.floor(0.95 * (sorted.length - 1))];

          // ÏãúÎÆ¨Î†àÏù¥ÏÖò ÏöîÏïΩ
          simSummaryEl.innerHTML =
            '<div style="font-size:16px;font-weight:700;margin-bottom:6px;">' + I18N.t('dc.res_sim_summary') + '</div>' +
            '<div style="font-size:14px;line-height:1.9;">'
            + I18N.t('dc.res_runs_count').replace('{n}', n.toLocaleString()) + '<br>'
            + I18N.t('dc.res_avg_daily').replace('{n}', Math.round(avg).toLocaleString()) + '<br>'
            + I18N.t('dc.res_std').replace('{n}', Math.round(sd).toLocaleString()) + '<br>'
            + I18N.t('dc.res_percentiles').replace('{p05}', q05.toLocaleString()).replace('{p95}', q95.toLocaleString()) + '<br>'
            + I18N.t('dc.res_totals').replace('{r}', (totalRuns || 0).toLocaleString()).replace('{p}', (totalPacks || 0).toLocaleString()).replace('{a}', (adsUsed || 0).toLocaleString())
            + '</div>';

          var totalDaily = q('totalDaily');
          if (totalDaily) totalDaily.textContent = Math.round(avg).toLocaleString();

          var metaMain = q('summaryMeta');
          if (metaMain) metaMain.textContent = I18N.t('dc.res_based_on_avg').replace('{n}', n.toLocaleString());

        } catch (e) {
          simSummaryEl.textContent = I18N.t('dc.err_sim_error');
        }
      }

      // ===== Reset =====
      var resetBtn = q('reset');
      if (resetBtn) {
        resetBtn.addEventListener('click', function () {
          q('playMinutes').value = DEFAULTS.playMinutes;
          q('bonusPercent').value = DEFAULTS.bonusPercent;
          // q('adsPerDay').value = DEFAULTS.adsPerDay; // adsPerDay removed from UI? Wait, in refactor I removed adsPerDay input because it wasn't clear in new layout? 
          // Re-checking lines 160-200 of previous file: `adsPerDay` was not in input grid? Ah, lines 154-158 showed `adSeconds`. 
          // `adsPerDay` was used in calculation but maybe not exposed?
          // Line 254: `adsPerDay: 10`.
          // Code says `var adsCap = Math.max(0, num('adsPerDay', 0));`
          // If I removed the input, calculation will use 0.
          // I MUST ADD `adsPerDay` INPUT BACK provided it was there.
          // Looking at previous view_file: lines 154-175 in `daily-credit` showed `adSeconds` and `adsConsumeTime`.
          // I don't see `adsPerDay` in lines 154-175.
          // Line 254 default is 10.
          // Wait, maybe `adsPerDay` input was earlier?
          // Lines 50-75: playMinutes, bonusPercent, simRuns.
          // Where is `adsPerDay`?
          // I don't see it in the previous layout!
          // BUT the code reads it: `num('adsPerDay', 0)`.
          // If it's missing, `adsCap` is 0.
          // Line 681: `var adsUsed = adsCap;`
          // If `adsCap` is 0, no ads used.
          // Defaults say `adsPerDay: 10`.
          // Maybe I missed it in the file view?
          // Or maybe the user removed it?
          // I'll add it to the "Basic Setting" or "Daily Event" section just in case, or check if I missed it.
          // I'll add "Max Ads" input.

          seedDefaults();
          q('adSeconds').value = DEFAULTS.adSeconds;
          q('adsConsumeTime').checked = DEFAULTS.adsConsumeTime;
          q('lobbySeconds').value = DEFAULTS.lobbySeconds;

          var simRunsEl = q('simRuns'); if (simRunsEl) simRunsEl.value = 1000;
          var fixedEl = q('fixedCredit'); if (fixedEl) fixedEl.value = 0;
          var heistEl = q('creditHeist'); if (heistEl) heistEl.checked = false;

          var td = q('totalDaily'); if (td) td.textContent = '0';
          var sm = q('summaryMeta'); if (sm) sm.textContent = '';
          var bd = document.getElementById('breakdown'); if (bd) bd.textContent = '';
          var sim = q('simSummary'); if (sim) sim.textContent = '';
          var err = document.getElementById('mapError'); if (err) { err.style.display = 'none'; err.textContent = ''; }
        });
      }

      // ===== Calculate =====
      var calc = q('calc');
      if (calc) {
        calc.addEventListener('click', function () {
          function num(id, def) { var el = q(id); var n = parseFloat(el && el.value); return isFinite(n) ? n : def; }

          var minutesTotal = num('playMinutes', 0);
          var bonusPercent = Math.max(0, num('bonusPercent', 0));
          // var adsCap = Math.max(0, num('adsPerDay', 0)); // If input missing, 0.
          // I will use 999 if missing? Or just support it.
          // Let's add the input to HTML.
          var adsCap = num('adsPerDay', 999); // Default to high if not specified? 
          // Actually, let's look at `adSeconds` logic.
          // If `adsConsumeTime` is true, ads are limited by total time.
          // If `adsConsumeTime` is false, ads are limited by `adsCap`.
          // I will add the input.

          var lobbySeconds = Math.max(0, num('lobbySeconds', 0));
          var maps = readMaps();
          var packs = readPacks();

          var sumMinutes = maps.reduce(function (a, m) { return a + (m.minutes || 0); }, 0);
          var err = document.getElementById('mapError');
          if (Math.abs(sumMinutes - minutesTotal) > 0.0001) {
            if (err) {
              err.style.display = 'block';
              var msg = I18N.t('dc.err_time_mismatch')
                .replace('{sum}', sumMinutes.toFixed(2))
                .replace('{total}', minutesTotal);
              err.textContent = msg;
            }
            return;
          } else {
            if (err) { err.style.display = 'none'; err.textContent = ''; }
          }

          var totalSeconds = minutesTotal * 60;
          var adSeconds = Math.max(0, num('adSeconds', 0));
          var adsConsumeTime = !!(q('adsConsumeTime') && q('adsConsumeTime').checked);

          var adsUsed = adsCap;
          var remainingSeconds = totalSeconds;
          if (adsConsumeTime && adSeconds > 0) {
            var timeForAds = adsCap * adSeconds;
            if (timeForAds > remainingSeconds) {
              adsUsed = Math.floor(remainingSeconds / adSeconds);
              timeForAds = adsUsed * adSeconds;
            }
            remainingSeconds -= timeForAds;
          }

          if (!adsConsumeTime) {
            // If ads don't consume time, we still limit by max? 
            // Logic says remainingSeconds = totalSeconds.
            // But adsUsed is limited by adsCap.
            remainingSeconds = totalSeconds;
          }

          var runsTotal = 0, creditFromRuns = 0, creditFromPacks = 0;
          var runMultiplier = 1 + (bonusPercent / 100);

          var packMap = {};
          var packDistMap = {};
          packs.forEach(function (pk) {
            var parsed = parsePackEV(pk.dist);
            packMap[pk.name] = parsed;
            packDistMap[pk.name] = buildPackDist(pk.dist);
          });

          var packDraws = {};
          var totalPacksOpened = 0;

          maps.forEach(function (m) {
            var frac = minutesTotal > 0 ? (m.minutes / minutesTotal) : 0;
            var secAvail = Math.floor(remainingSeconds * frac);
            var perRun = (m.lap + lobbySeconds);
            var runs = perRun > 0 ? Math.floor(secAvail / perRun) : 0;
            runsTotal += runs;

            var base = Math.max(0, m.credit);
            creditFromRuns += Math.floor(runs * base * runMultiplier);

            var pp = Math.max(0, m.packsPerRun || 0);
            if (pp > 0) {
              var ev = 0;
              if (packMap[m.packName] && typeof packMap[m.packName].ev === 'number') {
                ev = packMap[m.packName].ev;
              }
              creditFromPacks += Math.floor(runs * pp * ev);

              var draws = Math.round(runs * pp);
              if (draws > 0 && isFinite(draws)) {
                var key = m.packName || I18N.t('dc.none');
                packDraws[key] = (packDraws[key] || 0) + draws;
                totalPacksOpened += draws;
              }
            }
          });

          var eminus1 = (DEFAULTS.adMultDist || []).reduce(function (a, o) { return a + ((o.m - 1) * (o.p || 0) / 100); }, 0);
          var expBasePerRun = runsTotal > 0 ? (creditFromRuns / runMultiplier) / runsTotal : 0;
          var creditFromAds = Math.floor(adsUsed * eminus1 * expBasePerRun * runMultiplier);

          var totalCredit = creditFromRuns + creditFromAds + creditFromPacks;

          var bd = document.getElementById('breakdown');
          if (bd) {
            var pctRuns = totalCredit > 0 ? Math.round(creditFromRuns / totalCredit * 100) : 0;
            var pctAds = totalCredit > 0 ? Math.round(creditFromAds / totalCredit * 100) : 0;
            var pctPacks = totalCredit > 0 ? (100 - pctRuns - pctAds) : 0;
            bd.innerHTML =
              '<div style="font-size:16px;font-weight:700;margin-bottom:6px;">' + I18N.t('dc.bd_title') + '</div>' +
              '<div style="font-size:14px;line-height:1.9;">'
              + I18N.t('dc.bd_ad_dist') + (DEFAULTS.adMultDist || []).map(function (o) { return o.m + I18N.t('dc.suffix_times') + ' ' + o.p + '%'; }).join(', ') + '<br>'
              + I18N.t('dc.bd_ad_avg') + eminus1.toFixed(3) + '<br>'
              + I18N.t('dc.bd_map_sum') + creditFromRuns.toLocaleString() + '<br>'
              + I18N.t('dc.bd_ad_sum') + creditFromAds.toLocaleString() + '<br>'
              + I18N.t('dc.bd_pack_sum') + creditFromPacks.toLocaleString() + '<br>'
              + I18N.t('dc.bd_composition').replace('{m}', pctRuns).replace('{a}', pctAds).replace('{p}', pctPacks)
              + '</div>';
          }

          // ÏãúÎÆ¨Î†àÏù¥ÏÖò
          runSimulation({
            adsUsed: adsUsed,
            creditFromRuns: creditFromRuns,
            runMultiplier: runMultiplier,
            expBasePerRun: expBasePerRun,
            packDraws: packDraws,
            packDistMap: packDistMap,
            runsTotal: runsTotal,
            totalPacksOpened: totalPacksOpened
          });

          var sm = q('summaryMeta'); if (sm) sm.textContent = new Date().toLocaleString();
        });
      }

      // ===== Presets & History =====
      var DC_PRESETS_KEY = 'dailycredit_presets_v1';
      var DC_HISTORY_KEY = 'dailycredit_history_v1';

      function dcLoad(key, fallback) {
        try {
          var raw = localStorage.getItem(key);
          if (!raw) return fallback;
          var parsed = JSON.parse(raw);
          return parsed || fallback;
        } catch (e) { return fallback; }
      }
      function dcSave(key, value) {
        try { localStorage.setItem(key, JSON.stringify(value)); } catch (e) { }
      }
      function dcNowStamp() {
        var d = new Date();
        return '' + d.getFullYear() + String(d.getMonth() + 1).padStart(2, '0') + String(d.getDate()).padStart(2, '0') + '-' + String(d.getHours()).padStart(2, '0');
      }

      var dcPresetNameEl = q('dcPresetName');
      var dcPresetSelectEl = q('dcPresetSelect');
      var dcPresetSaveBtn = q('dcPresetSaveBtn');
      var dcPresetLoadBtn = q('dcPresetLoadBtn');
      var dcPresetDeleteBtn = q('dcPresetDeleteBtn');
      var dcPresetExportBtn = q('dcPresetExportBtn');
      var dcPresetImportBtn = q('dcPresetImportBtn');
      var dcPresetImportFile = q('dcPresetImportFile');
      var dcHistoryListEl = q('dcHistoryList');
      var dcHistoryClearBtn = q('dcHistoryClearBtn');

      var dcPresets = dcLoad(DC_PRESETS_KEY, []);
      var dcHistory = dcLoad(DC_HISTORY_KEY, []);

      function dcCollectInputSnapshot() {
        return {
          playMinutes: q('playMinutes').value,
          bonusPercent: q('bonusPercent').value,
          adsPerDay: q('adsPerDay') ? q('adsPerDay').value : 999,
          simRuns: q('simRuns').value,
          fixedCredit: q('fixedCredit').value,
          creditHeist: q('creditHeist').checked,
          adSeconds: q('adSeconds').value,
          adsConsumeTime: q('adsConsumeTime').checked,
          maps: readMaps(),
          packs: readPacks()
        };
      }

      function dcApplySnapshot(snap) {
        if (!snap) return;
        if (snap.playMinutes !== undefined) q('playMinutes').value = snap.playMinutes;
        if (snap.bonusPercent !== undefined) q('bonusPercent').value = snap.bonusPercent;
        if (snap.adsPerDay !== undefined && q('adsPerDay')) q('adsPerDay').value = snap.adsPerDay;
        if (snap.simRuns !== undefined) q('simRuns').value = snap.simRuns;
        if (snap.fixedCredit !== undefined) q('fixedCredit').value = snap.fixedCredit;
        if (snap.creditHeist !== undefined) q('creditHeist').checked = snap.creditHeist;
        if (snap.adSeconds !== undefined) q('adSeconds').value = snap.adSeconds;
        if (snap.adsConsumeTime !== undefined) q('adsConsumeTime').checked = snap.adsConsumeTime;
        if (Array.isArray(snap.maps)) {
          mapBody.innerHTML = '';
          snap.maps.forEach(function (m) { addMapRow(m); });
        }
        if (Array.isArray(snap.packs)) {
          packBody.innerHTML = '';
          snap.packs.forEach(function (p) { addPackRow(p); });
          refreshPackSelects();
        }
      }

      function dcRenderPresetOptions() {
        if (!dcPresetSelectEl) return;
        dcPresetSelectEl.innerHTML = '<option value="">(Ï†ÄÏû•Îêú ÌîÑÎ¶¨ÏÖã)</option>' +
          dcPresets.map(function (p, idx) {
            return '<option value="' + idx + '">' + (p.name || ('Preset ' + idx)) + '</option>';
          }).join('');
      }

      function dcRenderHistory() {
        if (!dcHistoryListEl) return;
        if (!dcHistory.length) {
          dcHistoryListEl.innerHTML = '<div class="history-empty" style="font-size:13px;color:var(--muted)">ÌûàÏä§ÌÜ†Î¶¨Í∞Ä ÏóÜÏäµÎãàÎã§.</div>';
          return;
        }
        dcHistoryListEl.innerHTML = dcHistory.map(function (item) {
          var date = new Date(item.ts).toLocaleString();
          return '<div class="history-item">' +
            '<div class="history-item-main" style="font-weight:600">' + item.main + '</div>' +
            '<div class="history-item-meta" style="font-size:11px;color:var(--muted)">' + date + '</div>' +
            '</div>';
        }).join('');
      }

      dcRenderPresetOptions();
      dcRenderHistory();

      if (dcPresetSaveBtn) {
        dcPresetSaveBtn.addEventListener('click', function () {
          var name = (dcPresetNameEl.value || '').trim();
          if (!name) return alert(I18N.t('common.preset_name_req'));
          var snap = dcCollectInputSnapshot();
          dcPresets.push({ name: name, data: snap });
          dcSave(DC_PRESETS_KEY, dcPresets);
          dcRenderPresetOptions();
          alert(I18N.t('common.preset_saved'));
        });
      }
      if (dcPresetLoadBtn) {
        dcPresetLoadBtn.addEventListener('click', function () {
          var idx = parseInt(dcPresetSelectEl.value);
          if (isNaN(idx)) return;
          dcApplySnapshot(dcPresets[idx].data);
        });
      }
      if (dcPresetDeleteBtn) {
        dcPresetDeleteBtn.addEventListener('click', function () {
          var idx = parseInt(dcPresetSelectEl.value);
          if (isNaN(idx)) return;
          if (!confirm('Delete?')) return;
          dcPresets.splice(idx, 1);
          dcSave(DC_PRESETS_KEY, dcPresets);
          dcRenderPresetOptions();
        });
      }

      // History Hook
      calc.addEventListener('click', function () {
        setTimeout(function () {
          var val = q('totalDaily').textContent;
          if (val === '0') return;
          dcHistory.unshift({ ts: new Date().toISOString(), main: val });
          if (dcHistory.length > 30) dcHistory.pop();
          dcSave(DC_HISTORY_KEY, dcHistory);
          dcRenderHistory();
        }, 500);
      });

    })();
  </script>
</body>

</html>