<!doctype html>
<html lang="ko">
<head>
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ê²Œì‹œê¸€ ë³´ê¸° â€” AsphaltCalc ê²Œì‹œíŒ</title>
  <meta name="color-scheme" content="light dark" />
  <link rel="icon" href="../assets/favicon.png">
  <link rel="stylesheet" href="../assets/themes.css">
  <link rel="stylesheet" href="../assets/theme-adapter.css">
  <style>
    *{box-sizing:border-box;}
    body{
      margin:0;
      font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Apple SD Gothic Neo,Roboto,Noto Sans KR,Arial;
      background:var(--bg);
      color:var(--ink);
    }
    .wrap{
      max-width:800px;
      margin:24px auto 40px;
      padding:0 16px;
    }
    .top-row{
      display:flex;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
      margin-bottom:10px;
    }
    h1{
      margin:0;
      font-size:22px;
      font-weight:800;
    }
    .meta{
      font-size:12px;
      color:var(--muted);
      margin-top:4px;
    }
    .card{
      border-radius:18px;
      padding:16px 18px;
      background:var(--panel);
      box-shadow:0 18px 45px rgba(0,0,0,.7);
      margin-bottom:14px;
    }
    .btn-row{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      margin-top:10px;
    }
    .btn{
      padding:6px 11px;
      border-radius:999px;
      border:1px solid var(--border);
      background:var(--chip-bg);
      color:var(--ink);
      font-size:13px;
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      gap:6px;
    }
    .btn.primary{
      border-color:var(--accent);
      background:linear-gradient(135deg,var(--accent),var(--accent2));
      color:#fff;
    }
    .btn.danger{
      border-color:var(--danger);
      color:#fecaca;
    }
    .btn:disabled{
      opacity:.6;
      cursor:default;
    }
    .content{
      font-size:14px;
      line-height:1.7;
      white-space:pre-wrap;
    }
    .msg{
      font-size:13px;
      margin-top:8px;
      min-height:18px;
      color:var(--danger);
    }
    a{
      color:var(--accent);
      text-decoration:none;
    }
    a:hover{
      text-decoration:underline;
    }
    .comment-wrap{
      margin-top:18px;
    }
    .comment-title{
      font-size:15px;
      font-weight:700;
      margin-bottom:6px;
    }
    .comment-list{
      display:flex;
      flex-direction:column;
      gap:6px;
      margin-top:4px;
      max-height:260px;
      overflow:auto;
    }
    .comment{
      border-radius:10px;
      padding:8px 9px;
      border:1px solid var(--border);
      background:var(--panelSoft);
      font-size:13px;
    }
    .comment-meta{
      font-size:11px;
      color:var(--muted);
      margin-bottom:3px;
    }
    .comment-body{
      white-space:pre-wrap;
    }
    .comment-form textarea{
      width:100%;
      min-height:80px;
      padding:8px 9px;
      border-radius:9px;
      border:1px solid var(--control-border);
      background:var(--control-bg);
      color:var(--ink);
      font-size:13px;
      resize:vertical;
    }
    .comment-form textarea:focus{
      outline:none;
      border-color:var(--accent);
      box-shadow:0 0 0 1px var(--accent);
    }
    .comment-form .btn-row{
      justify-content:flex-end;
      margin-top:6px;
    }
    .badge{
      display:inline-flex;
      align-items:center;
      gap:4px;
      padding:2px 7px;
      border-radius:999px;
      font-size:11px;
      border:1px solid var(--border);
      background:var(--chip-bg);
      color:var(--muted);
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="top-row">
      <div>
        <h1 id="title">(ì œëª©)</h1>
        <div id="meta" class="meta">ì‘ì„±ì / ì‘ì„± ì‹œê°„</div>
      </div>
      <div style="text-align:right;">
        <div id="userInfo" class="meta">ë¡œê·¸ì¸ ìƒíƒœ í™•ì¸ ì¤‘â€¦</div>
        <div style="margin-top:4px;">
          <a href="./index.html">â† ëª©ë¡ìœ¼ë¡œ ëŒì•„ê°€ê¸°</a>
        </div>
      </div>
    </div>

    <div class="card">
      <div id="badgeRow" style="margin-bottom:8px;"></div>
      <div id="content" class="content">ë‚´ìš©ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦</div>
      <div id="msg" class="msg"></div>

      <div class="btn-row" id="postButtons" style="display:none;">
        <button id="editBtn" class="btn primary" type="button">âœï¸ ìˆ˜ì •</button>
        <button id="deleteBtn" class="btn danger" type="button">ğŸ—‘ ì‚­ì œ</button>
      </div>
    </div>

    <div class="card comment-wrap">
      <div class="comment-title">ëŒ“ê¸€</div>
      <div id="commentGuard" class="meta" style="margin-bottom:6px;"></div>

      <div class="comment-form" id="commentForm" style="display:none;">
        <textarea id="commentInput" placeholder="ëŒ“ê¸€ì„ ì…ë ¥í•˜ì„¸ìš” (ìµœëŒ€ 1000ì)"></textarea>
        <div class="btn-row">
          <button id="commentBtn" class="btn primary" type="button">ëŒ“ê¸€ ì‘ì„±</button>
        </div>
      </div>

      <div id="commentMsg" class="msg"></div>

      <div id="commentList" class="comment-list">
        <div class="meta">ëŒ“ê¸€ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦</div>
      </div>
    </div>
  </div>

<script>
(function(){
  var GKEY = 'simhub_theme_global';
  function resolveSystem(theme){
    if (theme === 'system') {
      var mq = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)');
      return (mq && mq.matches) ? 'dark' : 'light';
    }
    return theme || 'asphalt';
  }
  function currentTheme(){
    var attr = document.documentElement.getAttribute('data-theme');
    if (attr) return attr;
    var g = localStorage.getItem(GKEY);
    return g || 'asphalt';
  }
  function applyTheme(t){
    document.documentElement.setAttribute('data-theme', resolveSystem(t));
  }
  try {
    applyTheme(currentTheme());
  } catch(e) {
    console.warn(e);
  }
})();
</script>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-app.js";
    import {
      getAuth,
      onAuthStateChanged
    } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-auth.js";
    import {
      getFirestore,
      doc,
      getDoc,
      deleteDoc,
      collection,
      addDoc,
      getDocs,
      query,
      orderBy,
      serverTimestamp,
      updateDoc
    } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyCKIndVVlblrQfZGjaGpLBSxlWicLZiqPc",
  authDomain: "asphaltcalc-5d7f3.firebaseapp.com",
  projectId: "asphaltcalc-5d7f3",
  storageBucket: "asphaltcalc-5d7f3.firebasestorage.app",
  messagingSenderId: "388017703504",
  appId: "1:388017703504:web:117317163e1ec45a1d5f55"
};


    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db   = getFirestore(app);

    const params = new URLSearchParams(location.search);
    const postId = params.get("id");

    const titleEl   = document.getElementById("title");
    const metaEl    = document.getElementById("meta");
    const contentEl = document.getElementById("content");
    const msgEl     = document.getElementById("msg");
    const userInfo  = document.getElementById("userInfo");
    const badgeRow  = document.getElementById("badgeRow");

    const postButtons = document.getElementById("postButtons");
    const editBtn     = document.getElementById("editBtn");
    const deleteBtn   = document.getElementById("deleteBtn");

    const commentGuard  = document.getElementById("commentGuard");
    const commentForm   = document.getElementById("commentForm");
    const commentInput  = document.getElementById("commentInput");
    const commentBtn    = document.getElementById("commentBtn");
    const commentListEl = document.getElementById("commentList");
    const commentMsg    = document.getElementById("commentMsg");

    let currentUser = null;
    let currentPost = null;
    let editingCommentId = null;

    function formatDate(ts) {
      if (!ts) return "";
      try {
        if (typeof ts.toDate === "function") {
          ts = ts.toDate();
        }
        return ts.toLocaleString("ko-KR", {
          month: "2-digit",
          day: "2-digit",
          hour: "2-digit",
          minute: "2-digit"
        });
      } catch (e) {
        console.warn(e);
        return "";
      }
    }

    function renderBadges() {
      badgeRow.innerHTML = "";
      if (!currentPost) return;

      function makeBadge(text) {
        const span = document.createElement("span");
        span.className = "badge";
        span.textContent = text;
        return span;
      }

      if (currentPost.createdAt) {
        badgeRow.appendChild(makeBadge("ì‘ì„±: " + formatDate(currentPost.createdAt)));
      }
      if (currentPost.updatedAt) {
        badgeRow.appendChild(makeBadge("ìˆ˜ì •: " + formatDate(currentPost.updatedAt)));
      }
      if (currentPost.authorName) {
        badgeRow.appendChild(makeBadge("ì‘ì„±ì: " + currentPost.authorName));
      }
    }

    async function loadPost() {
      if (!postId) {
        msgEl.textContent = "ê²Œì‹œê¸€ IDê°€ ì§€ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.";
        contentEl.textContent = "";
        return;
      }
      msgEl.textContent = "";
      try {
        const ref = doc(db, "posts", postId);
        const snap = await getDoc(ref);
        if (!snap.exists()) {
          titleEl.textContent = "(ì‚­ì œëœ ê²Œì‹œê¸€)";
          contentEl.textContent = "í•´ë‹¹ ê²Œì‹œê¸€ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.";
          metaEl.textContent = "";
          return;
        }
        const d = snap.data();
        currentPost = d;
        currentPost.id = snap.id;

        const title = d.title || "(ì œëª© ì—†ìŒ)";
        const content = d.content || "";
        let author = d.authorName || (d.authorEmail ? d.authorEmail.split("@")[0] : "ì•Œ ìˆ˜ ì—†ìŒ");
        if (currentUser && currentUser.email && d.authorEmail && d.authorEmail === currentUser.email) {
          const nick = currentUser.displayName || currentUser.email.split("@")[0];
          author = nick;
        }

        titleEl.textContent = title;
        if (window.marked) {
  // ë³´ì•ˆ í•„í„°: HTML íƒœê·¸ ì œê±° â†’ XSS ë°©ì§€
        const safe = content.replace(/</g, "&lt;").replace(/>/g, "&gt;");
        contentEl.innerHTML = marked.parse(safe);
      } else {
        contentEl.textContent = content;
}

        const timeText = d.createdAt ? formatDate(d.createdAt) : "";
        metaEl.textContent = author + (timeText ? " Â· " + timeText : "");

        renderBadges();
        updateEditButtons();
      } catch (e) {
        console.error(e);
        msgEl.textContent = "ê²Œì‹œê¸€ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.";
      }
    }

    function updateEditButtons() {
      if (!currentUser || !currentPost) {
        postButtons.style.display = "none";
        return;
      }
      if (currentUser.uid === currentPost.authorUid) {
        postButtons.style.display = "";
      } else {
        postButtons.style.display = "none";
      }
    }

    async function loadComments() {
      if (!postId) return;
      commentListEl.innerHTML = '<div class="meta">ëŒ“ê¸€ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦</div>';
      try {
        const qRef = query(
          collection(db, "posts", postId, "comments"),
          orderBy("createdAt", "asc")
        );
        const snap = await getDocs(qRef);
        const list = [];
        snap.forEach(function(docSnap) {
          const d = docSnap.data();
          list.push({
            id: docSnap.id,
            author: d.authorName || (d.authorEmail ? d.authorEmail.split("@")[0] : "ì•Œ ìˆ˜ ì—†ìŒ"),
            text: d.text || "",
            createdAt: d.createdAt,
            updatedAt: d.updatedAt,
            authorUid: d.authorUid,
            authorEmail: d.authorEmail
          });
        });

        commentListEl.innerHTML = "";
        if (list.length === 0) {
          const div = document.createElement("div");
          div.className = "meta";
          div.textContent = "ì•„ì§ ëŒ“ê¸€ì´ ì—†ìŠµë‹ˆë‹¤.";
          commentListEl.appendChild(div);
          return;
        }

        list.forEach(function(c) {
          const item = document.createElement("div");
          item.className = "comment";
          item.dataset.id = c.id;
          if (c.authorUid) item.dataset.authorUid = c.authorUid;
          if (c.authorEmail) item.dataset.authorEmail = c.authorEmail || "";

          const meta = document.createElement("div");
          meta.className = "comment-meta";
          const timeText = c.createdAt ? formatDate(c.createdAt) : "";

          let displayAuthor = c.author;
          if (currentUser && c.authorEmail && currentUser.email && currentUser.email === c.authorEmail) {
            const nick = currentUser.displayName || currentUser.email.split("@")[0];
            displayAuthor = nick;
          }

          let metaText = displayAuthor;
          if (timeText) metaText += " Â· " + timeText;
          if (c.updatedAt) metaText += " Â· ìˆ˜ì •ë¨";
          meta.textContent = metaText;

          const body = document.createElement("div");
          body.className = "comment-body";

          const textDiv = document.createElement("div");
          textDiv.className = "comment-text";
          textDiv.textContent = c.text;
          body.appendChild(textDiv);

          let isOwner = false;
          if (currentUser) {
            if (c.authorUid && currentUser.uid === c.authorUid) {
              isOwner = true;
            } else if (c.authorEmail && currentUser.email && currentUser.email === c.authorEmail) {
              isOwner = true;
            }
          }

          if (isOwner) {
            const actions = document.createElement("div");
            actions.className = "comment-actions";
            const editBtn = document.createElement("button");
            editBtn.type = "button";
            editBtn.className = "comment-action comment-edit-btn";
            editBtn.textContent = "âœ ìˆ˜ì •";
            const delBtn = document.createElement("button");
            delBtn.type = "button";
            delBtn.className = "comment-action comment-delete-btn";
            delBtn.textContent = "ğŸ—‘ ì‚­ì œ";
            actions.appendChild(editBtn);
            actions.appendChild(delBtn);
            body.appendChild(actions);
          }

          item.appendChild(meta);
          item.appendChild(body);
          commentListEl.appendChild(item);
        });
      } catch (e) {
        console.error(e);
        commentListEl.innerHTML = '<div class="meta">ëŒ“ê¸€ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</div>';
      }
    }

    onAuthStateChanged(auth, function(user) {
      currentUser = user;
      if (!user) {
        userInfo.textContent = "ë¡œê·¸ì•„ì›ƒ ìƒíƒœ (ì½ê¸° ì „ìš©)";
        commentGuard.textContent = "ëŒ“ê¸€ ì‘ì„±ì€ ë¡œê·¸ì¸ + ì´ë©”ì¼ ì¸ì¦ì´ í•„ìš”í•©ë‹ˆë‹¤.";
        commentForm.style.display = "none";
        updateEditButtons();
        return;
      }
      const name = user.displayName || (user.email ? user.email.split("@")[0] : "ì‚¬ìš©ì");
      userInfo.textContent = "ë¡œê·¸ì¸: " + name + " (" + user.email + ")";

      if (!user.emailVerified) {
        commentGuard.textContent = "ì´ë©”ì¼ ì¸ì¦ì´ ì™„ë£Œë˜ì§€ ì•Šì•„ ëŒ“ê¸€ì„ ì‘ì„±í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.";
        commentForm.style.display = "none";
      } else {
        commentGuard.textContent = "ëŒ“ê¸€ ë‚´ìš©ì€ ëˆ„êµ¬ë‚˜ ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤. ê·œì¹™ì„ ì§€ì¼œì£¼ì„¸ìš”.";
        commentForm.style.display = "";
      }
      updateEditButtons();
    });

    editBtn.addEventListener("click", function() {
      if (!postId) return;
      location.href = "./write.html?id=" + encodeURIComponent(postId);
    });

    deleteBtn.addEventListener("click", async function() {
      if (!postId || !currentUser || !currentPost) return;
      if (currentUser.uid !== currentPost.authorUid) {
        alert("ìì‹ ì´ ì‘ì„±í•œ ê¸€ë§Œ ì‚­ì œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.");
        return;
      }
      if (!window.confirm("ì´ ê²Œì‹œê¸€ì„ ì •ë§ ì‚­ì œí• ê¹Œìš”? ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")) return;
      try {
        deleteBtn.disabled = true;
        await deleteDoc(doc(db, "posts", postId));
        alert("ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
        location.href = "./index.html";
      } catch (e) {
        console.error(e);
        alert("ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
      } finally {
        deleteBtn.disabled = false;
      }
    });

    commentBtn.addEventListener("click", async function() {
      commentMsg.textContent = "";
      commentMsg.style.color = "var(--danger)";
      if (!currentUser) {
        commentMsg.textContent = "ë¨¼ì € ë¡œê·¸ì¸í•˜ì„¸ìš”.";
        return;
      }
      if (!currentUser.emailVerified) {
        commentMsg.textContent = "ì´ë©”ì¼ ì¸ì¦ì´ í•„ìš”í•©ë‹ˆë‹¤.";
        return;
      }
      const text = (commentInput.value || "").trim();
      if (!text) {
        commentMsg.textContent = "ëŒ“ê¸€ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”.";
        return;
      }
      if (text.length > 1000) {
        commentMsg.textContent = "ëŒ“ê¸€ì€ ìµœëŒ€ 1000ìê¹Œì§€ ì‘ì„±í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.";
        return;
      }
      try {
        commentBtn.disabled = true;
        const displayName = currentUser.displayName || (currentUser.email ? currentUser.email.split("@")[0] : "ì‚¬ìš©ì");
        await addDoc(collection(db, "posts", postId, "comments"), {
          text: text,
          authorUid: currentUser.uid,
          authorEmail: currentUser.email,
          authorName: displayName,
          createdAt: serverTimestamp()
        });
        commentInput.value = "";
        commentMsg.style.color = "var(--success)";
        commentMsg.textContent = "ëŒ“ê¸€ì´ ì‘ì„±ë˜ì—ˆìŠµë‹ˆë‹¤.";
        loadComments();
      } catch (e) {
        console.error(e);
        if (e && e.code === "permission-denied") {
          commentMsg.textContent = "ëŒ“ê¸€ ì‘ì„± ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤. ê´€ë¦¬ìê°€ í—ˆìš©í•´ì•¼ í•©ë‹ˆë‹¤.";
        } else {
          commentMsg.textContent = "ëŒ“ê¸€ ì‘ì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.";
        }
      } finally {
        commentBtn.disabled = false;
      }
    });

    commentListEl.addEventListener("click", async function(e) {
      const target = e.target;
      const item = target.closest(".comment");
      if (!item) return;
      const commentId = item.dataset.id;
      if (!commentId) return;

      // ì‚­ì œ
      if (target.classList.contains("comment-delete-btn")) {
        if (!currentUser) return;
        if (!confirm("ì´ ëŒ“ê¸€ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
        try {
          await deleteDoc(doc(db, "posts", postId, "comments", commentId));
          loadComments();
        } catch (err) {
          console.error(err);
          alert("ëŒ“ê¸€ ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
        }
        return;
      }

      // ìˆ˜ì • ì‹œì‘
      if (target.classList.contains("comment-edit-btn")) {
        if (!currentUser) return;

        // ì´ë¯¸ ë‹¤ë¥¸ ëŒ“ê¸€ ìˆ˜ì • ì¤‘ì´ë©´ ìƒˆë¡œê³ ì¹¨ í›„ ë‹¤ì‹œ ì‹œì‘
        if (editingCommentId && editingCommentId !== commentId) {
          await loadComments();
        }
        editingCommentId = commentId;

        const body = item.querySelector(".comment-body");
        if (!body) return;
        const textDiv = body.querySelector(".comment-text");
        const original = textDiv ? textDiv.textContent : "";
        body.innerHTML = "";

        const textarea = document.createElement("textarea");
        textarea.className = "comment-edit-input";
        textarea.value = original;
        textarea.style.width = "100%";
        textarea.style.minHeight = "60px";
        textarea.maxLength = 1000;

        const actions = document.createElement("div");
        actions.className = "comment-actions";

        const saveBtn = document.createElement("button");
        saveBtn.type = "button";
        saveBtn.className = "comment-action comment-save-btn";
        saveBtn.textContent = "ì €ì¥";

        const cancelBtn = document.createElement("button");
        cancelBtn.type = "button";
        cancelBtn.className = "comment-action comment-cancel-btn";
        cancelBtn.textContent = "ì·¨ì†Œ";

        actions.appendChild(saveBtn);
        actions.appendChild(cancelBtn);

        body.appendChild(textarea);
        body.appendChild(actions);
        textarea.focus();
        return;
      }

      // ìˆ˜ì • ì €ì¥ / ì·¨ì†Œ
      if (target.classList.contains("comment-save-btn") || target.classList.contains("comment-cancel-btn")) {
        if (!editingCommentId) return;
        if (target.classList.contains("comment-cancel-btn")) {
          editingCommentId = null;
          loadComments();
          return;
        }
        // ì €ì¥
        const body = item.querySelector(".comment-body");
        const textarea = body ? body.querySelector(".comment-edit-input") : null;
        if (!textarea) return;
        const newText = (textarea.value || "").trim();
        if (!newText) {
          alert("ëŒ“ê¸€ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”.");
          return;
        }
        if (newText.length > 1000) {
          alert("ëŒ“ê¸€ì€ ìµœëŒ€ 1000ìê¹Œì§€ ì‘ì„±í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.");
          return;
        }
        try {
          await updateDoc(doc(db, "posts", postId, "comments", commentId), {
            text: newText,
            updatedAt: serverTimestamp()
          });
          editingCommentId = null;
          loadComments();
        } catch (err) {
          console.error(err);
          alert("ëŒ“ê¸€ ìˆ˜ì • ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
        }
      }
    });


    loadPost();
    loadComments();
  </script>
</body>
</html>
